<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DaGuang</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-11-06T15:20:59.696Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>DaGuang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Linux脚本开机自启动</title>
    <link href="http://example.com/2022/11/06/Linux/Linux%E8%84%9A%E6%9C%AC%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/"/>
    <id>http://example.com/2022/11/06/Linux/Linux%E8%84%9A%E6%9C%AC%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/</id>
    <published>2022-11-06T14:51:50.000Z</published>
    <updated>2022-11-06T15:20:59.696Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg" alt="linux.jpg">  </p><span id="more"></span><h1 id="Linux脚本开机启动"><a href="#Linux脚本开机启动" class="headerlink" title="Linux脚本开机启动"></a>Linux脚本开机启动</h1><p>Linux系统文件执行顺序</p><h2 id="方式一-etc-profile-d"><a href="#方式一-etc-profile-d" class="headerlink" title="方式一 /etc/profile.d"></a>方式一 /etc/profile.d</h2><p>将需要自启动的脚本放在 <strong>/etc/profile.d/</strong> 目录下，将脚本添加执行权限。<br><strong>需要注意的是，该方式的脚本必须为 .sh结尾，且每次远程连接服务器时都会启动一次该脚本</strong>。  </p><h2 id="方式二-etc-rc-local"><a href="#方式二-etc-rc-local" class="headerlink" title="方式二 /etc/rc.local"></a>方式二 /etc/rc.local</h2><p>在/etc/rc.local文件中加入需要执行的脚本启动命令，且将 <strong>/etc/rc.d/rc.local</strong> 添加执行权限。使用该方式只会在开机时执行脚本  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> more /etc/rc.local</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this script will NOT be run after all other services.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/local</span><br><span class="line">sh /usr/local/prometheus/start.sh  #添加的执行脚本</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg&quot; alt=&quot;linux.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>5-PromQL</title>
    <link href="http://example.com/2022/10/31/prometheus/5-PromQL/"/>
    <id>http://example.com/2022/10/31/prometheus/5-PromQL/</id>
    <published>2022-10-31T13:14:13.000Z</published>
    <updated>2022-11-06T17:34:53.253Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="PromQL"><a href="#PromQL" class="headerlink" title="PromQL"></a>PromQL</h1><p>从之前中<a href="/2022/10/22/prometheus/3-Prometheus%E6%95%B0%E6%8D%AE/" title="3-Prometheus数据">3-Prometheus数据</a>学习了Prometheus的四种数据类型。<br>PromQL中使用 <strong>#</strong> 进行注释  </p><h2 id="基础内容"><a href="#基础内容" class="headerlink" title="基础内容"></a>基础内容</h2><p><strong>瞬时向量（Instant vector）</strong>： 一组时间序列，每个时间序列包含一个样本，都共享相同的时间戳<br><strong>范围向量（Range vector）</strong>： 一组时间序列，其中包含每个时间序列随时间变化的数据点范围，即 node_cpu_seconds_total[5m]此类查询 ，在 Prometheus页面查询无法使用此类查询展现图表，必须是<strong>即时向量</strong>或者<strong>标量</strong>。<br><strong>标量（Scalar ）</strong>： 一个简单的数字浮点值  </p><h3 id="标签选择器"><a href="#标签选择器" class="headerlink" title="标签选择器"></a>标签选择器</h3><p><code>node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;</code>，其中<code>mode</code>为node_cpu_seconds_total指标的一个标签，可以通过标签选择器进行过滤。<br><strong>=</strong> ：与字符串匹配<br><strong>!=</strong> ：与字符串不匹配<br><strong>=~</strong> ：与正则匹配，匹配为全锚定。<code>=~&quot;foo&quot;</code>相当于<code>=~&quot;^foo$&quot;</code>.<br><strong>!~</strong> ：与正则不匹配  </p><h3 id="时间范围选择器"><a href="#时间范围选择器" class="headerlink" title="时间范围选择器"></a>时间范围选择器</h3><p>时间范围有以下单位：<br><strong>ms</strong>- 毫秒<br><strong>s</strong>- 秒<br><strong>m</strong>- 分钟<br><strong>h</strong>- 小时<br><strong>d</strong>- 天<br><strong>w</strong>- 周<br><strong>y</strong>- 年<br>使用方式<code>node_cpu_seconds_total[5m]</code></p><h3 id="偏移修饰符"><a href="#偏移修饰符" class="headerlink" title="偏移修饰符"></a>偏移修饰符</h3><p>更改查询<strong>即时向量</strong>或<strong>范围向量</strong>的时间偏移量<br><code>node_cpu_seconds_total offset 5m</code> ：表示5分钟前的值<br><code>node_cpu_guest_seconds_total[5m] offset 1d</code>表示一天前5分钟的值  </p><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="@修饰符"></a>@修饰符</h3><p>通过@ 直接跳转到某个uinx时间戳，<br><code>node_cpu_guest_seconds_total @ 1667137698</code>:查询指标时间戳为1667137698，即时间为2022-10-30 21:48:18的值<br><code>node_cpu_guest_seconds_total[5m] @ 1667137698</code>:查询2022-10-30 21:48:18前5分钟的值  </p><h2 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h2><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p><strong>+</strong> （加法）<br><strong>-</strong> （减法）<br><strong>*</strong> （乘法）<br><strong>/</strong> （除法）<br><strong>%</strong> （取模）<br><strong>^</strong> （幂）<br>使用运算符的结果与原指标的意义不再一样，输出的结果没有指标名称，只包含标签、值。<br>实际运算中不同的指标的标签名以及标签数量不一致，运算时有以下运算原则。  </p><ol><li>运算时按照标签相同的值进行运算，例如： node_cpu_seconds_total + node_cpu_seconds_total ，标签全部相同的值相加  </li><li>两个瞬时向量的数量不同，结果数量与数量少的一致，node_cpu_guest_seconds_total + node_cpu_seconds_total，结果为 mode=”nice”、mode=”user”的两个向量相加  </li></ol><h3 id="逻辑比较"><a href="#逻辑比较" class="headerlink" title="逻辑比较"></a>逻辑比较</h3><p>== ：相等判断，相等为1(true)，不相等为0(false)<br>!= ：判断是否不相等，输出结果类似==<br>&gt;= ：输出结果类似==<br>&lt;= ：输出结果类似==<br>&gt; ：输出结果类似==<br>&lt; ：输出结果类似==  </p><h3 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h3><p><strong>and</strong> ：对多个指标的数据集进行标签判断，获取两个指标集具有共同的标签的值 <strong>（优先展示or左边的指标）</strong><br><strong>or</strong> ：对多个指标集数据进行展示，如果有标签重复，则仅显示其中一个标签的值 <strong>（优先展示or左边的指标）</strong><br><strong>unless</strong> :对多个指标的数据集进行标签判断，获取两个指标集不具有共同的标签的值 <strong>（优先展示or左边的指标）</strong>  </p><h3 id="向量匹配"><a href="#向量匹配" class="headerlink" title="向量匹配"></a>向量匹配</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">test1&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  24</span><br><span class="line">test1&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  30</span><br><span class="line">test1&#123;method=&quot;put&quot;, code=&quot;501&quot;&#125;  3</span><br><span class="line">test1&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 6</span><br><span class="line">test1&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 21</span><br><span class="line"></span><br><span class="line">test2&#123;method=&quot;get&quot;&#125;  600</span><br><span class="line">test2&#123;method=&quot;del&quot;&#125;  34</span><br><span class="line">test2&#123;method=&quot;post&quot;&#125; 120</span><br></pre></td></tr></table></figure><p>两个指标test1与test2的标签以及数量不一致们可以使用ignoring忽略不共有的标签。   </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test1&#123; code=&quot;500&quot;&#125; / ignoring(code) test2   # </span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123; code=<span class="string">&quot;500&quot;</span>&#125; 可以过滤出以下两条</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123;method=<span class="string">&quot;get&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125;  24</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123;method=<span class="string">&quot;post&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125; 6</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后 ignoring(code) 将过滤出的两条的code标签忽略，进行运算</span></span><br><span class="line">&#123;method=&quot;get&quot;&#125;  0.04            #  24 / 600</span><br><span class="line">&#123;method=&quot;post&quot;&#125; 0.05            #   6 / 120</span><br></pre></td></tr></table></figure><p>在以上的例子中<code>test1&#123; code=&quot;500&quot;&#125; / ignoring(code) test2</code>等同于<code>test1&#123; code=&quot;500&quot;&#125; / on(method) test2</code>,on 与 ignoring相反，意思为只考虑提供的列表中的标签。ignoring与on 结果的数目都与左边的指标数量相同，可以使用group_right以右边数量为准  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test1/ ignoring(code) group_left test2</span><br><span class="line"></span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><p>聚合函数可以与 <strong>without</strong>、<strong>by</strong> 一起使用<br>without：表示计算结果中移除列举的标签<br>by：表示计算结果中只保留列出的标签<br>通过without和by可以按照样本的问题对数据进⾏聚合  </p><h3 id="sum"><a href="#sum" class="headerlink" title="sum()"></a>sum()</h3><p>求和函数，可以使用without、by根据标签进行聚合  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sum by(handler) (prometheus_http_requests_total)</span><br><span class="line"></span><br><span class="line">&#123;handler=&quot;/-/ready&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/label/:name/values&quot;&#125;4</span><br><span class="line">&#123;handler=&quot;/api/v1/labels&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/metadata&quot;&#125;27</span><br><span class="line">&#123;handler=&quot;/api/v1/query&quot;&#125;123</span><br><span class="line">&#123;handler=&quot;/api/v1/query_range&quot;&#125;8</span><br><span class="line">&#123;handler=&quot;/api/v1/rules&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/api/v1/series&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/status/config&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/api/v1/targets&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/favicon.ico&quot;&#125;2</span><br><span class="line">&#123;handler=&quot;/graph&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/metrics&quot;&#125;403</span><br><span class="line">&#123;handler=&quot;/static/*filepath&quot;&#125;11</span><br><span class="line">&#123;handler=&quot;/&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="avg"><a href="#avg" class="headerlink" title="avg()"></a>avg()</h3><p>所有值的平均值  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">avg(prometheus_http_requests_total)</span><br><span class="line">&#123;&#125;  43.06249999999999</span><br></pre></td></tr></table></figure><h3 id="count"><a href="#count" class="headerlink" title="count()"></a>count()</h3><p>返回分组中的时间序列数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">count(prometheus_http_requests_total)</span><br><span class="line">&#123;&#125;  16</span><br><span class="line"></span><br><span class="line">count by (code) (prometheus_http_requests_total)</span><br><span class="line">&#123;code=&quot;200&quot;&#125;14</span><br><span class="line">&#123;code=&quot;302&quot;&#125;1</span><br><span class="line">&#123;code=&quot;400&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="count-values"><a href="#count-values" class="headerlink" title="count_values()"></a>count_values()</h3><p>计算具有相同值的元素个数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">count_values (&quot;handler&quot;,prometheus_http_requests_total)</span><br><span class="line">&#123;handler=&quot;3&quot;&#125;2   #这表示值为3的有2条</span><br><span class="line">&#123;handler=&quot;4&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;8&quot;&#125;2</span><br><span class="line">&#123;handler=&quot;47&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;153&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;1&quot;&#125;4</span><br><span class="line">&#123;handler=&quot;5&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;2&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;553&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;11&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;14&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="min-、max"><a href="#min-、max" class="headerlink" title="min()、max()"></a>min()、max()</h3><p>组内最小值、最大值  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">max by (instance,job)(prometheus_http_requests_total)</span><br><span class="line">&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;&#125;   575</span><br><span class="line"></span><br><span class="line">min by (instance,job)(prometheus_http_requests_total)</span><br><span class="line">&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;&#125;   1</span><br></pre></td></tr></table></figure><h3 id><a href="#" class="headerlink" title></a></h3>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="PromQL" scheme="http://example.com/tags/PromQL/"/>
    
  </entry>
  
  <entry>
    <title>4-Prometheus配置文件</title>
    <link href="http://example.com/2022/10/29/prometheus/4-Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <id>http://example.com/2022/10/29/prometheus/4-Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</id>
    <published>2022-10-29T03:38:40.000Z</published>
    <updated>2022-10-29T08:01:09.804Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="Prometheus配置文件"><a href="#Prometheus配置文件" class="headerlink" title="Prometheus配置文件"></a>Prometheus配置文件</h1><p>在前面章节Prometheus安装在/usr/local/prometheus中，Prometheus的配置文件为prometheus.yml。<br>Prometheus启动是可以使用参数 -config.file 指定配置文件。  </p><h2 id="配置文件主体"><a href="#配置文件主体" class="headerlink" title="配置文件主体"></a>配置文件主体</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此片段指定的是prometheus的全局配置， 比如采集间隔，抓取超时时间等.</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># 抓取时间间隔，</span></span><br><span class="line">  [ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 抓取超时时间</span></span><br><span class="line">  [ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 执行判断 rules 的时间间隔</span></span><br><span class="line">  [ <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 外部一些标签设置</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    [ <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 记录 PromQL 查询的文件。</span></span><br><span class="line">  <span class="comment"># 重新加载配置将重新打开文件。</span></span><br><span class="line">  [ <span class="attr">query_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定报警规则文件， prometheus根据这些规则信息，会推送报警信息到alertmanager中。</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定抓取配置，prometheus的数据采集通过此片段配置。</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定报警配置， 这里主要是指定prometheus将报警规则推送到指定的alertmanager实例地址。</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定后端的存储的写入api地址。</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定后端的存储的读取api地址。</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> ]</span><br></pre></td></tr></table></figure><h2 id="scrape-configs-配置"><a href="#scrape-configs-配置" class="headerlink" title="scrape_configs 配置"></a>scrape_configs 配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 抓取指标的作业名称</span></span><br><span class="line">  <span class="attr">job_name:</span> <span class="string">&lt;job_name&gt;</span></span><br><span class="line">  <span class="comment"># 抓取间隔,默认继承global值。</span></span><br><span class="line">[ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_interval&gt;</span> ]</span><br><span class="line">  <span class="comment"># 抓取超时时间,默认继承global值。</span></span><br><span class="line">[ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_timeout&gt;</span> ]</span><br><span class="line">  <span class="comment"># 抓取路径， 默认是/metrics</span></span><br><span class="line">[ <span class="attr">metrics_path:</span> <span class="string">&lt;path&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">/metrics</span> ]</span><br><span class="line">  <span class="comment"># 指定采集使用的协议，http或者https。</span></span><br><span class="line">[ <span class="attr">scheme:</span> <span class="string">&lt;scheme&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">http</span> ]</span><br><span class="line">  <span class="comment"># 指定url参数。</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    [ <span class="string">&lt;string&gt;:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] ]</span><br><span class="line">  <span class="comment"># 指定认证信息。</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">  [ <span class="attr">username:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line">  [ <span class="attr">password:</span> <span class="string">&lt;secret&gt;</span> ]</span><br><span class="line">  [ <span class="attr">password_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line">  <span class="comment"># 指定token的数值， 用户get metrics认证使用</span></span><br><span class="line">[ <span class="attr">bearer_token:</span> <span class="string">&lt;secret&gt;</span> ]</span><br><span class="line">  <span class="comment"># 指定获取token的文件， 用户get metrics认证使用</span></span><br><span class="line">[ <span class="attr">bearer_token_file:</span> <span class="string">/path/to/bearer/token/file</span> ]</span><br><span class="line">  <span class="comment"># 指定获取metrics时需要的tls证书</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">  [ <span class="string">&lt;tls_config&gt;</span> ]</span><br><span class="line"><span class="comment"># 指定静态配置</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">  [   <span class="bullet">-</span> <span class="string">&#x27;&lt;host&gt;&#x27;</span> ]<span class="string">...</span> ]</span><br><span class="line"><span class="comment"># Consul服务发现配置列表，_sd_即为service discovery 服务发现</span></span><br><span class="line">  <span class="attr">consul_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;consul_sd_config&gt;</span> <span class="string">...</span> ]</span><br></pre></td></tr></table></figure><p><a href="https://github.com/prometheus/prometheus/blob/release-2.39/config/testdata/conf.good.yml">Prometheus官网示例配置文件</a>  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">codelab</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;first.rules&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;my/*.rules&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote1/push</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">drop_expensive</span></span><br><span class="line">    <span class="attr">write_relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__name__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">expensive.*</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client_id:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">      <span class="attr">client_secret:</span> <span class="string">&quot;456&quot;</span></span><br><span class="line">      <span class="attr">token_url:</span> <span class="string">&quot;http://remote1/auth&quot;</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">        <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote2/push</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rw_tls</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote1/read</span></span><br><span class="line">    <span class="attr">read_recent:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">enable_http2:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote3/read</span></span><br><span class="line">    <span class="attr">read_recent:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">read_special</span></span><br><span class="line">    <span class="attr">required_matchers:</span></span><br><span class="line">      <span class="attr">job:</span> <span class="string">special</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># scrape_interval is defined by the configured global (15s).</span></span><br><span class="line">    <span class="comment"># scrape_timeout is defined by the global default (10s).</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo/*.slow.json</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo/*.slow.yml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">single/file.yml</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">10m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">bar/*.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>, <span class="string">&quot;localhost:9191&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">my:</span> <span class="string">label</span></span><br><span class="line">          <span class="attr">your:</span> <span class="string">label</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">job</span>, <span class="string">__meta_dns_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.*)some-[regex]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">job</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">foo-$&#123;1&#125;</span></span><br><span class="line">        <span class="comment"># action defaults to &#x27;replace&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">abc</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">cde</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">static</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">abc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">static</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">abc</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials_file:</span> <span class="string">valid_token_file</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">min_version:</span> <span class="string">TLS10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-x</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">basic_auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">admin_name</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;multiline\nmysecret\ntest&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">50s</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">body_size_limit:</span> <span class="string">10MB</span></span><br><span class="line">    <span class="attr">sample_limit:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/my_path</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">dns_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">refresh_interval:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">names:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first.dns.address.domain.com</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">second.dns.address.domain.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first.dns.address.domain.com</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">job</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.*)some-[regex]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">modulus:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__tmp_hash</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">hashmod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__tmp_hash</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labeldrop</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelkeep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">k</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">metric_relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__name__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">expensive_metric.*</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-y</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&quot;localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">services:</span> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;cache&quot;</span>, <span class="string">&quot;mysql&quot;</span>]</span><br><span class="line">        <span class="attr">tags:</span> [<span class="string">&quot;canary&quot;</span>, <span class="string">&quot;v1&quot;</span>]</span><br><span class="line">        <span class="attr">node_meta:</span></span><br><span class="line">          <span class="attr">rack:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">        <span class="attr">allow_stale:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_sd_consul_tags</span>]</span><br><span class="line">        <span class="attr">separator:</span> <span class="string">&quot;,&quot;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">label:([^=]+)=([^,]+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-z</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials:</span> <span class="string">mysecret</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kubernetes</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">api_server:</span> <span class="string">&quot;https://localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">basic_auth:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">&quot;myusername&quot;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">&quot;mysecret&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kubernetes-namespaces</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">api_server:</span> <span class="string">&quot;https://localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">          <span class="attr">names:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">basic_auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">&quot;myusername&quot;</span></span><br><span class="line">      <span class="attr">password_file:</span> <span class="string">valid_password_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kuma</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kuma_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">http://kuma-control-plane.kuma-system.svc:5676</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-marathon</span></span><br><span class="line">    <span class="attr">marathon_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;https://marathon.example.com:443&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">auth_token:</span> <span class="string">&quot;mysecret&quot;</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-nomad</span></span><br><span class="line">    <span class="attr">nomad_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&#x27;http://localhost:4646&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-ec2</span></span><br><span class="line">    <span class="attr">ec2_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">access</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">profile</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tag:environment</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tag:service</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-lightsail</span></span><br><span class="line">    <span class="attr">lightsail_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">access</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">profile</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-azure</span></span><br><span class="line">    <span class="attr">azure_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">environment:</span> <span class="string">AzurePublicCloud</span></span><br><span class="line">        <span class="attr">authentication_method:</span> <span class="string">OAuth</span></span><br><span class="line">        <span class="attr">subscription_id:</span> <span class="string">11AAAA11-A11A-111A-A111-1111A1111A11</span></span><br><span class="line">        <span class="attr">resource_group:</span> <span class="string">my-resource-group</span></span><br><span class="line">        <span class="attr">tenant_id:</span> <span class="string">BBBB222B-B2B2-2B22-B222-2BB2222BB2B2</span></span><br><span class="line">        <span class="attr">client_id:</span> <span class="string">333333CC-3C33-3333-CCC3-33C3CCCCC33C</span></span><br><span class="line">        <span class="attr">client_secret:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-nerve</span></span><br><span class="line">    <span class="attr">nerve_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/monitoring</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">0123service-xxx</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">badfederation</span></span><br><span class="line">    <span class="attr">honor_timestamps:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/federate</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">測試</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">httpsd</span></span><br><span class="line">    <span class="attr">http_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://example.com/prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-triton</span></span><br><span class="line">    <span class="attr">triton_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">account:</span> <span class="string">&quot;testAccount&quot;</span></span><br><span class="line">        <span class="attr">dns_suffix:</span> <span class="string">&quot;triton.example.com&quot;</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">&quot;triton.example.com&quot;</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9163</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">digitalocean-droplets</span></span><br><span class="line">    <span class="attr">digitalocean_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">docker_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">dockerswarm</span></span><br><span class="line">    <span class="attr">dockerswarm_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">http://127.0.0.1:2375</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">nodes</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-openstack</span></span><br><span class="line">    <span class="attr">openstack_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">region:</span> <span class="string">RegionOne</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-puppetdb</span></span><br><span class="line">    <span class="attr">puppetdb_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">https://puppetserver/</span></span><br><span class="line">        <span class="attr">query:</span> <span class="string">&#x27;resources &#123; type = &quot;Package&quot; and title = &quot;httpd&quot; &#125;&#x27;</span></span><br><span class="line">        <span class="attr">include_parameters:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">hetzner</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">uppercase</span></span><br><span class="line">        <span class="attr">source_labels:</span> [<span class="string">instance</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="attr">hetzner_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">hcloud</span></span><br><span class="line">        <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">robot</span></span><br><span class="line">        <span class="attr">basic_auth:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">abcdef</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-eureka</span></span><br><span class="line">    <span class="attr">eureka_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&quot;http://eureka.example.com:8761/eureka&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">scaleway</span></span><br><span class="line">    <span class="attr">scaleway_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">project_id:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111112</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">baremetal</span></span><br><span class="line">        <span class="attr">project_id:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111112</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111111</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">linode-instances</span></span><br><span class="line">    <span class="attr">linode_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">uyuni</span></span><br><span class="line">    <span class="attr">uyuni_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">https://localhost:1234</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">gopher</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">hole</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">ionos</span></span><br><span class="line">    <span class="attr">ionos_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">datacenter_id:</span> <span class="string">8feda53f-15f0-447f-badf-ebe32dad2fc0</span></span><br><span class="line">        <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">vultr</span></span><br><span class="line">    <span class="attr">vultr_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.4:9093&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.5:9093&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.6:9093&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">tsdb:</span></span><br><span class="line">    <span class="attr">out_of_order_time_window:</span> <span class="string">30m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">&quot;localhost:4317&quot;</span></span><br><span class="line">  <span class="attr">client_type:</span> <span class="string">&quot;grpc&quot;</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">&quot;bar&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">&quot;gzip&quot;</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">    <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Prometheus配置文件" scheme="http://example.com/tags/Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Linux修改句柄数</title>
    <link href="http://example.com/2022/10/23/Linux/Linux%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0/"/>
    <id>http://example.com/2022/10/23/Linux/Linux%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0/</id>
    <published>2022-10-23T09:31:20.000Z</published>
    <updated>2022-10-23T13:56:05.799Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg" alt="linux.jpg">  </p><span id="more"></span><h1 id="Linux句柄"><a href="#Linux句柄" class="headerlink" title="Linux句柄"></a>Linux句柄</h1><p>Linux中的句柄分为用户级、系统级。<br>用户级句柄：规定单个进程能够打开的最大文件句柄数量（默认大小1024）<br>系统级句柄：系统中最大文件句柄数量  </p><h2 id="用户级句柄数量修改"><a href="#用户级句柄数量修改" class="headerlink" title="用户级句柄数量修改"></a>用户级句柄数量修改</h2><h3 id="临时修改"><a href="#临时修改" class="headerlink" title="临时修改"></a>临时修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -a #查看 open files 数值，或者直接使用ulimit -n</span><br><span class="line">ulimit -SHn 10000 </span><br></pre></td></tr></table></figure><p>ulimit分为软限制与硬限制。-H是硬限制，实际限制；-S是软限制，告警限制。 </p><h3 id="永久修改"><a href="#永久修改" class="headerlink" title="永久修改"></a>永久修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nofile 个进程最多能打开的的文件数</span></span><br><span class="line">echo &quot;* soft nofile 2048&quot;  &gt;&gt; /etc/security/limits.conf   </span><br><span class="line">echo &quot;* hard nofile 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> nproc 一个用户最多能创建的进程数</span></span><br><span class="line">echo &quot;* soft nproc 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nproc 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure><p>重新ssh连接查看或者重启查看。  </p><h2 id="系统级句柄数修改"><a href="#系统级句柄数修改" class="headerlink" title="系统级句柄数修改"></a>系统级句柄数修改</h2><h3 id="临时修改-1"><a href="#临时修改-1" class="headerlink" title="临时修改"></a>临时修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo  100000 &gt; /proc/sys/fs/file-max</span><br></pre></td></tr></table></figure><h3 id="永久修改-1"><a href="#永久修改-1" class="headerlink" title="永久修改"></a>永久修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo   fs.file-max = 100000  &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p       #从文件中读取数据，默认从/etc/sysctl.conf中读取</span><br><span class="line">sysctl -a|grep fs.file-max      #查看是否修改</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg&quot; alt=&quot;linux.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>3-Prometheus数据</title>
    <link href="http://example.com/2022/10/22/prometheus/3-Prometheus%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2022/10/22/prometheus/3-Prometheus%E6%95%B0%E6%8D%AE/</id>
    <published>2022-10-22T14:55:52.000Z</published>
    <updated>2022-10-29T07:14:35.728Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="Prometheus-数据"><a href="#Prometheus-数据" class="headerlink" title="Prometheus 数据"></a>Prometheus 数据</h1><h2 id="时间序列数据"><a href="#时间序列数据" class="headerlink" title="时间序列数据"></a>时间序列数据</h2><p>时间序列数据通常由应用程序本身通过客户端库或称为exporter来作为HTTP端点暴露，由prometheus进行收集，包含指标、时间戳、测量值。<br><strong>指标</strong>：由指标名称和指标的标签组成，<code>&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</code>  </p><ul><li>metric name：指标名称，由<code>[a-zA-Z_:][a-zA-Z0-9_:]*</code> 组成  </li><li><code>&lt;label name&gt;=&lt;label value&gt;</code>:标签，键值对， <code>[a-zA-Z_][a-zA-Z0-9_]*</code> ， __ 开头的标签仅内部使用  </li></ul><p><strong>时间戳</strong>：精确到毫秒的时间戳<br><strong>测量值</strong>：一个float64的值  </p><h2 id="指标类型"><a href="#指标类型" class="headerlink" title="指标类型"></a>指标类型</h2><h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p>Counter是计数类型。用于累计值，比如请求次数、完成次数。一直增加，不会减少。重启进程后会被重置。可以方便了解事件变化速率。  </p><h3 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h3><p>Gauge是测量器类型，是一个实际测量的值，可变大，可变小。比如剩余空间大小、剩余内存大小  </p><h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><ul><li>将一段时间范围内的数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中. 后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。  </li><li>对每个采样点值累计和(sum)  </li><li>对采样点的次数累计和(count)  </li><li>Histogram不会保存数据采样的值，存储的是区间的样本数统计值  </li></ul><p>一个Histogram可以理解为是由三个指标组成。<br><code>&lt;metric name&gt;_bucket&#123;le=&quot;上边界&quot;&#125;</code>:测量值为bucket中小于等于上边界的所有采样点数量<br><code>&lt;metric name&gt;_sum</code>：bucket中每个采样点值累计和<br><code>&lt;metric name&gt;_count</code>：bucket中采样点数量  </p><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p><img src="/2022/10/22/prometheus/3-Prometheus%E6%95%B0%E6%8D%AE/%E7%A4%BA%E4%BE%8B%E6%95%B0%E6%8D%AE.png"><br>在一个时间段中有以上的数据，对应的在指标中展示为  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> _bucket指标</span></span><br><span class="line">&lt;metric name&gt;_bucket&#123;le=&quot;1&quot;&#125;    2   #采样点数值小于等于1的采样点的数量，即上图中采样点数值为0.1、0.2，一共两个采样点</span><br><span class="line">&lt;metric name&gt;_bucket&#123;le=&quot;5&quot;&#125;    5</span><br><span class="line">&lt;metric name&gt;_bucket&#123;le=&quot;10&quot;&#125;   10</span><br><span class="line">&lt;metric name&gt;_bucket&#123;le=&quot;+Inf&quot;&#125; 10  # +Inf 为无穷</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">_sum指标</span></span><br><span class="line">&lt;metric name&gt;_sum   51.1  #所有采样点值的和，即 0.1+0.2+1.3+3.2+4.6+6.5+7.6+8.8+8.8+10</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> _count指标</span></span><br><span class="line">&lt;metric name&gt;_count 10   #采样点数量，与&lt;metric name&gt;_bucket&#123;le=&quot;+Inf&quot;&#125;数值一致</span><br></pre></td></tr></table></figure><h3 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h3><ul><li>在客户端对于一段时间内（默认是10分钟）的每个采样点进行统计，并形成分位图。  </li><li>统计班上所有同学的总成绩(sum)  </li><li>统计班上同学的考试总人数(count)  </li></ul><p>一个summary指标可以理解为有三个指标组成。<br><code>&lt;metric name&gt;_bucket&#123;quantile=&quot;分位数&quot;&#125;</code>：百分位数的数值，例如quantile=0.5，即采样点数值的中位数，<br><code>&lt;metric name&gt;_sum</code>：每个采样点值累计和<br><code>&lt;metric name&gt;_count</code>：采样点数量  </p><h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><p>有10个采样点数值为{1，2，3，4，5，6，7，8，9，10}  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">分位数计算方法 （n+1）y，n为数据个数，y为分位数，值为第几个数，例如要求某个分位数从公式得出值为2.25，则该分位数为第二个数+（第三个数-第二个数）0.25</span></span><br><span class="line">&lt;metric name&gt;_bucket&#123;quantile=&quot;0&quot;&#125;      1</span><br><span class="line">&lt;metric name&gt;_bucket&#123;quantile=&quot;0.25&quot;&#125;   2.75    #第一四分位数，（10+1）0.25=2.75，2+（3-2）0.75=2.75</span><br><span class="line">&lt;metric name&gt;_bucket&#123;quantile=&quot;0.5&quot;&#125;    5.5     #第二四分位数，即中位数</span><br><span class="line">&lt;metric name&gt;_bucket&#123;quantile=&quot;0.75&quot;&#125;   8.25    #第三四分位数</span><br><span class="line">&lt;metric name&gt;_bucket&#123;quantile=&quot;1&quot;&#125;      10</span><br><span class="line"></span><br><span class="line">&lt;metric name&gt;_sum   55</span><br><span class="line">&lt;metric name&gt;_count 10</span><br></pre></td></tr></table></figure><h1 id="实际数据"><a href="#实际数据" class="headerlink" title="实际数据"></a>实际数据</h1><p>截取 http://Prometheus_server:9090/metrics 前面部分数据<br>每条数据会给出监控指标的解释以及类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles. 监控指标的含义  </span><br><span class="line"># TYPE go_gc_duration_seconds summary  监控指标的类型</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0&quot;&#125; 3.6918e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.25&quot;&#125; 4.4529e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.5&quot;&#125; 5.0101e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;0.75&quot;&#125; 5.5256e-05</span><br><span class="line">go_gc_duration_seconds&#123;quantile=&quot;1&quot;&#125; 9.5807e-05</span><br><span class="line">go_gc_duration_seconds_sum 0.002263475</span><br><span class="line">go_gc_duration_seconds_count 43</span><br><span class="line"># HELP go_goroutines Number of goroutines that currently exist.</span><br><span class="line"># TYPE go_goroutines gauge</span><br><span class="line">go_goroutines 36</span><br><span class="line"># HELP go_info Information about the Go environment.</span><br><span class="line"># TYPE go_info gauge</span><br><span class="line">go_info&#123;version=&quot;go1.19.2&quot;&#125; 1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Prometheus数据" scheme="http://example.com/tags/Prometheus%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>2-Prometheus监控主机与容器</title>
    <link href="http://example.com/2022/10/22/prometheus/2-%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8/"/>
    <id>http://example.com/2022/10/22/prometheus/2-%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8/</id>
    <published>2022-10-21T16:41:34.000Z</published>
    <updated>2022-10-29T07:39:59.445Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="Prometheus监控"><a href="#Prometheus监控" class="headerlink" title="Prometheus监控"></a>Prometheus监控</h1><p>上一章部署了 prometheus server，想要对主机或容器进行监控需要在被监控端安装对应的Exporter。因为prometheus使用的是时间序列，所以<strong>prometheus server与被监控端要做好时间同步</strong>。<br>从prometheus官网中可以看到许多已经成行的<a href="https://prometheus.io/download/">采集插件</a>，每个exporter采集的数据可以从对应exporter的github中查看<br><strong>black_exporter</strong>:黑盒采集器，通过 HTTP、HTTPS、DNS、TCP、ICMP 和 gRPC 对端点进行黑盒探测<br><strong>consul_exporter</strong><br><strong>graphite_exporter</strong>：导出 Graphite 的监控指标并对它们进行转换和公开以供 Prometheus 使用<br><strong>haproxy_exporter</strong><br><strong>memcached_exporter</strong><br><strong>mysqld_exporter</strong><br><strong>node_exporter</strong>：最常用的  </p><h2 id="监控Linux主机（9100端口）"><a href="#监控Linux主机（9100端口）" class="headerlink" title="监控Linux主机（9100端口）"></a>监控Linux主机（9100端口）</h2><p>从Prometheus官网下载node_exporter组件，在远程linux主机上安装node_exporter组件,安装方式与Prometheus安装方式类似。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> tar zxvf node_exporter-1.4.0.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/node_exporter-1.4.0.linux-amd64/ node_exporter</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/node_exporter/node_exporter /usr/<span class="built_in">local</span>/bin/node_exporter</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> nohup /usr/<span class="built_in">local</span>/node_exporter/node_exporter &gt; /usr/<span class="built_in">local</span>/node_exporter/node_exporter.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure><p>查看9100端口是否被监听，以及访问 <code>node_ip:9100/metrics</code>查看收集的监控信息。  </p><h3 id="Prometheus-server配置"><a href="#Prometheus-server配置" class="headerlink" title="Prometheus server配置"></a>Prometheus server配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment">#scrape_configs中添加以下配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;node&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;192.168.27.7:9100&quot;</span>] <span class="comment">#添加多个[&quot;192.168.27.7:9100&quot;,&quot;192.168.27.8:9100&quot;]</span></span><br></pre></td></tr></table></figure><p>配置修改完成后需要将Prometheus server重启，重启后在web管理界面-Status-Targets中可以看到node已经被添加。<br><img src="/2022/10/22/prometheus/2-%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8/%E6%B7%BB%E5%8A%A0node%E7%9B%91%E6%8E%A7.png" alt="node监控">  </p><h2 id="监控Docker容器（8080端口）"><a href="#监控Docker容器（8080端口）" class="headerlink" title="监控Docker容器（8080端口）"></a>监控Docker容器（8080端口）</h2><p>推荐使用Google的cAdvisor工具，cAdvisor作为Docker容器运行，单个cAdvisor容器返回针对Docker守护进程和所有正在运行的容器的指标</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --publish=8080:8080 --detach=true --name=cadvisor google/cadvisor:latest</span><br></pre></td></tr></table></figure><p>容器启动后，可以查看cAdvisor web界面<code>node_ip:8080</code>，以及查看<code>node_ip:8080/metrics</code>收集的监控信息。  </p><h3 id="Prometheus-server配置-1"><a href="#Prometheus-server配置-1" class="headerlink" title="Prometheus server配置"></a>Prometheus server配置</h3><p>与添加node方法相同  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment">#scrape_configs中添加以下配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;docker&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;192.168.27.7:8080&quot;</span>] <span class="comment">#添加多个[&quot;192.168.27.7:8080&quot;,&quot;192.168.27.8:8080&quot;]</span></span><br></pre></td></tr></table></figure><p>配置修改完成后需要将Prometheus server重启，重启后在web管理界面-Status-Targets中可以看到docker已经被添加。<br><img src="/2022/10/22/prometheus/2-%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8/%E6%B7%BB%E5%8A%A0docker%E7%9B%91%E6%8E%A7.png" alt="docker监控">  </p><h2 id="监控MYSQL（9104端口）"><a href="#监控MYSQL（9104端口）" class="headerlink" title="监控MYSQL（9104端口）"></a>监控MYSQL（9104端口）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> tar zxvf mysqld_exporter-0.14.0.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/mysqld_exporter-0.14.0.linux-amd64/ mysqld_exporter</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/mysqld_exporter/mysqld_exporter /usr/<span class="built_in">local</span>/bin/mysqld_exporter</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> nohup /usr/<span class="built_in">local</span>/mysqld_exporter/mysqld_exporter &gt; /usr/<span class="built_in">local</span>/mysqld_exporter/mysqld_exporter.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Prometheus监控主机与容器" scheme="http://example.com/tags/Prometheus%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E4%B8%8E%E5%AE%B9%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>1-Prometheus概述及安装</title>
    <link href="http://example.com/2022/10/21/prometheus/1-Prometheus%E6%A6%82%E8%BF%B0%E5%8F%8A%E5%AE%89%E8%A3%85/"/>
    <id>http://example.com/2022/10/21/prometheus/1-Prometheus%E6%A6%82%E8%BF%B0%E5%8F%8A%E5%AE%89%E8%A3%85/</id>
    <published>2022-10-21T07:51:24.000Z</published>
    <updated>2022-10-29T07:50:42.442Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="Prometheus-概述"><a href="#Prometheus-概述" class="headerlink" title="Prometheus 概述"></a>Prometheus 概述</h1><p>Prometheus是一个优秀的监控工具，非常适合监控容器。<br><img src="/2022/10/21/prometheus/1-Prometheus%E6%A6%82%E8%BF%B0%E5%8F%8A%E5%AE%89%E8%A3%85/Prometheus.png" alt="prometheus架构图"><br><strong>Prometheus server</strong>：用于收集和存储时间序列数据。<br><strong>Exporter</strong>：采集插件，负责收集目标（host、container等）的性能数据，并通过HTTP接口供Prometheus server获取。prometheus sercer通过pull的方式拉取<br><strong>Pushgateway</strong>：各个目标主机可上报数据到pushgateway。Push gateway通过push的方式推送给prometheus sercer。本身也是一个http服务器，一般通过写脚本抓自己想要的数据，自定义一个监控数据，然后推送到pushgateway，然后pushgateway再推送到prometheus。<br><strong>Alertmanager</strong>: 从 Prometheus server 端接收到 alerts 后，会进行去重，分组，并路由到相应的接收方，发出报警。<br><strong>Grafana</strong>：监控仪表盘，可视化监控数据。<br><strong>service Discovery</strong>：服务发现。<br><strong>Retrieval</strong>：负责在活跃的target主机上抓取监控指标数据。<br><strong>Storage</strong>：存储主要是把采集到的数据存储到磁盘中。<br><strong>PromQL</strong>：是Prometheus提供的查询语言模块。。  </p><h2 id="Prometheus工作方式"><a href="#Prometheus工作方式" class="headerlink" title="Prometheus工作方式"></a>Prometheus工作方式</h2><ol><li>Prometheus定期从目标主机上获取数据，目标主机的监控数据可通过配置静态job或者服务发现的方式被prometheus采集到，这种方式默认的pull方式拉取指标；也可通过pushgateway把采集的数据上报到prometheus中；还可通过一些组件自带的exporter采集相应组件的数据。  </li><li>Prometheus把采集到的监控指标数据保存到本地磁盘或者数据库。  </li><li>Prometheus采集的监控指标数据按时间序列存储，通过配置报警规则，把触发的报警发送到alertmanager。  </li><li>Prometheus 自带的web ui界面提供PromQL查询语言，可查询监控数据。  </li><li>Grafana可接入prometheus数据源，把监控数据以图形化形式展示出。  </li></ol><h1 id="Prometheus安装部署"><a href="#Prometheus安装部署" class="headerlink" title="Prometheus安装部署"></a>Prometheus安装部署</h1><p>Prometheus有两种部署方式，二进制文件部署与容器化部署。  </p><h2 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h2><p><code>docker run --name prometheus -d -p 127.0.0.1:9090:9090 prom/prometheus</code></p><h2 id="二进制文件部署"><a href="#二进制文件部署" class="headerlink" title="二进制文件部署"></a>二进制文件部署</h2><p>从<a href="https://prometheus.io/download/">Prometheus官网</a>下载对应安装包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> tar xzf prometheus-2.39.1.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/prometheus-2.39.1.linux-amd64/ /usr/<span class="built_in">local</span>/prometheus</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/prometheus/prometheus /usr/<span class="built_in">local</span>/bin/prometheus</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/prometheus/promtool /usr/<span class="built_in">local</span>/bin/promtool</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> nohup /usr/<span class="built_in">local</span>/prometheus/prometheus --config.file=/usr/<span class="built_in">local</span>/prometheus/prometheus.yml &gt; /usr/<span class="built_in">local</span>/prometheus/prometheus.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure><p>通过localhost:9090即可进行访问。再次界面可以查询Prometheus收集上来的数据。  </p><h2 id="主机数据展示"><a href="#主机数据展示" class="headerlink" title="主机数据展示"></a>主机数据展示</h2><p><code>localhost:9090/metrics</code>中可以查看到Prometheus server的监控指标数据。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Prometheus概述及安装" scheme="http://example.com/tags/Prometheus%E6%A6%82%E8%BF%B0%E5%8F%8A%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>9-docker监控</title>
    <link href="http://example.com/2022/10/21/docker/9-docker%E7%9B%91%E6%8E%A7/"/>
    <id>http://example.com/2022/10/21/docker/9-docker%E7%9B%91%E6%8E%A7/</id>
    <published>2022-10-21T06:23:58.000Z</published>
    <updated>2022-10-21T06:38:51.431Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/2022/10/21/docker/9-docker%E7%9B%91%E6%8E%A7/%E5%9B%BE%E7%89%87docker.jpg" alt="docker">  </p><span id="more"></span><h1 id="docker自带命令"><a href="#docker自带命令" class="headerlink" title="docker自带命令"></a>docker自带命令</h1><h2 id="docker-ps-查看容器"><a href="#docker-ps-查看容器" class="headerlink" title="docker ps 查看容器"></a>docker ps 查看容器</h2><p><strong>-a</strong>:显示所有的容器，包括未运行的。<br><strong>-f</strong>:根据条件过滤显示的内容。<br><strong>–format</strong>:指定返回值的模板文件。<br><strong>-l</strong>:显示最近创建的容器。<br><strong>-n</strong>:列出最近创建的n个容器。<br><strong>–no-trunc</strong> :不截断输出。<br><strong>-q</strong>:静默模式，只显示容器编号。<br><strong>-s</strong>:显示总的文件大小。  </p><h2 id="docker-top-查看容器中运行的进程信息，支持ps命令参数"><a href="#docker-top-查看容器中运行的进程信息，支持ps命令参数" class="headerlink" title="docker top 查看容器中运行的进程信息，支持ps命令参数"></a>docker top 查看容器中运行的进程信息，支持ps命令参数</h2><h2 id="docker-stats-显示容器资源使用情况"><a href="#docker-stats-显示容器资源使用情况" class="headerlink" title="docker stats 显示容器资源使用情况"></a>docker stats 显示容器资源使用情况</h2><p><strong>-a</strong>：显示所有容器，包括未运行的<br><strong>–no-trunc</strong> :不截断输出  </p><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>单独章节学习Prometheus，具体查看 &lt;!–swig￼0–&gt;  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/2022/10/21/docker/9-docker%E7%9B%91%E6%8E%A7/%E5%9B%BE%E7%89%87docker.jpg&quot; alt=&quot;docker&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="http://example.com/categories/docker/"/>
    
    
    <category term="docker监控" scheme="http://example.com/tags/docker%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>8-docker网络</title>
    <link href="http://example.com/2022/10/16/docker/8-docker%E7%BD%91%E7%BB%9C/"/>
    <id>http://example.com/2022/10/16/docker/8-docker%E7%BD%91%E7%BB%9C/</id>
    <published>2022-10-16T15:19:30.000Z</published>
    <updated>2022-10-19T19:02:39.316Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/2022/10/16/docker/8-docker%E7%BD%91%E7%BB%9C/%E5%9B%BE%E7%89%87docker.jpg" alt="docker">  </p><span id="more"></span><h1 id="docker网络"><a href="#docker网络" class="headerlink" title="docker网络"></a>docker网络</h1><p>docker安装后默认的三种网络为none、host、bridge。<br><strong>none</strong>：没有任何网路，没有任何网卡。安全性要求高并且不需要联网的应用可以使用 none 网络。<br><strong>host</strong>：连接到host网络的容器共享docker宿主机的网络，容器的网络配置、hostname与docker宿主机完全一致。<br><strong>bridge</strong>：桥接网络，使用最多，容器默认使用的网络。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">a245b3871ac7   bridge    bridge    local</span><br><span class="line">4b615d9327ee   host      host      local</span><br><span class="line">05e237730870   none      null      local</span><br></pre></td></tr></table></figure><p>在启动容器的时候可以使用<code>--network=none</code>来指定使用的网络  </p><h2 id="bridge网络"><a href="#bridge网络" class="headerlink" title="bridge网络"></a>bridge网络</h2><p>安装docker时会创建docker0的网桥，容器默认使用的都是这个  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">]#</span><span class="bash"> brctl show    <span class="comment"># 需要安装bridge-utils</span></span> </span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">docker08000.0242b1443650no                  #此时是没有容器使用docker0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d busybox</span></span><br><span class="line">ef8acee7abadee73a33c8ded047e7f57af8aaaf85a8bd6035fb271ee8ae99fb2   </span><br><span class="line"><span class="meta">~]#</span><span class="bash"> brctl show</span></span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">docker08000.0242b1443650noveth6e01edd </span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --name=busybox2 busybox</span></span><br><span class="line">d96d5db03d981f4bcdf0f5374a5ca1a1dd741f40dacce82eab8e1a1bc0b68f0e</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> brctl show</span></span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">docker08000.0242b1443650noveth2783997</span><br><span class="line">            veth6e01edd</span><br></pre></td></tr></table></figure><p>veth2783997、veth6e01edd为两个网络接口，对应着两个容器的网卡  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker network inspect bridge</span>  </span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Name&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;Id&quot;: &quot;e56c41006af568144839868cca47fad31c1c0f7251848bffc71621e12bd7f2ee&quot;,</span><br><span class="line">        &quot;Created&quot;: &quot;2022-10-20T01:03:46.451081072+08:00&quot;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class="line">        &quot;EnableIPv6&quot;: false,</span><br><span class="line">        &quot;IPAM&quot;: &#123;</span><br><span class="line">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class="line">            &quot;Options&quot;: null,</span><br><span class="line">            &quot;Config&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,    #bridge的网络配置</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;       #bridge的网络配置，该网关就是docker0 </span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Internal&quot;: false,</span><br><span class="line">        &quot;Attachable&quot;: false,</span><br><span class="line">        &quot;Ingress&quot;: false,</span><br><span class="line">        &quot;ConfigFrom&quot;: &#123;</span><br><span class="line">            &quot;Network&quot;: &quot;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ConfigOnly&quot;: false,</span><br><span class="line">        &quot;Containers&quot;: &#123; #使用bridge网络的容器网络配置</span><br><span class="line">            &quot;d96d5db03d981f4bcdf0f5374a5ca1a1dd741f40dacce82eab8e1a1bc0b68f0e&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;busybox2&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;395664be54909dc79a763e74ca6a4aec83d342113ddbe4c287e2a2d70fcdb67d&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:03&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.3/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;ef8acee7abadee73a33c8ded047e7f57af8aaaf85a8bd6035fb271ee8ae99fb2&quot;: &#123;</span><br><span class="line">                &quot;Name&quot;: &quot;lucid_spence&quot;,</span><br><span class="line">                &quot;EndpointID&quot;: &quot;7b780bdfdf91d7dad89978c6f0a007ec5be2d3bb283b0ce9db24078e24adfd47&quot;,</span><br><span class="line">                &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                &quot;IPv4Address&quot;: &quot;172.17.0.2/16&quot;,</span><br><span class="line">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Options&quot;: &#123;</span><br><span class="line">            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,</span><br><span class="line">            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,</span><br><span class="line">            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="自定义网络"><a href="#自定义网络" class="headerlink" title="自定义网络"></a>自定义网络</h2><p>docker有三种网络驱动，bridge 、overlay 、macvlan。  </p><h3 id="自定义bridge网络"><a href="#自定义bridge网络" class="headerlink" title="自定义bridge网络"></a>自定义bridge网络</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker network create --driver bridge test_bridge</span></span><br><span class="line">b4a9474e46432b19582d3c7e24506aa79486aa12d938fe2f3929ba716ef3fe3e</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID     NAME          DRIVER    SCOPE</span><br><span class="line">e56c41006af5   bridge        bridge    local</span><br><span class="line">4b615d9327ee   host          host      local</span><br><span class="line">05e237730870   none          null      local</span><br><span class="line">b4a9474e4643   test_bridge   bridge    local</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> brctl show</span></span><br><span class="line">bridge namebridge idSTP enabledinterfaces</span><br><span class="line">br-b4a9474e46438000.02426345e115    no</span><br><span class="line">docker08000.0242b1443650noveth2783997</span><br><span class="line">veth6e01edd</span><br></pre></td></tr></table></figure><p>创建一个新的bridge网络test_bridge，对应的会创建一个新的网桥，网桥的名后段就是test_bridge的短ID。<br>创建的新的test_bridge网络的网络配置docker自动分配的，在创建的时候可以指定IP网段。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker network create --driver bridge  --subnet 172.19.0.0/16 --gateway 172.19.0.1 test_bridge_2</span></span><br><span class="line">e3eb0f55cb6356a97189a748a3a6a821a53cf9e1583d9a574cfada2557dcc370 </span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker network ls</span></span><br><span class="line">NETWORK ID     NAME            DRIVER    SCOPE</span><br><span class="line">e56c41006af5   bridge          bridge    local</span><br><span class="line">4b615d9327ee   host            host      local</span><br><span class="line">05e237730870   none            null      local</span><br><span class="line">b4a9474e4643   test_bridge     bridge    local</span><br><span class="line">e3eb0f55cb63   test_bridge_2   bridge    local</span><br></pre></td></tr></table></figure><p>在创建容器的时候可以指定容器的IP，但是使用的网络必须是在创建时也指定- -subnet的。也就是使用test_bridge_2网络才可以指定容器IP，test_bridge则不行  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=test_bridge --ip 172.19.0.2 busybox</span></span><br><span class="line">c320bd7389697c8aaf149d0853166cc882b988c763c25f1cc053a5a6c7d8cfd1</span><br><span class="line">docker: Error response from daemon: user specified IP address is supported only when connecting to networks with user configured subnets.</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=test_bridge_2 --ip 172.19.0.2 busybox</span></span><br><span class="line">09314af7bfdb84bc012aca1804d056e344db7609835040addfbd2b17f1aef8f4</span><br></pre></td></tr></table></figure><h2 id="不同网络容器之间通信"><a href="#不同网络容器之间通信" class="headerlink" title="不同网络容器之间通信"></a>不同网络容器之间通信</h2><p>使用同一个bridge网络的容器之间是可以通信的，使用不同bridge网络的容器之间也可以实现通信。使用<code>docker network connect 网络名 容器</code>连接到指定网络，<code>docker network connect disconnect</code>断开指定的网络，具体的体现就是在对应的容器中多了一个对应网络的网卡。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=test_bridge  --name=busybox1 busybox</span> </span><br><span class="line">17f0e3f6fd1e729b21572e5d0eef9d280e50e5327edfe9fece15764fb22743b8</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=test_bridge  --name=busybox2 busybox</span> </span><br><span class="line">79c883702435d5b00e6ee8ef8e4103d6025929296e9341ef5c3f98503cedb3e0</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=test_bridge_2  --name=busybox3 busybox</span> </span><br><span class="line">fdd8fb26bbf26af839bae7312dd134cd7d5d94e697322d6ec61657eff4da28e9</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker <span class="built_in">exec</span> -it busybox1 sh</span>      </span><br><span class="line">/ # ping busybox2           #在同一个网络中可以使用容器名进行ping</span><br><span class="line">PING busybox2 (172.18.0.3): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.3: seq=0 ttl=64 time=0.224 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=1 ttl=64 time=0.085 ms</span><br><span class="line">64 bytes from 172.18.0.3: seq=2 ttl=64 time=0.098 ms</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker network connect test_bridge busybox3   <span class="comment">#将busybox3添加一个test_bridge的网卡</span></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker <span class="built_in">exec</span> -it busybox3 sh</span></span><br><span class="line">/ # ip a </span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">20: eth0@if21: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:13:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.19.0.2/16 brd 172.19.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">22: eth1@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:12:00:04 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.4/16 brd 172.18.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">/ # ping busybox1</span><br><span class="line">PING busybox1 (172.18.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.2: seq=0 ttl=64 time=0.158 ms</span><br><span class="line">64 bytes from 172.18.0.2: seq=1 ttl=64 time=0.086 ms</span><br></pre></td></tr></table></figure><h2 id="容器之间的三种通信方式"><a href="#容器之间的三种通信方式" class="headerlink" title="容器之间的三种通信方式"></a>容器之间的三种通信方式</h2><p>容器之间可通过 IP，Docker DNS Server 或 joined 容器三种方式通信。  </p><h3 id="IP通信"><a href="#IP通信" class="headerlink" title="IP通信"></a>IP通信</h3><p>属于同一个网络的容器之间是可以通信的。不同网络之间通过<code>docker network connect 网络名 容器</code>实现通信。  </p><h3 id="Docker-DNS-Server"><a href="#Docker-DNS-Server" class="headerlink" title="Docker DNS Server"></a>Docker DNS Server</h3><p>docker内置了DNS服务，在IP通信的情况下可以使用DNS服务进行通信，busybox1与busybox2，以及将busybox3添加到test_bridge网络后，容器之间使用容器名就可以ping通。<br><strong>Docker DNS Server只能是在自定义网络中使用，默认的bridge网络无法使用DNS</strong>  </p><h3 id="joined容器"><a href="#joined容器" class="headerlink" title="joined容器"></a>joined容器</h3><p>使多个容器共享一个网络栈，共享网卡和配置信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --name=test_join busybox</span></span><br><span class="line">578c4ad593d44212bf8180120ff6a5d41b64a8ec60b89ccd6be746baafc474a9</span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker run -it -d --network=container:test_join --name=test_join_2 busybox</span></span><br><span class="line">9b4f485357a3e04a41fd1b883ffcc1ef381fb42b6fc3b3d01018c0fa8c46d584</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker <span class="built_in">exec</span> -it test_join  sh</span></span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">24: eth0@if25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> docker <span class="built_in">exec</span> -it test_join_2  sh</span></span><br><span class="line">/ # ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">24: eth0@if25: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>可以发现test_join与test_join_2的网络配置是相同的。  </p><h2 id="容器与外界通信"><a href="#容器与外界通信" class="headerlink" title="容器与外界通信"></a>容器与外界通信</h2><h3 id="容器访问外界"><a href="#容器访问外界" class="headerlink" title="容器访问外界"></a>容器访问外界</h3><p>例如容器内ping 百度，以下是通信过程。  </p><ol><li>ping <a href="http://www.baidu.com,容器网卡发包/">www.baidu.com，容器网卡发包</a>  </li><li>docker0收到包，交给NAT处理  </li><li>NAT将源地址转换成宿主机网卡的IP  </li><li>ping包从宿主机的网卡发出到达百度  </li></ol><h3 id="外界访问容器"><a href="#外界访问容器" class="headerlink" title="外界访问容器"></a>外界访问容器</h3><p>外部想要访问容器，容器需要将端口映射到宿主机的端口，通过<code>docker run -p 宿主机端口:容器端口</code>实现。外部访问时访问宿主机的端口也就是访问了容器的端口<br>每一个映射的端口，host 都会启动一个 docker-proxy 进程来处理访问容器的流量。  </p><ol><li>docker-proxy 监听映射后宿主的端口  </li><li>当外界访问宿主机端口时，docker-proxy转发给容器  </li><li>容器响应请求并返回结果  </li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;/2022/10/16/docker/8-docker%E7%BD%91%E7%BB%9C/%E5%9B%BE%E7%89%87docker.jpg&quot; alt=&quot;docker&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="http://example.com/categories/docker/"/>
    
    
    <category term="docker网络" scheme="http://example.com/tags/docker%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>LVM</title>
    <link href="http://example.com/2022/09/10/Linux/LVM/"/>
    <id>http://example.com/2022/09/10/Linux/LVM/</id>
    <published>2022-09-10T13:56:24.000Z</published>
    <updated>2022-09-11T10:48:31.440Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/10/QDrWjs6Vz29cCFu.png" alt="LVM.png"></p><span id="more"></span><h1 id="LVM概念"><a href="#LVM概念" class="headerlink" title="LVM概念"></a>LVM概念</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/10/QDrWjs6Vz29cCFu.png&quot; alt=&quot;LVM.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="LVM" scheme="http://example.com/tags/LVM/"/>
    
  </entry>
  
  <entry>
    <title>4-快照与克隆</title>
    <link href="http://example.com/2022/09/08/KVM/4-%E5%BF%AB%E7%85%A7%E4%B8%8E%E5%85%8B%E9%9A%86/"/>
    <id>http://example.com/2022/09/08/KVM/4-%E5%BF%AB%E7%85%A7%E4%B8%8E%E5%85%8B%E9%9A%86/</id>
    <published>2022-09-08T05:07:22.000Z</published>
    <updated>2022-09-25T17:11:38.747Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp" alt="KVM.jpg"></p><span id="more"></span><h1 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h1><p>快照根据存储方式的不同可以分为<strong>内部快照</strong>与<strong>外部快照</strong>。<br>快照也有对应的配置文件，快找配置文件存放在 <strong>/var/lib/libvirt/qemu/snapshot/</strong> 下  </p><h2 id="内部快照"><a href="#内部快照" class="headerlink" title="内部快照"></a>内部快照</h2><p>内部快照：内部快照只支持qcow2格式的虚拟机镜像，把快照及后续变动都保存在原来的qcow2文件内。<br>内部快照可以在虚拟机开机状态下创建，但创建过程中会处于paused状态。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 为CLI_create-centos7.0创建名为test1的快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-create-as CLI_create-centos7.0 test1</span></span><br><span class="line">Domain snapshot test1 created</span><br><span class="line"><span class="meta">#</span><span class="bash"> virsh snapshot-create-as CLI_create-centos7.0 test1  --description &lt;string&gt;  创建快照时为快照添加描述信息，但需要使用snapshot-current才能查看描述信息</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看此虚拟机的快照列表，注意此处的<span class="built_in">stat</span>为保存该快照时虚拟机的状态，即快照中的系统是否为运行状态</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-list CLI_create-centos7.0</span> </span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> test1                2022-09-08 01:38:05 -0400 running</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">查看当前快照配置信息，可以从该配置信息开头确认当前虚拟机是处于什么快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-current CLI_create-centos7.0</span>  </span><br><span class="line">&lt;domainsnapshot&gt;</span><br><span class="line">  &lt;name&gt;test1&lt;/name&gt;</span><br><span class="line">  &lt;state&gt;running&lt;/state&gt;</span><br><span class="line">  &lt;creationTime&gt;1662615485&lt;/creationTime&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定快照信息</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-info CLI_create-centos7.0 test1</span> </span><br><span class="line">Name:           test1</span><br><span class="line">Domain:         CLI_create-centos7.0</span><br><span class="line">Current:        yes</span><br><span class="line">State:          running</span><br><span class="line">Location:       internal</span><br><span class="line">Parent:         -</span><br><span class="line">Children:       0</span><br><span class="line">Descendants:    0</span><br><span class="line">Metadata:       yes</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定快照配置信息</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-dumpxml CLI_create-centos7.0 test1</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 为CLI_create-centos7.0创建名为test2的快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-create-as CLI_create-centos7.0 test2</span></span><br><span class="line">Domain snapshot test2 created</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看快照列表</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-list CLI_create-centos7.0</span> </span><br><span class="line"> Name                 Creation Time             State</span><br><span class="line">------------------------------------------------------------</span><br><span class="line"> test1                2022-09-08 01:38:05 -0400 running</span><br><span class="line"> test2                2022-09-08 02:53:02 -0400 shutoff</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看指定快照的父快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-parent CLI_create-centos7.0 test2</span> </span><br><span class="line">test1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看快照列表关系树</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-list CLI_create-centos7.0 --tree</span></span><br><span class="line">test1</span><br><span class="line">  |</span><br><span class="line">  +- test2</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复test1快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-revert CLI_create-centos7.0 test1</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除test2快照，添加–children将其子裔快照一并删除，–children-only只删除子裔快照</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> virsh snapshot-delete CLI_create-centos7.0 test2</span></span><br><span class="line">Domain snapshot test2 deleted</span><br></pre></td></tr></table></figure><p><strong>注意点</strong>  </p><ol><li>不要使用<code>virsh snapshot-edit</code>修改快照名  </li><li>当一个虚拟机使用多个qcow2文件时，在创建快照时需要加上–atomic参数以确保快照操作的原子性，防止磁盘快照只有部分成功  </li></ol><h2 id="外部快照（暂时先了解）"><a href="#外部快照（暂时先了解）" class="headerlink" title="外部快照（暂时先了解）"></a>外部快照（暂时先了解）</h2><p>外部快照：在创建时，快照被保存在单独一个文件中，创建快照时间点之后的数据被记录到一个新的qcow2文件中，原镜像文件成为新的qcow2文件的backing file（只读），在创建多个快照后，这些文件将形成一个链——backing chain。外部快照同时支持raw和qcow2格式的虚拟机镜像。  </p><h1 id="克隆"><a href="#克隆" class="headerlink" title="克隆"></a>克隆</h1><p>被克隆的虚拟机不能是运行状态，在克隆前需要先将其暂停或者停止  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> virt-clone --auto-clone -o CLI_create-centos7.0 -n <span class="built_in">test</span></span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp&quot; alt=&quot;KVM.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="KVM" scheme="http://example.com/categories/KVM/"/>
    
    
    <category term="快照与克隆" scheme="http://example.com/tags/%E5%BF%AB%E7%85%A7%E4%B8%8E%E5%85%8B%E9%9A%86/"/>
    
  </entry>
  
  <entry>
    <title>3-KVM配置文件和磁盘</title>
    <link href="http://example.com/2022/09/08/KVM/3-KVM%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%A3%81%E7%9B%98/"/>
    <id>http://example.com/2022/09/08/KVM/3-KVM%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%A3%81%E7%9B%98/</id>
    <published>2022-09-07T17:24:29.000Z</published>
    <updated>2022-09-10T13:46:11.846Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp" alt="KVM.jpg"></p><span id="more"></span><h1 id="KVM配置文件"><a href="#KVM配置文件" class="headerlink" title="KVM配置文件"></a>KVM配置文件</h1><p>KVM虚拟机的配置文件存放在 <strong>/etc/libvirt/qemu</strong> 下，每个虚拟机对应一个xml文件，可以通过修改xml文件修改虚拟机硬件配置，但需要使用<code>virsh edit</code>进行修改，使用vim等进行修改则会被覆盖、无效，使用<code>virsh dumpxml</code>查看的就是这些xml文件。<br>在图形化界面中创建虚拟机时或在图形化界面中查看虚拟机硬件详情磁盘信息、虚拟机配置文件中，可以发现磁盘为一个qcow2文件，它既是虚拟机的磁盘，又是虚拟机的镜像。文件的大小并不一定是虚拟机中硬盘的大小，可能是分配的硬盘是”立即分配所有磁盘空间”,也可能是动态分配（随虚拟机中使用的磁盘空间变化，上限为分配的磁盘的大小），通过图形化窗口创建的虚拟机默认“立即分配所有磁盘空间”，想要实现动态分配需要在创建虚拟机之前通过命令创建一个动态分配的磁盘，即可以动态的qcow2文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建一个动态分配磁盘空间的磁盘，最大为50G,文件的创建目录为当前目录</span></span><br><span class="line">qemu-img create -f qcow2 testdisk1.qcow2 50G</span><br></pre></td></tr></table></figure><p><img src="/2022/09/08/KVM/3-KVM%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%A3%81%E7%9B%98/%E5%88%9B%E5%BB%BA.png" alt="创建虚拟机"><br><img src="/2022/09/08/KVM/3-KVM%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%A3%81%E7%9B%98/%E7%A1%AC%E4%BB%B6%E8%AF%A6%E6%83%85.png" alt="硬件详情">  </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">&#x27;file&#x27;</span> <span class="attr">device</span>=<span class="string">&#x27;disk&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">&#x27;qemu&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">&#x27;/var/lib/libvirt/images/centos7.0.qcow2&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">backingStore</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">&#x27;vda&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x07&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="通过命令创建虚拟机"><a href="#通过命令创建虚拟机" class="headerlink" title="通过命令创建虚拟机"></a>通过命令创建虚拟机</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virt-install --name=kvm2 --vcpus=2 --memory=2048 --location=/home/yyg/Desktop/CentOS-7-x86_64-DVD-1810.iso --disk path=/var/lib/libvirt/images/test.qcow2 --network network=default --graphics none --extra-args=&#x27;console=ttyS0&#x27;</span><br></pre></td></tr></table></figure><ul><li>–name=kvm2表示为创建的虚拟机命名为kvm2。  </li><li>–vcpus=2表示设置虚拟机cpu有2个核心。  </li><li>–memory=2048表示设置内存为2G。  </li><li>––location=/home/yyg/Desktop/CentOS-7-x86_64-DVD-1810.iso 表示使用本地iso镜像安装虚拟机。  </li><li>–disk path=/var/lib/libvirt/images/test.qcow2 表示指定虚拟机的磁盘镜像的路径，示例中的路径是我提前通过qemu-img命令创建出来的磁盘，咱们做实验的时候需要自行创建好，如果不想提前创建好磁盘，也可以使用–disk size=50代替–disk path=/var/lib/libvirt/images/kvm2.qcow2，如果使用–disk size=50这个设置，virt-install命令会在/var/lib/libvirt/images/目录中自动创建一个50G的qcow2磁盘，磁盘的前缀名和虚拟机名相同，这个磁盘是预分配所有磁盘空间的，也就是说，会直接占用宿主机50G的磁盘空间。  </li><li>–network network=default表示使用kvm的默认网络  </li><li>–graphics none 表示我们安装的过程中，需要使用的图形化控制台，由于我们此处模拟的是纯命令行安装，所以图形化控制台指定为none，表示不使用图形化控制台安装虚拟机。  </li><li>–extra-args=’console=ttyS0’表示为创建的虚拟机指定内核启动时的内核参数，此处为虚拟机内核添加的参数为console=ttyS0，也就是说，当安装虚拟机时，分配一个ttyS0的虚拟终端，因为我们没有使用图形化控制台安装，所以要分配一个命令行的虚拟终端，以便执行安装操作和安装完成后的登录、执行命令等操作。  </li></ul><p>然后按照提示将需要进行设置的选项设置完成（与正常安装系统时设置一样，只是转换成文本形式）。  </p><h1 id="删除虚拟机"><a href="#删除虚拟机" class="headerlink" title="删除虚拟机"></a>删除虚拟机</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp&quot; alt=&quot;KVM.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="KVM" scheme="http://example.com/categories/KVM/"/>
    
    
    <category term="KVM配置文件和磁盘" scheme="http://example.com/tags/KVM%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%A3%81%E7%9B%98/"/>
    
  </entry>
  
  <entry>
    <title>2-KVM相关命令</title>
    <link href="http://example.com/2022/09/07/KVM/2-KVM%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/"/>
    <id>http://example.com/2022/09/07/KVM/2-KVM%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</id>
    <published>2022-09-07T13:53:00.000Z</published>
    <updated>2022-09-10T13:48:39.623Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp" alt="KVM.jpg"></p><span id="more"></span><h1 id="virsh-命令"><a href="#virsh-命令" class="headerlink" title="virsh 命令"></a>virsh 命令</h1><h2 id="域管理（客户机管理）"><a href="#域管理（客户机管理）" class="headerlink" title="域管理（客户机管理）"></a>域管理（客户机管理）</h2><table><thead><tr><th align="center">命令</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">list</td><td align="center">查看当前运行、挂起的虚拟机，–all查看所有虚拟机</td></tr><tr><td align="center">start/shutdown/reboot VM_NAME</td><td align="center">虚拟机启动、停止、重启</td></tr><tr><td align="center">destroy VM_NAME</td><td align="center">强制停止虚拟机，相当于断电</td></tr><tr><td align="center">undefine VM_NAME</td><td align="center">删除虚拟机</td></tr><tr><td align="center">console VM_NAME</td><td align="center">连接虚拟机，客户机无图形化界面时ctrl+]退出</td></tr><tr><td align="center">edit VM_NAME</td><td align="center">修改虚拟机xml配置</td></tr><tr><td align="center">autostart VM_NAME</td><td align="center">设置虚拟机自启动</td></tr><tr><td align="center">domiflist VM_NAME</td><td align="center">查看虚拟机网卡信息</td></tr><tr><td align="center">domblklist VM_NAME</td><td align="center">查看虚拟机硬盘信息</td></tr><tr><td align="center">dominfo VM_NAME</td><td align="center">列出指定虚拟机的信息</td></tr><tr><td align="center">suspend/resume VM_NAME</td><td align="center">挂起/恢复虚拟机</td></tr><tr><td align="center">domstat VM_NAME</td><td align="center">显示虚拟机状态</td></tr><tr><td align="center">domcontrol VM_NAME</td><td align="center">返回虚拟机状态，ok、error</td></tr><tr><td align="center">dumpxml VM_NAME</td><td align="center">直接显示demo的xml文件配置</td></tr><tr><td align="center">cpu-stats VM_NAME</td><td align="center">虚拟机的cpu状态</td></tr><tr><td align="center">setmen  VM_NAME  SIZE</td><td align="center">设置虚拟机内存</td></tr></tbody></table><h2 id="快照管理"><a href="#快照管理" class="headerlink" title="快照管理"></a>快照管理</h2><table><thead><tr><th align="center">命令</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">snapshot-create VM_NAME</td><td align="center">创建快照</td></tr><tr><td align="center">snapshot-create-as VM_NAME</td><td align="center">创建快照，可添加快照描述/指定快照名称</td></tr><tr><td align="center">snapshot-current VM_NAME</td><td align="center">查看当前快照详细配置</td></tr><tr><td align="center">snapshot-delete VM_NAME snapshot_name</td><td align="center">删除快照</td></tr><tr><td align="center">snapshot-dumpxml VM_NAME snapshot_name</td><td align="center">查看指定快照配置</td></tr><tr><td align="center">snapshot-edit VM_NAME snapshot_name</td><td align="center">编辑指定快照xml文件</td></tr><tr><td align="center">snapshot-info VM_NAME snapshot_name</td><td align="center">查看指定快照信息</td></tr><tr><td align="center">snapshot-list VM_NAME</td><td align="center">查看快照列表</td></tr><tr><td align="center">snapshot-parent VM_NAME</td><td align="center">查看指定快照的父快照名称</td></tr><tr><td align="center">snapshot-revert VM_NAME snapshot_name</td><td align="center">恢复指定快照</td></tr></tbody></table><h2 id="virt-manager"><a href="#virt-manager" class="headerlink" title="virt-manager"></a>virt-manager</h2><h2 id="virt-viewer"><a href="#virt-viewer" class="headerlink" title="virt-viewer"></a>virt-viewer</h2><h2 id="virt-install"><a href="#virt-install" class="headerlink" title="virt-install"></a>virt-install</h2><h2 id="virt-clone"><a href="#virt-clone" class="headerlink" title="virt-clone"></a>virt-clone</h2><h2 id="virt-top"><a href="#virt-top" class="headerlink" title="virt-top"></a>virt-top</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp&quot; alt=&quot;KVM.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="KVM" scheme="http://example.com/categories/KVM/"/>
    
    
    <category term="KVM相关命令" scheme="http://example.com/tags/KVM%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/"/>
    
  </entry>
  
  <entry>
    <title>KVM相关问题以及解决</title>
    <link href="http://example.com/2022/09/03/KVM/KVM%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3/"/>
    <id>http://example.com/2022/09/03/KVM/KVM%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3/</id>
    <published>2022-09-02T18:08:52.000Z</published>
    <updated>2022-09-19T12:43:29.240Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp" alt="KVM.jpg"></p><span id="more"></span><h1 id="问题一：图形化Virtual-Machine-Manager中创建虚拟机时提示“KVM-is-not-available”"><a href="#问题一：图形化Virtual-Machine-Manager中创建虚拟机时提示“KVM-is-not-available”" class="headerlink" title="问题一：图形化Virtual Machine Manager中创建虚拟机时提示“KVM is not available”"></a>问题一：图形化Virtual Machine Manager中创建虚拟机时提示“KVM is not available”</h1><p><img src="/2022/09/03/KVM/KVM%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3/Warning.png" alt="KVM is not available">  </p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>检查是否加载模块<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash">~]<span class="comment">#  lsmod |grep kvm</span></span></span><br><span class="line">kvm_intel             183621  4 </span><br><span class="line">kvm                   586948  1 kvm_intel</span><br><span class="line">irqbypass              13503  1 kvm</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> modprobe kvm  <span class="comment">#如果没有就加载模块</span></span></span><br></pre></td></tr></table></figure></li><li>查看是否开启了CPU虚拟化,如果没有，则是在VMware workstation中虚拟机的CPU虚拟化没有开启  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> lscpu | grep -E <span class="string">&#x27;vmx|svm&#x27;</span></span></span><br></pre></td></tr></table></figure></li></ol><h1 id="问题二：宿主机可正常联网，但KVM内部虚拟机使用nat模式DHCP无法联网"><a href="#问题二：宿主机可正常联网，但KVM内部虚拟机使用nat模式DHCP无法联网" class="headerlink" title="问题二：宿主机可正常联网，但KVM内部虚拟机使用nat模式DHCP无法联网"></a>问题二：宿主机可正常联网，但KVM内部虚拟机使用nat模式DHCP无法联网</h1><h2 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h2><p>需要将宿主机的路由转发功能开启  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br></pre></td></tr></table></figure><h1 id="问题三：console连接KVM-centos7-一直等待"><a href="#问题三：console连接KVM-centos7-一直等待" class="headerlink" title="问题三：console连接KVM centos7 一直等待"></a>问题三：console连接KVM centos7 一直等待</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>出现在在图形化界面中手动创建centos7虚拟机，使用console命令连接时一直等待  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash">  virsh console centos7.0</span> </span><br><span class="line">Connected to domain centos7.0</span><br><span class="line">Escape character is ^]</span><br></pre></td></tr></table></figure><h2 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h2><p>在客户机中修改kernel启动参数  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> grubby --update-kernel=ALL --args=<span class="string">&quot;console=ttyS0&quot;</span></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> reboot</span></span><br></pre></td></tr></table></figure><h1 id="问题四：console连接客户机报“error-operation-failed-Active-console-session-exists-for-this-domain”"><a href="#问题四：console连接客户机报“error-operation-failed-Active-console-session-exists-for-this-domain”" class="headerlink" title="问题四：console连接客户机报“error: operation failed: Active console session exists for this domain”"></a>问题四：console连接客户机报“error: operation failed: Active console session exists for this domain”</h1><h2 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>可能有其他的连接，ps aux | grep console查看，若有则杀死进程后重新连接  </li><li>没有其他连接进程还是无法连接，尝试将宿主机重启  </li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp&quot; alt=&quot;KVM.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="KVM" scheme="http://example.com/categories/KVM/"/>
    
    
    <category term="KVM相关问题以及解决" scheme="http://example.com/tags/KVM%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98%E4%BB%A5%E5%8F%8A%E8%A7%A3%E5%86%B3/"/>
    
  </entry>
  
  <entry>
    <title>1-KVM环境准备、图形化使用</title>
    <link href="http://example.com/2022/09/03/KVM/1-KVM%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E4%BD%BF%E7%94%A8/"/>
    <id>http://example.com/2022/09/03/KVM/1-KVM%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E4%BD%BF%E7%94%A8/</id>
    <published>2022-09-02T17:32:12.000Z</published>
    <updated>2022-09-08T01:03:37.334Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp" alt="KVM.jpg"></p><span id="more"></span><h1 id="KVM环境准备"><a href="#KVM环境准备" class="headerlink" title="KVM环境准备"></a>KVM环境准备</h1><p>在VMware workstation创建虚拟机，然后在虚拟机中搭建KVM环境进行学习。<br>1.在VMware workstation中对虚拟机进行设置。因为KVM是需要硬件虚拟化支持的，所以要将虚拟机CPU的虚拟化开启<br><img src="/2022/09/03/KVM/1-KVM%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E4%BD%BF%E7%94%A8/%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%A1%AC%E4%BB%B6%E8%AE%BE%E7%BD%AE.png" alt="虚拟机硬件设置"><br>2.在VMware workstation中创建虚拟机时，安装一个带有GUI的系统，方便对KVM图形化的熟悉。<br>这样KVM的基础的环境就准备完毕。</p><h2 id="KVM部署"><a href="#KVM部署" class="headerlink" title="KVM部署"></a>KVM部署</h2><p>在KVM部署前检查是否支持虚拟化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> lscpu | grep -E <span class="string">&#x27;vmx|svm&#x27;</span></span></span><br><span class="line">Flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch ssbd ibrs ibpb stibp tpr_shadow vnmi ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 arat spec_ctrl intel_stibp flush_l1d arch_capabilities</span><br></pre></td></tr></table></figure><p>安装对应的虚拟化组件  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> yum install qemu-kvm qemu-img virt-manager libvirt libvirt-python virt-manager libvirt-client virt-install virt-viewer -y</span></span><br></pre></td></tr></table></figure><p>设置虚拟机接口管理组件启动和自启  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> systemctl start libvirtd</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> systemctl <span class="built_in">enable</span> libvirtd</span></span><br></pre></td></tr></table></figure><h2 id="图形化中使用KVM创建虚拟机"><a href="#图形化中使用KVM创建虚拟机" class="headerlink" title="图形化中使用KVM创建虚拟机"></a>图形化中使用KVM创建虚拟机</h2><p>在宿主机的图形化桌面中打开一个命令行窗口，输入virt-manager命令，即可弹出对应的图形化管理窗口，或者在桌面的菜单栏中的应用程序中，选择“虚拟机管理器”（英文界面选择Virtual Machine Manager），都可以打开virt-manager。<br>在virt-manager中创建虚拟机过程比较简单，只需要将所要安装的系统镜像上传到KVM的宿主机中，KVM中虚拟机安装过程省略。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/09/06/4PdOQiHzvqweAKj.webp&quot; alt=&quot;KVM.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="KVM" scheme="http://example.com/categories/KVM/"/>
    
    
    <category term="KVM环境准备、图形化使用" scheme="http://example.com/tags/KVM%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%E3%80%81%E5%9B%BE%E5%BD%A2%E5%8C%96%E4%BD%BF%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title>虚拟化技术</title>
    <link href="http://example.com/2022/09/02/KVM/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/"/>
    <id>http://example.com/2022/09/02/KVM/%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/</id>
    <published>2022-09-02T14:10:13.000Z</published>
    <updated>2022-10-19T19:07:55.155Z</updated>
    
    <content type="html"><![CDATA[<center> 虚拟化技术介绍、分类 </center><span id="more"></span>  <h1 id="虚拟化技术"><a href="#虚拟化技术" class="headerlink" title="虚拟化技术"></a>虚拟化技术</h1><p>简单解释就是将一台主机的资源（CPU、内存、磁盘空间、网络）分割、组合成多台虚拟主机的技术。  </p><h1 id="硬件虚拟化与软件虚拟化"><a href="#硬件虚拟化与软件虚拟化" class="headerlink" title="硬件虚拟化与软件虚拟化"></a>硬件虚拟化与软件虚拟化</h1><p>物理平台本身提供了对特殊指令的截获和重定向的<strong>硬件支持</strong>。支持虚拟化的硬件，也是一些基于硬件实现软件虚拟化技术的关键。目前主要有两种：intel VT和AMD-V。  </p><h1 id="软件虚拟化"><a href="#软件虚拟化" class="headerlink" title="软件虚拟化"></a>软件虚拟化</h1><p>利用软件技术，在现有的物理平台上实现对物理平台访问的截获和模拟。有些软件虚拟化技术需要硬件支持，有些则不需要。</p><h2 id="全虚拟化与准虚拟化"><a href="#全虚拟化与准虚拟化" class="headerlink" title="全虚拟化与准虚拟化"></a>全虚拟化与准虚拟化</h2><h2 id="全虚拟化"><a href="#全虚拟化" class="headerlink" title="全虚拟化"></a>全虚拟化</h2><p>全虚拟化（full virtualization），又叫硬件辅助虚拟化技术，需要硬件虚拟化的支持。全虚拟化最大的优点就是运行在虚拟机上的操作系统没有经过任何修改，唯一的限制就是操作系统必须能够支持底层的硬件。它在虚拟机（VM）和硬件之间加了一个软件层–Hypervisor，或者叫做虚拟机管理程序（VMM），是用来建立与执行虚拟机器的软件、固件或硬件。  </p><h3 id="一型虚拟化"><a href="#一型虚拟化" class="headerlink" title="一型虚拟化"></a>一型虚拟化</h3><p>Hypervisor 直接安装在物理机上，多个虚拟机在 Hypervisor 上运行。Hypervisor 实现方式一般是一个特殊定制的 Linux 系统。Xen 和 VMWare 的 ESXi 都属于这个类型，例如：VMWare的ESXi  </p><h3 id="二型虚拟化"><a href="#二型虚拟化" class="headerlink" title="二型虚拟化"></a>二型虚拟化</h3><p>这种 hypervisor 运行在另一个操作系统（运行在物理硬件之上）中，例如：KVM  </p><h2 id="准虚拟化"><a href="#准虚拟化" class="headerlink" title="准虚拟化"></a>准虚拟化</h2><p>需要改动客户操作系统，使它以为自己运行在虚拟环境下，能够与虚拟机监控机协同工作,不需要硬件虚拟化支持，消耗资源小性能好。这种方法就叫准虚拟化（para-virtualization），也叫半虚拟化。  </p>]]></content>
    
    
    <summary type="html">&lt;center&gt; 虚拟化技术介绍、分类 &lt;/center&gt;</summary>
    
    
    
    <category term="虚拟化介绍" scheme="http://example.com/categories/%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%8B%E7%BB%8D/"/>
    
    
    <category term="虚拟化介绍" scheme="http://example.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96%E4%BB%8B%E7%BB%8D/"/>
    
  </entry>
  
  <entry>
    <title>7-K8S核心技术Service</title>
    <link href="http://example.com/2022/07/07/K8s/7-K8S%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFService/"/>
    <id>http://example.com/2022/07/07/K8s/7-K8S%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFService/</id>
    <published>2022-07-07T02:49:59.000Z</published>
    <updated>2022-09-08T01:01:43.267Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg" alt="k8s">  </p><span id="more"></span><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>在k8s中可以通过pod的ip来进行访问，但是pod的ip不是固定的，而service资源会对提供同一个服务的多个pod进行聚合，提供一个统一的入口，通过访问service的入口地址就能访问到后面的pod服务。  </p><h2 id="Service存在的意义"><a href="#Service存在的意义" class="headerlink" title="Service存在的意义"></a>Service存在的意义</h2><h3 id="防止pod失联（服务发现）"><a href="#防止pod失联（服务发现）" class="headerlink" title="防止pod失联（服务发现）"></a>防止pod失联（服务发现）</h3><p>service充当注册中心的作用，当前有多个前端、后端pod时，前端可以通过service访问后端。</p><h3 id="定义pod访问策略（负载均衡）"><a href="#定义pod访问策略（负载均衡）" class="headerlink" title="定义pod访问策略（负载均衡）"></a>定义pod访问策略（负载均衡）</h3><p>前端pod访问后端pod时，中间会通过service，这里service还能辺负载均衡，将前端请求分发到各个后端pod。  </p><h2 id="service资源类型"><a href="#service资源类型" class="headerlink" title="service资源类型"></a>service资源类型</h2><p><strong>ClusterIP</strong>：集群内部访问，默认方式<br><strong>NodePort</strong>：对外访问应用使用<br><strong>LoadBalancer</strong>：对外访问应用使用，公有云  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">~]#</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">svc</span> <span class="string">nginx</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-07-14T14:01:34Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;266455&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/default/services/nginx</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">d45f429a-23b9-435f-a7ed-704996bb1999</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.1</span><span class="number">.160</span><span class="number">.174</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodePort:</span> <span class="number">30619</span>    <span class="comment">#容器所在节点的端口，即外部机器可以访问的端口</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span>           <span class="comment">#service的端口，即k8s中服务之间的访问端口</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>     <span class="comment">#pod的端口</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg&quot; alt=&quot;k8s&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="http://example.com/categories/Kubernetes/"/>
    
    
    <category term="Service" scheme="http://example.com/tags/Service/"/>
    
  </entry>
  
  <entry>
    <title>k8s相关使用以及问题</title>
    <link href="http://example.com/2022/07/03/K8s/k8s%E7%9B%B8%E5%85%B3%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98/"/>
    <id>http://example.com/2022/07/03/K8s/k8s%E7%9B%B8%E5%85%B3%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98/</id>
    <published>2022-07-03T04:30:21.000Z</published>
    <updated>2022-08-12T02:50:36.935Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg" alt="k8s.jpg">  </p><span id="more"></span><h1 id="相关使用技巧"><a href="#相关使用技巧" class="headerlink" title="相关使用技巧"></a>相关使用技巧</h1><h2 id="kubectl命令补全"><a href="#kubectl命令补全" class="headerlink" title="kubectl命令补全"></a>kubectl命令补全</h2><p>解决无法使用Tab键补全kubectl命令问题</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install bash-completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc </span><br></pre></td></tr></table></figure><h2 id="node节点使用kubectl命令"><a href="#node节点使用kubectl命令" class="headerlink" title="node节点使用kubectl命令"></a>node节点使用kubectl命令</h2><p>解决kubectl无法在node上使用的问题<br>将主节点的<code>/etc/kubernetes/admin.conf</code>拷贝到node节点相同目录下，然后再node节点中配置一下环境变量。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; ~/.bash_profile</span><br><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure><h1 id="问题以及解决"><a href="#问题以及解决" class="headerlink" title="问题以及解决"></a>问题以及解决</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg&quot; alt=&quot;k8s.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="http://example.com/categories/Kubernetes/"/>
    
    
    <category term="k8s相关使用以及问题" scheme="http://example.com/tags/k8s%E7%9B%B8%E5%85%B3%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>6-K8S核心技术Controller</title>
    <link href="http://example.com/2022/07/01/K8s/6-K8S%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/"/>
    <id>http://example.com/2022/07/01/K8s/6-K8S%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AFController/</id>
    <published>2022-07-01T01:49:07.000Z</published>
    <updated>2022-08-12T01:54:35.470Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg" alt="k8s.jpg">  </p><span id="more"></span><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>k8s通常不会直接创建pod，而是通过controller来管理pod，controller中定义了pod的部署特性，为对应不同场景，k8s提供了多种controller。  </p><ol><li><p><strong>ReplicationController(RC)</strong> ：上一代无状态pod应用控制器，不建议使用，建议使用Deployment、ReplicaSet来取代  </p></li><li><p><strong>ReplicaSet(RS)</strong> ：新一代的ReplicationController实现了pod的多副本管理，使用Deployment时会自动创建ReplicaSet，也就是说Deployment是通过ReplicaSet来管理pod的多个副本，通常不使用ReplicaSet，而是通过Deployment去使用ReplicaSet(ReplicaSet不支持滚动更新，但是Deployment支持)  </p></li><li><p><strong>Deployment(deploy)</strong> ：用于管理无状态应用，是构建在ReplicaSet之上的，更为高级的控制器  </p></li><li><p><strong>StatefuleSet(sts)</strong> ：用于管理有状态应用，如数据库服务程序，与Deployment不同的是StatefulSet会为每一个pod创建一个独有的持久性标识，并确保pod间的顺序。有序收缩、有序删除  </p></li><li><p><strong>DeamonSet(ds)</strong> ：用于确保每一个节点都运行了某pod的一个副本，包括后来新增的节点，节点移除则导致pod回收。  </p></li><li><p><strong>job</strong> ：用于管理运行完成后即可终止的应用。  </p></li><li><p><strong>cronjob</strong> ：用于管理定时反复执行的任务  </p></li></ol><h2 id="Deployment（deploy）"><a href="#Deployment（deploy）" class="headerlink" title="Deployment（deploy）"></a>Deployment（deploy）</h2><h3 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h3><p>更多参数查看<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/">官方api文档</a><br>编辑</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>   <span class="comment"># Deployment所在的api</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>      <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span>  <span class="comment"># deployment名</span></span><br><span class="line">  <span class="attr">labels:</span>                 <span class="comment"># deployment标签</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span>                       <span class="comment">#</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>               <span class="comment"># pod资源副本数</span></span><br><span class="line">  <span class="attr">selector:</span>                 <span class="comment"># 管理pod的标签</span></span><br><span class="line">    <span class="attr">matchLabels:</span>            <span class="comment"># 相当于使用matchExpressions &#123;key: app, operator: In, values: nginx&#125;</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span>                 <span class="comment"># 定义要创建的pod</span></span><br><span class="line">    <span class="attr">metadata:</span>               <span class="comment"># pod的元数据</span></span><br><span class="line">      <span class="attr">labels:</span>               <span class="comment"># pod的标签</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>   <span class="comment">#指定要暴露的端口</span></span><br></pre></td></tr></table></figure><p>使用以上yaml创建nginx-deployment.yaml文件  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl apply -f nginx-deployment.yaml   <span class="comment"># 使用nginx-deployment.yaml创建deployment</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl get deploy</span></span><br><span class="line">NAME               READY        UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3          3            3           15m</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout status deployment/nginx-deployment   <span class="comment">#查看nginx-deployment deployment发布状态</span></span></span><br><span class="line">deployment &quot;nginx-deployment&quot; successfully rolled out</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl get pod,rs -o wide --show-labels  <span class="comment">#查看由deployment创建的pod、replicaSet</span></span></span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">pod/nginx-deployment-7fd6966748-bhlxj   1/1     Running   0          29m   10.244.2.8    k8s-node02   &lt;none&gt;           &lt;none&gt;            app=nginx,pod-template-hash=7fd6966748</span><br><span class="line">pod/nginx-deployment-7fd6966748-m85w9   1/1     Running   0          29m   10.244.1.11   k8s-node01   &lt;none&gt;           &lt;none&gt;            app=nginx,pod-template-hash=7fd6966748</span><br><span class="line">pod/nginx-deployment-7fd6966748-sx54r   1/1     Running   0          29m   10.244.2.9    k8s-node02   &lt;none&gt;           &lt;none&gt;            app=nginx,pod-template-hash=7fd6966748</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES         SELECTOR                                 LABELS</span><br><span class="line">replicaset.extensions/nginx-deployment-7fd6966748   3         3         3       29m   nginx        nginx:1.14.2   app=nginx,pod-template-hash=7fd6966748   app=nginx,pod-template-hash=7fd6966748</span><br></pre></td></tr></table></figure><p>pod-template-hash标签是由spec.template（PodTemplate）生成的hash值，这个标签添加到由deployment生成的pod、ReplicaSet中  </p><h3 id="更新Deployment"><a href="#更新Deployment" class="headerlink" title="更新Deployment"></a>更新Deployment</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.16.1   <span class="comment">#将nginx版本由创建时的1.14.2版本改为1.16.1</span></span></span><br><span class="line">deployment.extensions/nginx-deployment image updated</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl edit deployment/nginx-deployment  <span class="comment">#使用编辑器直接修改nginx的版本</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout status deployment/nginx-deployment   <span class="comment">#查看nginx-deployment deployment发布状态</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl get rs         <span class="comment"># 可以发现新的rs扩容到3个，并将旧rs缩容到0个</span></span></span><br><span class="line">NAME                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-6f9d665859   3         3         3       8h</span><br><span class="line">nginx-deployment-7fd6966748   0         0         0       9h</span><br></pre></td></tr></table></figure><p>deployment更新的过程类似于，先创建一个新的rs，等待就绪后，将旧rs缩容到2，也就是创建一个新的，缩容一个旧的，直到新的rs扩容为3，旧的rs缩容为0。  </p><h4 id="Rollover"><a href="#Rollover" class="headerlink" title="Rollover"></a>Rollover</h4><p>Deployment每次更新都会创建新的rs、pod，当Deployment正在更新时再次被更新，正在扩容的rs将被当做为旧rs，然后在进行滚动更新。<br>例如：当Deployment正在创建5个nginx:1.14.2的副本，在创建了3个的时候将nginx改为nginx:1.16.1，这个时候刚创建的3个将被杀死，并开始创建新的副本，不会等待nginx:1.14.2创建完成后在进行更新  </p><h4 id="Deployment标签不可变"><a href="#Deployment标签不可变" class="headerlink" title="Deployment标签不可变"></a>Deployment标签不可变</h4><p>在 API 版本 apps/v1 中，Deployment 标签选择算符在创建后是不可变的。</p><h3 id="回滚Deployment"><a href="#回滚Deployment" class="headerlink" title="回滚Deployment"></a>回滚Deployment</h3><p>Deployment的所有上线记录都会保留在系统中，以便随时回滚。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment  <span class="comment"># 查看deployment/nginx-deployment历史本本</span></span></span><br><span class="line">deployment.extensions/nginx-deployment</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         &lt;none&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到有两个历史版本，但是change-cause是空，CHANGE-CAUSE 的内容是从 Deployment 的 kubernetes.io/change-cause 注解复制过来的。</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl annotate deployment/nginx-deployment kubernetes.io/change-cause=<span class="string">&quot;image updated to 1.16.1&quot;</span></span>   </span><br><span class="line"><span class="meta">#</span><span class="bash">当前nginx版本为1.16.1，为change-cause设定</span></span><br><span class="line">deployment.extensions/nginx-deployment annotated</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment</span></span><br><span class="line">deployment.extensions/nginx-deployment</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">3         &lt;none&gt;</span><br><span class="line">4         image updated to 1.16.1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment --revision=4  <span class="comment">#查看对应版本的详细记录</span></span></span><br><span class="line">deployment.extensions/nginx-deployment with revision #4</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:       app=nginx</span><br><span class="line">        pod-template-hash=6f9d665859</span><br><span class="line">  Annotations:  kubernetes.io/change-cause: image updated to 1.16.1</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:      nginx:1.16.1</span><br><span class="line">    Port:       80/TCP</span><br><span class="line">    Host Port:  0/TCP</span><br><span class="line">    Environment:        &lt;none&gt;</span><br><span class="line">    Mounts:     &lt;none&gt;</span><br><span class="line">  Volumes:      &lt;none&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout undo deployment/nginx-deployment --to-revision=3  <span class="comment">#回滚到版本3</span></span></span><br><span class="line">deployment.extensions/nginx-deployment rolled back</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl describe deploy nginx-deployment  <span class="comment">#查看当前nginx-deployment描述信息</span></span></span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Sat, 02 Jul 2022 21:56:47 +0800</span><br><span class="line">Labels:                 app=nginx</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 5</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;d...</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.14.2</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-7fd6966748 (3/3 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age                From                   Message</span><br><span class="line">  ----    ------             ----               ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  66s (x2 over 11h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  63s (x2 over 11h)  deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  63s (x2 over 11h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  61s (x2 over 12h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  61s                deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  59s                deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 0</span><br></pre></td></tr></table></figure><h3 id="弹性伸缩"><a href="#弹性伸缩" class="headerlink" title="弹性伸缩"></a>弹性伸缩</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl scale deployment/nginx-deployment --replicas=2  <span class="comment">#将deployment的副本数调整为2</span></span></span><br><span class="line">deployment.extensions/nginx-deployment scaled</span><br></pre></td></tr></table></figure><h3 id="暂停与恢复上线"><a href="#暂停与恢复上线" class="headerlink" title="暂停与恢复上线"></a>暂停与恢复上线</h3><p>在deployment上线过程中可以将此过程进行暂停以及恢复，可以在暂停期间进行修改，暂停之前的状态将继续发挥作用，新的更新在暂停期间不会发挥任何作用。暂停期间不能进行回滚  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout pause deployment/nginx-deployment  <span class="comment">#暂停</span></span></span><br><span class="line">deployment.extensions/nginx-deployment paused</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl rollout resume  deployment/nginx-deployment  <span class="comment">#恢复</span></span></span><br><span class="line">deployment.extensions/nginx-deployment resumed</span><br></pre></td></tr></table></figure><h3 id="deployment状态"><a href="#deployment状态" class="headerlink" title="deployment状态"></a>deployment状态</h3><p>查看当前状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> kubectl describe deploy nginx-deployment</span></span><br><span class="line">Name:                   nginx-deployment</span><br><span class="line">Namespace:              default</span><br><span class="line">CreationTimestamp:      Sat, 02 Jul 2022 21:56:47 +0800</span><br><span class="line">Labels:                 app=nginx</span><br><span class="line">Annotations:            deployment.kubernetes.io/revision: 5</span><br><span class="line">                        kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                          &#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;d...</span><br><span class="line">Selector:               app=nginx</span><br><span class="line">Replicas:               2 desired | 2 updated | 2 total | 2 available | 0 unavailable</span><br><span class="line">StrategyType:           RollingUpdate</span><br><span class="line">MinReadySeconds:        0</span><br><span class="line">RollingUpdateStrategy:  25% max unavailable, 25% max surge</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        nginx:1.14.2</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line">    Environment:  &lt;none&gt;</span><br><span class="line">    Mounts:       &lt;none&gt;</span><br><span class="line">  Volumes:        &lt;none&gt;</span><br><span class="line">Conditions:</span><br><span class="line">  Type           Status  Reason</span><br><span class="line">  ----           ------  ------</span><br><span class="line">  Available      True    MinimumReplicasAvailable</span><br><span class="line">  Progressing    True    NewReplicaSetAvailable</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   nginx-deployment-7fd6966748 (2/2 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age                From                   Message</span><br><span class="line">  ----    ------             ----               ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  50m (x2 over 12h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  50m (x2 over 12h)  deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  50m (x2 over 12h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 2</span><br><span class="line">  Normal  ScalingReplicaSet  50m (x2 over 13h)  deployment-controller  Scaled up replica set nginx-deployment-7fd6966748 to 3</span><br><span class="line">  Normal  ScalingReplicaSet  50m                deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 1</span><br><span class="line">  Normal  ScalingReplicaSet  50m                deployment-controller  Scaled down replica set nginx-deployment-6f9d665859 to 0</span><br><span class="line">  Normal  ScalingReplicaSet  46m (x3 over 12h)  deployment-controller  Scaled down replica set nginx-deployment-7fd6966748 to 2</span><br></pre></td></tr></table></figure><p>deployment有三种运行状态， Progressing（进行中）、 Complete（已完成）、 Failed（失败），该状态会被添加到conditions中  </p><h4 id="Progressing（进行中）"><a href="#Progressing（进行中）" class="headerlink" title="Progressing（进行中）"></a>Progressing（进行中）</h4><ul><li>type: Progressing</li><li>status: “True”</li><li>reason: NewReplicaSetCreated | reason: FoundNewReplicaSet | reason: ReplicaSetUpdated</li></ul><h4 id="Complete（已完成）"><a href="#Complete（已完成）" class="headerlink" title="Complete（已完成）"></a>Complete（已完成）</h4><ul><li>type: Progressing</li><li>status: True</li><li>reason: NewReplicaSetAvailable</li></ul><p>Progressing 会一直持续为true，即使副本的可用状态有变化，Progressing状态也不会发生变化  </p><h4 id="Failed（失败）"><a href="#Failed（失败）" class="headerlink" title="Failed（失败）"></a>Failed（失败）</h4><p>检测该状态的方法是在deployment的资源清单中加入截止时间参数.spec.progressDeadlineSeconds。超过该参数设定的时间范围将会把deployment的状态发送到conditions中  </p><ul><li>Type=Progressing</li><li>Status=False</li><li>Reason=ProgressDeadlineExceeded</li></ul><h3 id="deployment-yaml参数介绍"><a href="#deployment-yaml参数介绍" class="headerlink" title="deployment yaml参数介绍"></a>deployment yaml参数介绍</h3><p>相关参数查看官方文档<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/deployment-v1/">deployment API</a>、<a href="https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/common-definitions/object-meta/">公共定义ObjectMeta</a>、<a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/">pod API</a>  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">deployment.kubernetes.io/revision:</span> <span class="string">&quot;5&quot;</span>   <span class="comment">#当前deployment版本序号</span></span><br><span class="line">    <span class="attr">kubectl.kubernetes.io/last-applied-configuration:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#123;&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;name&quot;:&quot;nginx-deployment&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;replicas&quot;:3,&quot;selector&quot;:&#123;&quot;matchLabels&quot;:</span></span><br><span class="line"><span class="string"></span>&#123;<span class="string">&quot;app&quot;</span><span class="string">:&quot;nginx&quot;</span>&#125;<span class="string">&#125;,&quot;template&quot;:&#123;&quot;metadata&quot;:&#123;&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;&#125;,&quot;spec&quot;:&#123;&quot;containers&quot;:[&#123;&quot;image&quot;:&quot;nginx:1.14.2&quot;,&quot;name&quot;:&quot;nginx&quot;,&quot;ports&quot;:[&#123;&quot;containerPort&quot;:80&#125;]&#125;]&#125;&#125;&#125;&#125;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2022-07-02T13:56:47Z&quot;</span>  </span><br><span class="line">  <span class="attr">generation:</span> <span class="number">9</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;155887&quot;</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/apis/extensions/v1beta1/namespaces/default/deployments/nginx-deployment</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">9d3bea0f-dfd8-4787-9448-b2e91e46e4a8</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span>   <span class="comment">#进行状态截止时间</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>                    <span class="comment">#副本数</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>       <span class="comment">#历史版本保存数量</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">strategy:</span>                     <span class="comment">#pod更新策略，有rollingUpdate与Recreate（创建新pod前会将所有pod先杀死）两种</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">25</span><span class="string">%</span>             <span class="comment">#可以超出预期pod量的大小</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span>       <span class="comment">#最大不可用百分比</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.14.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>  <span class="comment">#镜像下载策略  IfNotPresent：如果本地有就不检查，如果没有就拉取</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span> &#123;&#125;    <span class="comment">#容器所需的计算资源</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span>    <span class="comment">#重启策略</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">availableReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-07-02T13:58:44Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2022-07-02T13:58:44Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">Deployment</span> <span class="string">has</span> <span class="string">minimum</span> <span class="string">availability.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">MinimumReplicasAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Available</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="string">&quot;2022-07-03T03:31:18Z&quot;</span></span><br><span class="line">    <span class="attr">lastUpdateTime:</span> <span class="string">&quot;2022-07-03T03:31:18Z&quot;</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">ReplicaSet</span> <span class="string">&quot;nginx-deployment-7fd6966748&quot;</span> <span class="string">has</span> <span class="string">successfully</span> <span class="string">progressed.</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">NewReplicaSetAvailable</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Progressing</span></span><br><span class="line">  <span class="attr">observedGeneration:</span> <span class="number">9</span></span><br><span class="line">  <span class="attr">readyReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">updatedReplicas:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/06/27/5UbYtS64yAIPXzM.jpg&quot; alt=&quot;k8s.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Kubernetes" scheme="http://example.com/categories/Kubernetes/"/>
    
    
    <category term="controller" scheme="http://example.com/tags/controller/"/>
    
  </entry>
  
  <entry>
    <title>Namespace</title>
    <link href="http://example.com/2022/06/29/Linux/Linux%E4%B9%8BNamespace/"/>
    <id>http://example.com/2022/06/29/Linux/Linux%E4%B9%8BNamespace/</id>
    <published>2022-06-29T13:24:38.000Z</published>
    <updated>2022-07-04T04:58:56.942Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg" alt="linux.jpg">  </p><span id="more"></span><h1 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>Linux namespace是Kernel的一个功能，可以将一些系统资源进行隔离。Namespace 是 Linux 内核用来隔离内核资源的方式。通过 namespace 可以让一些进程只能看到与自己相关的一部分资源，而另外一些进程也只能看到与它们自己相关的资源，这两拨进程根本就感觉不到对方的存在。Linux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个 namespace 中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。  </p><p>用户可以创建指定类型的namespace，并将程序放入该namespace中，表示从前的系统中隔离出一个进程的运行环境，在此运行环境中的进程将认为自己拥有该namespace中的独立资源。 实际即使没有手动创建namespace，Linux系统开机后也会创建一个默认的namespace，称为 <strong>root namespace</strong>，所有进程默认都运行在root namespace中，每个进程都认为自己拥有该namespace中所有的全局资源。<br>每一个namespace都是基于当前内核，<strong>root namespace直接基于内核</strong>，<strong>用户创建的namespace运行环境基于当前所在的namespace</strong>，不直接基于内核是因为namespace可能会修改某些运行时内核参数。  </p><h2 id="namespace资源类型"><a href="#namespace资源类型" class="headerlink" title="namespace资源类型"></a>namespace资源类型</h2><p>每种资源都是随着Linux内核版本更新逐渐加入的，所以有些内核版本可能不具备某种namespace  </p><table><thead><tr><th align="center">namespace类型</th><th align="center">隔离的资源</th></tr></thead><tbody><tr><td align="center">IPC</td><td align="center">SystemV IPC(信号量、消息队列、共享内存)和POSIX消息队列</td></tr><tr><td align="center">Network</td><td align="center">网络设备、网络栈、端口</td></tr><tr><td align="center">Mount</td><td align="center">文件系统挂载点</td></tr><tr><td align="center">PID</td><td align="center">进程编号</td></tr><tr><td align="center">User</td><td align="center">用户和用户组</td></tr><tr><td align="center">UTS</td><td align="center">主机名和NIS域名</td></tr><tr><td align="center">Cgroup</td><td align="center">Cgroup的根目录</td></tr></tbody></table><h2 id="查看进程所在的namespace"><a href="#查看进程所在的namespace" class="headerlink" title="查看进程所在的namespace"></a>查看进程所在的namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">]# ll /proc/$$/ns  &amp;&amp; ll /proc/1/ns</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 12:08 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 12:08 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:35 net -&gt; net:[4026531956]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:35 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 12:08 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 12:08 uts -&gt; uts:[4026531838]</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:18 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:18 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 30 23:28 net -&gt; net:[4026531956]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 30 23:28 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:18 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jul  4 11:18 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure><p>路径下的文件都是软连接，指向的文件名中的数字表示namespace的inode，如果不同进程对应的文件的inode相同说明两个进程是在同一个namespace中。  </p><h2 id="Cgroup"><a href="#Cgroup" class="headerlink" title="Cgroup"></a>Cgroup</h2><p>Cgroups(Control Groups) 是Linux内核提供的一种可以限制、记录、隔离进程组（process groups）所使用的物理资源（如：cpu,memory,IO等等）的机制。可以对一组进程及将来的子进程的资源的限制、控制和统计的能力，这些资源包括CPU，内存，存储，网络等。通过Cgroups，可以方便的限制某个进程的资源占用，并且可以实时的监控进程的监控和统计信息。Cgroups也是LXC为实现虚拟化所使用的资源管理手段，可以说没有cgroups就没有LXC (Linux Container)。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">]#</span><span class="bash"> ll /sys/fs/cgroup/</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 blkio                        #​​​定​​​输​​​入​​​/输​​​出​​​限​​​制​​​</span><br><span class="line">lrwxrwxrwx 1 root root 11 Jun 30 23:27 cpu -&gt; cpu,cpuacct           #使​​​用​​​调​​​度​​​程​​​序​​​提​​​供​​​对​​​CPU的​​​cgroup任​​​务访​​问</span><br><span class="line">​lrwxrwxrwx 1 root root 11 Jun 30 23:27 cpuacct -&gt; cpu,cpuacct       #自​​​动​​​生​​​成​​​cgroup中​​​任​​​务​​​所​​​使​​​用​​​的​​​CPU报​​​告</span><br><span class="line">drwxr-xr-x 3 root root  0 Jun 30 23:27 cpu,cpuacct</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 cpuset                       #​​​为​​​cgroup中​​​的​​​任​​​务​​​分​​​配​​​独​​​立​​​CPU（在​​​多​​​核​​​系​​​统​​​）和​​​内​​​存​​​节​​​点​​​</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 devices                      #允​​​许​​​或​​​者​​​拒​​​绝​​​ cgroup 中​​​的​​​任​​​务​​​访​​​问​​​设​​​备</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 freezer                      #挂​​​起​​​或​​​者​​​恢​​​复​​​ cgroup 中​​​的​​​任​​​务</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 hugetlb                      #主要针对于HugeTLB系统进行限制，这是一个大页文件系统</span><br><span class="line">drwxr-xr-x 3 root root  0 Jun 30 23:27 memory                       #设​​​定​​​ cgroup 中​​​任​​​务​​​使​​​用​​​的​​​内​​​存​​​限​​​制​​​，并​​​自​​​动​​​生​​​成​​​​​内​​​存​​​资​​​源使用​​​报​​​告</span><br><span class="line">lrwxrwxrwx 1 root root 16 Jun 30 23:27 net_cls -&gt; net_cls,net_prio</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 net_cls,net_prio</span><br><span class="line">lrwxrwxrwx 1 root root 16 Jun 30 23:27 net_prio -&gt; net_cls,net_prio</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 perf_event</span><br><span class="line">drwxr-xr-x 2 root root  0 Jun 30 23:27 pids</span><br><span class="line">drwxr-xr-x 4 root root  0 Jun 30 23:27 systemd</span><br></pre></td></tr></table></figure><h3 id="Cgroup分配限制资源"><a href="#Cgroup分配限制资源" class="headerlink" title="Cgroup分配限制资源"></a>Cgroup分配限制资源</h3><p>拿menory为例，进入<code>/sys/fs/cgroup/memory</code>下创建<code>test</code>，这样就相当创建一个menory的控制组，进入到test下会发现自动创建了许多文件，每个文件对应不同的限制条件，再将需要进行限制进程的PID添加到tasks中，这样就对这个进程的menory进行了限制，需要删除的话将这个目录删除即可  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg&quot; alt=&quot;linux.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="namespace" scheme="http://example.com/tags/namespace/"/>
    
  </entry>
  
</feed>
