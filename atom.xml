<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DaGuang</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-12-15T06:37:25.663Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>DaGuang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>9-nginx缓存</title>
    <link href="http://example.com/2022/12/11/Nginx/9-nginx%E7%BC%93%E5%AD%98/"/>
    <id>http://example.com/2022/12/11/Nginx/9-nginx%E7%BC%93%E5%AD%98/</id>
    <published>2022-12-11T06:28:01.000Z</published>
    <updated>2022-12-15T06:37:25.663Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="nginx缓存机制"><a href="#nginx缓存机制" class="headerlink" title="nginx缓存机制"></a>nginx缓存机制</h1>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx负载均衡" scheme="http://example.com/tags/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>8-nginx负载均衡</title>
    <link href="http://example.com/2022/12/09/Nginx/8-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <id>http://example.com/2022/12/09/Nginx/8-nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</id>
    <published>2022-12-09T03:26:19.000Z</published>
    <updated>2022-12-15T05:54:02.322Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="服务器组"><a href="#服务器组" class="headerlink" title="服务器组"></a>服务器组</h1><p>upstream设置后端服务器组</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">upstream test_team&#123;    #设置服务器组名为test_team</span><br><span class="line">    #ip_hash      #请求按照IP的hash结果分配，每个访客固定访问一个后端服务器，不能与server中的weigth一同使用，并且必须是最前端的服务器，这样才能获取到客户端的IP</span><br><span class="line">    server 192.168.27.11</span><br><span class="line">    server 192.168.27.12 weight=5  # weight=5权重为5，默认为1，越大越优先用于处理请求</span><br><span class="line">    server 192.168.27.13 fail_timeout=10s  max_fails=3 #10秒内连续三次失败，则在随后的10秒内认为服务器是无效的</span><br><span class="line">    server 192.168.27.14 backup  #备用服务器，只有在正常服务器处于down或者busy时才会被使用</span><br><span class="line">    server 192.168.27.15 down   #标记为永久down状态，通常与ip_hash配合使用</span><br><span class="line">    #last_conn  #把请求分派给连接数最少的服务器</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="例一-一般轮询规则"><a href="#例一-一般轮询规则" class="headerlink" title="例一:一般轮询规则"></a>例一:一般轮询规则</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">    server 192.168.27.11:80</span><br><span class="line">    server 192.168.27.12:80</span><br><span class="line">    server 192.168.27.13:80</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80；</span><br><span class="line">    server_name www.test.demo;</span><br><span class="line">    index index.html;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_set_header HOST $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="例二：加权轮询规则"><a href="#例二：加权轮询规则" class="headerlink" title="例二：加权轮询规则"></a>例二：加权轮询规则</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">    server 192.168.27.11:80 weight=3</span><br><span class="line">    server 192.168.27.12:80 weight=2</span><br><span class="line">    server 192.168.27.13:80 weight=1</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80；</span><br><span class="line">    server_name www.test.demo;</span><br><span class="line">    index index.html;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_set_header HOST $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="例三-对特定资源实现负载均衡"><a href="#例三-对特定资源实现负载均衡" class="headerlink" title="例三:对特定资源实现负载均衡"></a>例三:对特定资源实现负载均衡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">upstream file&#123;</span><br><span class="line">    server 192.168.27.11:80</span><br><span class="line">    server 192.168.27.12:80</span><br><span class="line">    server 192.168.27.13:80</span><br><span class="line">&#125;</span><br><span class="line">upstream video&#123;</span><br><span class="line">    server 192.168.27.11:80</span><br><span class="line">    server 192.168.27.12:80</span><br><span class="line">    server 192.168.27.13:80</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80；</span><br><span class="line">    server_name www.test.demo;</span><br><span class="line">    index index.html;</span><br><span class="line">    location /file/&#123;</span><br><span class="line">        proxy_pass http://file;</span><br><span class="line">    &#125;</span><br><span class="line">    location /video/&#123;</span><br><span class="line">        proxy_pass http://video;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="例四：带有URL重写的负载均衡"><a href="#例四：带有URL重写的负载均衡" class="headerlink" title="例四：带有URL重写的负载均衡"></a>例四：带有URL重写的负载均衡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">    server 192.168.27.11:80 weight=3</span><br><span class="line">    server 192.168.27.12:80 weight=2</span><br><span class="line">    server 192.168.27.13:80 weight=1</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80；</span><br><span class="line">    server_name www.test.demo;</span><br><span class="line">    index index.html;</span><br><span class="line">    location /backend/&#123;</span><br><span class="line">        rewrite ^(.*) XXX last;</span><br><span class="line">    &#125;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://backend;</span><br><span class="line">        proxy_set_header HOST $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx负载均衡" scheme="http://example.com/tags/nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>7-nginx代理服务</title>
    <link href="http://example.com/2022/12/06/Nginx/7-nginx%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1/"/>
    <id>http://example.com/2022/12/06/Nginx/7-nginx%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1/</id>
    <published>2022-12-06T06:21:56.000Z</published>
    <updated>2022-12-09T03:19:45.615Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    resolver 8.8.8.8;    #指定DNS服务器IP地址,默认使用53端口，是必须的指令</span><br><span class="line">    resolver_timout 3s;  #DNS服务器域名解析超时时间</span><br><span class="line">    listen 82;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://$http_host$request_uri;   #设置的代理服务器协议和地址</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不设置server_name<br>linux中配置代理服务器  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=http://proxy.com:82/</span><br><span class="line">export https_proxy=http://proxy.com:82/</span><br></pre></td></tr></table></figure><h1 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h1><h2 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h2><p>用来设置被代理的服务器的地址，可以使主机名、IP加端口  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass http://www.demo.de/uri</span><br><span class="line">proxy_pass http://localhost:8000/uri</span><br></pre></td></tr></table></figure><p>还可以是一组后端服务器  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">upsteam proxy_team&#123;</span><br><span class="line">    server http://192.168.27.10/uri;</span><br><span class="line">    server http://192.168.27.11/uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.demo.de;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass proxy_team;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###或者</span><br><span class="line"></span><br><span class="line">upsteam proxy_team&#123;</span><br><span class="line">    server 192.168.27.10/uri;   #此处不加http://,那么proxy_pass中就要加</span><br><span class="line">    server 192.168.27.11/uri;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.demo.de;</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://proxy_team;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>proxy_pass URL参数中不带URI，则不会改变原地址的URI；参数中带有URI，就会改变源地址的URI。（注意在host后的/也算是 URI）  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.demo.de;</span><br><span class="line">    location /demo/&#123;</span><br><span class="line">        ....</span><br><span class="line">        proxy_pass http://192.168.27.12；   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#当访问www.demo.de/demo则会转向为http://192.168.27.12/demo</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.demo.de;</span><br><span class="line">    location /demo/&#123;</span><br><span class="line">        ....</span><br><span class="line">        proxy_pass http://192.168.27.12/test；   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#当访问www.demo.de/demo则会转向为http://192.168.27.12/test</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx代理服务" scheme="http://example.com/tags/nginx%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>6-nginx rewrite</title>
    <link href="http://example.com/2022/11/30/Nginx/6-nginx%E4%B9%8Brewrite/"/>
    <id>http://example.com/2022/11/30/Nginx/6-nginx%E4%B9%8Brewrite/</id>
    <published>2022-11-30T07:44:33.000Z</published>
    <updated>2022-12-06T06:20:34.746Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h1><p>rewrite用于实现URL的重写以及重定向，例如旧的域名能够跳转到新的域名上，某网页发生改变需要跳转到新的页面等。<br>rewrite指定可以放置在server、location块、if块中，只能对域名后边的出去参数外的字符串起作用，例如：<code>http://192.168.27.11:9090/targets?search=#pool-prometheus</code>，就只对<code>/targets</code>起作用。<br><code>rewrite regex replacement [flag]</code>  </p><ul><li><strong>regex</strong>：正则匹配URL  </li><li><strong>replacement</strong>：跳转后的内容，其中可以使用nginx内置变量，例如$host请求的主机名  </li><li><strong>flag</strong>：标记<br>last :终止继续在本location块中处理接收到的URI，并将此处重写的URI作为一个新的URI，使用各location块进行处理。该标志将重写后的URI重新在server块中执行，为重写后的URI提供了转入到其他location块的机会，一般写在server、if中<br>break :将重写后的地址在当前的location块中继续执行，不会将新的URI转向到其他location块<br>redirect :返回302临时重定向，浏览器地址会显示跳转后的URL地址。<br>permanent :返回301永久重定向，浏览器地址栏会显示跳转后的URL地址。  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># rewrite demo,访问 http://nginx_ip/test时，URL会跳转为http://www.testtest.com/test,服务器中访问的文件为/opt/test下的文件</span><br><span class="line">        location /test &#123;</span><br><span class="line">            rewrite ^/(.*)$ http://www.testtest.com/$1;  #$1为rewrite中正则匹配到的内容，</span><br><span class="line">            root /opt;</span><br><span class="line">            index index.html;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li></ul><h1 id="if"><a href="#if" class="headerlink" title="if"></a>if</h1><p><code>if (condition) &#123;&#125;</code>,可以在server块或location块中配置。<br>判断条件</p><ul><li>变量名：变量的值为<code>0开头的字符串</code>或为<code>空</code>，则条件为false  </li><li>变量与字符串是否相等：使用<code>=</code>、<code>!=</code>，判断变量和字符串是否相等（字符串不需要加引号，<code>=</code>、<code>!=</code>前后需要加空格）  </li><li>变量与字符串匹配：变量值中是否含有正则匹配内容,<code>~</code>正则区分大小写、<code>~*</code>正则不区分大小写，<code>!~</code>、<code>!~*</code>为相反  </li><li>判断文件是否存在：<code>-f</code>、<code>!-f</code>，<code>-f FILE</code>当文件存在时为true  </li><li>判断目录是否存在：<code>-d</code>、<code>!-d</code>  </li></ul><h1 id="break"><a href="#break" class="headerlink" title="break"></a>break</h1><p>中断当前作用域中的其他nginx配置，作用域中<code>break</code>前的指令配置生效，之后的不生效。可以在server、location、if中使用  </p><h1 id="return"><a href="#return" class="headerlink" title="return"></a>return</h1><p>用于完成对请求的处理，直接向客户端返回响应状态代码。可以在server、location、if中使用  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">return TEXT</span><br><span class="line">return CODE</span><br><span class="line">return URL</span><br></pre></td></tr></table></figure><h1 id="set"><a href="#set" class="headerlink" title="set"></a>set</h1><p>用于设置一个新的变量<br><code>set $test_name value</code>变量名称需要以<code>$</code>为开头  </p><h1 id="rewrite-log"><a href="#rewrite-log" class="headerlink" title="rewrite_log"></a>rewrite_log</h1><p>是否开启rewrite日志输出功能<br><code>rewrite_log on/off</code>  </p><h1 id="rewrite的使用"><a href="#rewrite的使用" class="headerlink" title="rewrite的使用"></a>rewrite的使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name old_web.com;</span><br><span class="line">    rewrite ^/ http://www.new_web.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test1.com test2.com;</span><br><span class="line">    if($host ~ test)&#123;</span><br><span class="line">        rewrite ^(.*) http://www.test3.com/$1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="rewrite" scheme="http://example.com/tags/rewrite/"/>
    
  </entry>
  
  <entry>
    <title>5-nginx Gzip</title>
    <link href="http://example.com/2022/11/29/Nginx/5-nginx%E7%9A%84Gzip%E5%8E%8B%E7%BC%A9/"/>
    <id>http://example.com/2022/11/29/Nginx/5-nginx%E7%9A%84Gzip%E5%8E%8B%E7%BC%A9/</id>
    <published>2022-11-29T06:44:25.000Z</published>
    <updated>2022-12-04T01:17:31.179Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="Gzip压缩"><a href="#Gzip压缩" class="headerlink" title="Gzip压缩"></a>Gzip压缩</h1><p>Gzip对响应数据在线实时压缩，ngx_http_gzip_module模块，经过压缩后资源可以变为原来的30%左右，经过服务端压缩后传到浏览器并解压解析。会消耗一定的CPU资源，但是会节约出口带宽，可以提高访问速度。  </p><ol><li><p>gzip<br>开启或者关闭gzip<br><code>gzip on | off;</code>  </p></li><li><p>gzip_buffers<br>设置Gzip压缩文件使用缓存空间的大小<br><code>gzip_buffers NUMBER SIZE;</code><br>NUMBER:空间数<br>SIZE：每个缓存空间的大小  </p></li><li><p>gzip_comp_level<br>压缩级别，1-9，1为压缩程度最低，越大压缩程度越大，越费时间，一般使用5<br><code>gzip_comp_level LEVEL</code>  </p></li><li><p>gzip_disable<br>针对不同种类客户端发起的请求，可以选择性地关闭Gzip功能，不同的浏览器有不同的UA字符串，支持正则。<br><code>gzip_disable UA标识</code><br><code>gzip_disable &quot;MSIE [1-6]\.&quot;; </code>  低版本IE不支持，可以关闭gzip压缩  </p></li><li><p>gzip_min_length<br>限制压缩数据的大小，防止很小的数据压缩后变大情况。默认为20，建议设置为1K<br><code>gzip_min_length 1k</code>  </p></li><li><p>gzip_types<br>指定MIME类型压缩，被设置的类型将被压缩。默认为text/html,设置为*，则为所有类型都进行压缩<br><code>gzip_types text/plain application/x-javascript text/css text/html application/xml;</code>  一般设置  </p></li><li><p>gzip_vary<br>发送带有<code>Vary: Accept-Encoding</code>头域的响应头部，告诉接收方数据经过压缩，这对不支持gzip压缩的客户端是有用的。<br><code>gzip_vary on/off</code>  </p></li><li><p>gzip_static<br>实时动态压缩会比较消耗CPU资源，使用静态压缩，提前将数据压缩，直接返回压缩后的数据。需要使用<br><code>gzip_static on/off</code>  </p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="Gzip压缩" scheme="http://example.com/tags/Gzip%E5%8E%8B%E7%BC%A9/"/>
    
  </entry>
  
  <entry>
    <title>4-nginx配置优化</title>
    <link href="http://example.com/2022/11/29/Nginx/4-nginx%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/"/>
    <id>http://example.com/2022/11/29/Nginx/4-nginx%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/</id>
    <published>2022-11-29T05:59:07.000Z</published>
    <updated>2022-11-29T06:35:37.010Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="nginx配置优化"><a href="#nginx配置优化" class="headerlink" title="nginx配置优化"></a>nginx配置优化</h1><h2 id="work进程配置"><a href="#work进程配置" class="headerlink" title="work进程配置"></a>work进程配置</h2><ol><li><p>worker_processes<br>设置工作进程的数量，最优配置是设置为与CPU核数相同  </p></li><li><p>worker_cpu_affinity<br>为每个进程分配CPU，该与worker_processes、核数有关  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#两核CPU</span><br><span class="line">worker_processes 2;         # 2两个工作进程</span><br><span class="line">worker_cpu_affinity 01 10;  </span><br><span class="line"></span><br><span class="line">#四核CPU</span><br><span class="line">worker_processes 4; </span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br></pre></td></tr></table></figure></li><li><p>worker_connections<br>一个工作进程同时可处理的最大请求数，nginx服务器最大连接数应为worker_processes*worker_connections</p></li><li><p>worker_rlimit_nofile<br>nginx服务器最大连接数，默认为linux的句柄数，若nginx连接数超过句柄数则会报错”too many opened files”  </p></li><li><p>accept_mutex<br>防止工作进程争抢请求，如果没有激活accept_mutex，那么所有的Worker都会被唤醒并争抢这一个请求，但最后只有一个Worker能获取新连接，其它的Worker会重新进入休眠状态，这就是惊群问题。它使服务器的性能下降，因为所有被唤醒的worker进程在重新进入waiting状态前会占用一段CPU时间，<strong>Nginx默认激活了accept_mutex</strong>，也就是说不会有惊群问题。当服务器连接数不多时，开启这个参数会让负载有一定程度的降低（因为不会唤醒多个worker进程）。<strong>但是当服务器的吞吐量很大时，为了效率，需要关闭这个参数（串行化的方式不然导致影响速度的降低）</strong>  </p></li><li><p>accept_mutex_delay<br>当accept_mutex功能启用后，只有一个持有mutex锁的worker进程会接受并处理请求，其他worker进程等待。accept_mutex_delay指定的时间就是这些worker进程的等待时间，过了等待时间下一个worker进程便取得mutex锁，处理请求。ccept_mutex_delay在events模块中指定，默认的值为500ms。</p></li><li><p>multi_accept<br>让nginx worker进程尽可能多地接受请求。它的作用是让worker进程一次性地接受监听队列里的所有请求，然后处理。如果web服务器面对的是一个持续的请求流，那么启用multi_accept可能会造成worker进程一次接受的请求大于worker_connections指定可以接受的请求数。这就是overflow，这个overflow会造成性能损失，overflow这部分的请求不会受到处理。</p></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx配置优化" scheme="http://example.com/tags/nginx%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>3-nginx服务配置</title>
    <link href="http://example.com/2022/11/28/Nginx/3-nginx%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE/"/>
    <id>http://example.com/2022/11/28/Nginx/3-nginx%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE/</id>
    <published>2022-11-28T06:30:08.000Z</published>
    <updated>2022-12-09T05:56:00.184Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h2 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h2><p>/usr/local/nginx/conf/nginx.conf为主配置文件，主配置文件，配置文件必须以<code>;</code>结尾</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">worker_processes  1<span class="comment">;    #全局快</span></span><br><span class="line">events &#123;     <span class="comment"># events块</span></span><br><span class="line">    worker_connections  1024<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">http &#123;     <span class="comment">#http块</span></span><br><span class="line">    include       mime.types<span class="comment">;</span></span><br><span class="line">    default_type  application/octet-stream<span class="comment">;</span></span><br><span class="line">    sendfile        on<span class="comment">;</span></span><br><span class="line">    keepalive_timeout  65<span class="comment">;</span></span><br><span class="line">    server &#123;     <span class="comment"># server块</span></span><br><span class="line">        listen       80<span class="comment">;</span></span><br><span class="line">        server_name  localhost<span class="comment">;</span></span><br><span class="line">        location / &#123;   <span class="comment">#localtion块</span></span><br><span class="line">            root   html<span class="comment">;</span></span><br><span class="line">            index  index.html index.htm<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html<span class="comment">;</span></span><br><span class="line">        <span class="attr">location</span> = /<span class="number">50</span>x.html &#123;     <span class="comment">#localtion块</span></span><br><span class="line">            root   html<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>全局快:配置文件从开始到events块之间的，通常包括worker process数、nginx进程PID的存放路径、日志存放路径  </li><li>events块：主要影响nginx服务器与用户的网络连接，对nginx服务器性能影响对较大。  </li><li>http块：代理、缓存、日志定义等  </li><li>server块：每一个server块相当于一台虚拟主机  </li></ul><p>配置讲解  </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user USER  [GROUP]，配置运行nginx的用户和用户组，注释或者nobody为所有用户都可执行</span></span><br><span class="line"><span class="comment">#只能在全局块中使用</span></span><br><span class="line"><span class="comment">#user  nobody;     </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#工作进程的数量，配置的大小与CPU核数相关，可以设置为auto，为nginx进程自动检测</span></span><br><span class="line"><span class="comment">#只能在全局块中使用</span></span><br><span class="line">worker_processes  1<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#错误日志存放路径，可以设置保存的错误日志的级别</span></span><br><span class="line"><span class="comment">#debug | info | notice | warn | error | crit | alert | emerg，设置某一级别后，比这一级别高的日志也会被记录</span></span><br><span class="line"><span class="comment">#可以在全局块、http、server块中使用</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#PID文件存放路径</span></span><br><span class="line"><span class="comment">#只能在全局块中使用</span></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    <span class="comment">#单个工作进程可以允许同时建立外部连接的数量</span></span><br><span class="line">    worker_connections  1024<span class="comment">;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#防止多个进程对访问连接的争抢</span></span><br><span class="line">    <span class="comment">#只能在events块中进行设置</span></span><br><span class="line">    <span class="comment">#accept_mutex  on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#让nginx worker进程尽可能多地接受请求，worker进程一次性地接受监听队列里的所有请求，然后处理</span></span><br><span class="line">    <span class="comment">#multi_accept on/off;    #默认为off</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#选择事件模型进行消息处理</span></span><br><span class="line">    <span class="comment">#method可选择内容有：select、poll、kqueue、epoll（linux下使用）、rtsig</span></span><br><span class="line">    <span class="comment">#use METHOD </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="comment">#include 表示将其他nginx配置或者第三方模块引用到主配置文件</span></span><br><span class="line">    include       mime.types<span class="comment">;</span></span><br><span class="line">    <span class="comment">#配置用于处理前端请求的MIME类型</span></span><br><span class="line">    default_type  application/octet-stream<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义服务日志的格式，并为格式定一个名字</span></span><br><span class="line">    <span class="comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span></span><br><span class="line">    <span class="comment">#自定义服务日志，access_log path [format [buffer=size]]</span></span><br><span class="line">    <span class="comment">#format为log_format中定义的定义好的格式名称，size为临时存放日志的缓存区的大小</span></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#配置是否允许使用sendfile传输文件</span></span><br><span class="line">    sendfile        on<span class="comment">;</span></span><br><span class="line">    <span class="comment">#每个工作进程每次调用sendfile传输的数据量最大值</span></span><br><span class="line">    <span class="comment">#sendfile_max_chunk SIZE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive超时时间</span></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65<span class="comment">;</span></span><br><span class="line">    <span class="comment">#限制用户某一连接的请求次数，默认为100</span></span><br><span class="line">    <span class="comment">#keepalive_requests NUMBER;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip压缩功能是够开启，是将网页静态资源压缩后传输到浏览器在进行解压，会消耗一定CPU资源，但会提高访问速度</span></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#监听所有IP 80端口</span></span><br><span class="line">        <span class="comment">#listen IP 监听具体IP的80端口、listen PORT 监听所有IP的指定端口</span></span><br><span class="line">        listen       80<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#对外提供的虚拟机；接受请求的域名、IP，由两段或者三段组成，demo.com  www.demo.com</span></span><br><span class="line">        <span class="comment">#可以有多个名，之间用空格隔开，第一个为主名;可以使用通配符*，但是只能在三段的首段或者尾段使用</span></span><br><span class="line">        server_name  localhost<span class="comment">;</span></span><br><span class="line">        </span><br><span class="line">        set $demo </span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># location [=/~/~*/^~/] 请求字符串   </span></span><br><span class="line">        <span class="comment"># = 严格匹配 、^~ 匹配度最高的立即处理</span></span><br><span class="line">        <span class="comment"># 使用正则必必须用标识 ~ 字符串包含正则，区分大小写 、 ~* 字符串包含正则，不区分大小写</span></span><br><span class="line">        location / &#123;  <span class="comment">#  通用匹配, 如果没有其它匹配,任何请求都会匹配到。</span></span><br><span class="line">            <span class="comment"># 请求的根目录，此处为nginx下的html目录，相对路径为相对nginx安装目录</span></span><br><span class="line">            root   html<span class="comment">;    #访问地址为 server_name/location字符串    访问文件路径为 root值/location字符串</span></span><br><span class="line">            index  index.html index.htm<span class="comment">;  #index 为默认首页</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#location /demo &#123;       #根据servername为localhost，当访问 localhost/demo时访问的文件为 /opt/demo下的文件</span></span><br><span class="line">        <span class="comment">#    root   /opt;               #还可以使用alisa更改，例如 alisa /opt/test;   实际访问的文件就是/opt/test下的文件</span></span><br><span class="line">        <span class="comment">#    index index.html;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#设置网站的错误页面，error_page ERROR_CODE  PATH</span></span><br><span class="line">        <span class="comment">#ERROR_CODE为错误代码，多个代码之间用空格隔出</span></span><br><span class="line">        <span class="comment">#PATH为nginx安装目录html为根目录的相对路径，若不想将错误页面放在nginx安装目录，可以后面跟一个location模块重新定向到目录</span></span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        error_page   500 502 503 504  /50x.html<span class="comment">;</span></span><br><span class="line">        <span class="attr">location</span> = /<span class="number">50</span>x.html &#123;</span><br><span class="line">            root   html<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    proxy_pass   http://127.0.0.1;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">        <span class="comment">#    root           html;</span></span><br><span class="line">        <span class="comment">#    fastcgi_pass   127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#    fastcgi_index  index.php;</span></span><br><span class="line">        <span class="comment">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span></span><br><span class="line">        <span class="comment">#    include        fastcgi_params;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">        <span class="comment">#    deny  all;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># another virtual host using mix of IP-, name-, and port-based configuration</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       8000;</span></span><br><span class="line">    <span class="comment">#    listen       somename:8080;</span></span><br><span class="line">    <span class="comment">#    server_name  somename  alias  another.alias;</span></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">    <span class="comment"># HTTPS server</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#server &#123;</span></span><br><span class="line">    <span class="comment">#    listen       443 ssl;</span></span><br><span class="line">    <span class="comment">#    server_name  localhost;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate      cert.pem;</span></span><br><span class="line">    <span class="comment">#    ssl_certificate_key  cert.key;</span></span><br><span class="line">    <span class="comment">#    ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">    <span class="comment">#    ssl_session_timeout  5m;</span></span><br><span class="line">    <span class="comment">#    ssl_ciphers  HIGH:!aNULL:!MD5;</span></span><br><span class="line">    <span class="comment">#    ssl_prefer_server_ciphers  on;</span></span><br><span class="line">    <span class="comment">#    location / &#123;</span></span><br><span class="line">    <span class="comment">#        root   html;</span></span><br><span class="line">    <span class="comment">#        index  index.html index.htm;</span></span><br><span class="line">    <span class="comment">#    &#125;</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx服务配置" scheme="http://example.com/tags/nginx%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>2-nginx安装</title>
    <link href="http://example.com/2022/11/27/Nginx/2-nginx%E5%AE%89%E8%A3%85/"/>
    <id>http://example.com/2022/11/27/Nginx/2-nginx%E5%AE%89%E8%A3%85/</id>
    <published>2022-11-27T07:40:13.000Z</published>
    <updated>2022-11-28T06:41:04.704Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg">  </p><span id="more"></span><h1 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h1><p>nginx安装有yum安装与编译安装，yum安装无法自定义、安装时无法添加模块，编译安装安装位置与模块都可以自定义，但是需要安装依赖。</p><h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>从nginx官网下载安装包，Mainline version是主线版本也就是开发版本，Stable version是稳定版、Legacy versions历史版本。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span>  </span><br><span class="line">yum install -y gcc gcc-c++ make automake autoconf libtool pcre* zlib openssl openssl-devel</span><br><span class="line">tar zxvf nginx-1.22.1.tar.gz -C /usr/local/</span><br><span class="line">cd /usr/local/nginx-1.22.1</span><br><span class="line">./configure   #暂不指定参数</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>安装完成后默认的nginx安装位置在/usr/local/nginx，相关的配置文件都在该位置。  </p><h2 id="将nginx添加为系统服务"><a href="#将nginx添加为系统服务" class="headerlink" title="将nginx添加为系统服务"></a>将nginx添加为系统服务</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/lib/systemd/system/nginx.service</span></span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=nginx web service</span><br><span class="line"><span class="attr">Documentation</span>=http://nginx.org/en/docs/</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PIDFile</span>=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"><span class="attr">ExecStartPre</span>=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="attr">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure><h2 id="nginx服务启停"><a href="#nginx服务启停" class="headerlink" title="nginx服务启停"></a>nginx服务启停</h2><p>/usr/local/nginx/sbin/nginx相关参数<br>-v V：打印版本号、和配置<br>-t：测试配置正确性<br>-q：测试时只显示错误<br>-s：向主进程发送信号，stop（快速关机）、quit（优雅关机）、reopen（重新打开日志文件）、reload（重新加载配置文件）<br>-c：指定nginx配置文件路径<br>-g：指定nginx附加配置文件路径</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx安装" scheme="http://example.com/tags/nginx%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>1-nginx相关概念</title>
    <link href="http://example.com/2022/11/27/Nginx/1-nginx%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
    <id>http://example.com/2022/11/27/Nginx/1-nginx%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</id>
    <published>2022-11-27T04:11:30.000Z</published>
    <updated>2022-11-29T05:51:10.958Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg" alt="nginx.jpg"></p><span id="more"></span><h1 id="Nginx简介"><a href="#Nginx简介" class="headerlink" title="Nginx简介"></a>Nginx简介</h1><p>Nginx是一个高性能的HTTP和反向代理web服务器，也是一个IMAP、POP3、SMTP服务器，特点是占用内存少，并发性能强。  </p><h2 id="Nginx作为web服务器"><a href="#Nginx作为web服务器" class="headerlink" title="Nginx作为web服务器"></a>Nginx作为web服务器</h2><p>Nginx可以作为静态页面的web服务器，异步非阻塞，使用IO多路复用的epoll模型。  </p><h3 id="同步、异步、阻塞、非阻塞"><a href="#同步、异步、阻塞、非阻塞" class="headerlink" title="同步、异步、阻塞、非阻塞"></a>同步、异步、阻塞、非阻塞</h3><p><strong>同步与异步是通信模式的概念</strong><br>同步：发送方发送请求后，等待请求响应，才继续发送下一个请求<br>异步：发送方发送请求后，不需要等待响应，就继续发送下一个请求<br><strong>阻塞与非阻塞是进程处理调用的方式</strong><br>阻塞：结果返回之前线程处于挂起状态<br>非阻塞：线程不会被挂起，立即执行返回下一个调用  </p><h2 id="正向代理（代理的是客户端）"><a href="#正向代理（代理的是客户端）" class="headerlink" title="正向代理（代理的是客户端）"></a>正向代理（代理的是客户端）</h2><p>客户端想要访问一个服务器，但是它可能无法直接访问这台服务器，这时候这可找一台可以访问目标服务器的另外一台服务器，而这台服务器就被当做是代理人的角色 ，称之为代理服务器，于是客户端把请求发给代理服务器，由代理服务器获得目标服务器的数据并返回给客户端。客户端是清楚目标服务器的地址的，而目标服务器是不清楚来自客户端，它只知道来自哪个代理服务器，所以正向代理可以屏蔽或隐藏客户端的信息。  </p><h3 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h3><p><strong>访问被禁止的资源</strong>：让客户端访问原来不能访问的服务器，通过代理服务器进行访问。<br><strong>隐藏客户端的地址</strong>：代理服务器代表了客户端，看不到原始的客户端。<br><strong>进行客户访问控制</strong>：集中部署访问策略，控制客户端的访问行为，内部资源的控制。<br><strong>加速访问资源</strong>：代理服务器设置一个较大的缓冲区，会将部分请求的响应保存到缓冲区，其他用户访问时可以从缓冲区域直接读取信息。  </p><h2 id="反向代理（代理的是服务器）"><a href="#反向代理（代理的是服务器）" class="headerlink" title="反向代理（代理的是服务器）"></a>反向代理（代理的是服务器）</h2><p>反向代理就是代理服务器为服务器作代理人，站在服务器这边，它就是对外屏蔽了服务器的信息，常用的场景就是多台服务器分布式部署，像一些大的网站，由于访问人数很多，就需要多台服务器来解决人数多的问题，这时这些服务器就由一个反向代理服务器来代理，客户端发来请求，先由反向代理服务器，然后按一定的规则分发到明确的服务器，而客户端不知道是哪台服务器。  </p><h3 id="适用场景-1"><a href="#适用场景-1" class="headerlink" title="适用场景"></a>适用场景</h3><p><strong>隐藏服务器的IP</strong>：因为反向代理服务器代理了服务器所以客户端并不知道业务服务器的IP。<br><strong>负载均衡</strong>：反向代理服务器根据业务服务器的负载情况，将客户端的请求分别发送到不同的业务服务器。<br><strong>提高访问速度</strong>：对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务。<br><strong>提供安全保障</strong>：对网站提供基于WEB攻击的防护、为后端提供加密和SSL加速、提供HTTP访问认证。  </p><h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>单个服务器解决不了时，增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器，也就是我们所说的负载均衡。  </p><h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/27/xdGY8aqytLheSjp.jpg&quot; alt=&quot;nginx.jpg&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="nginx" scheme="http://example.com/categories/nginx/"/>
    
    
    <category term="nginx相关概念" scheme="http://example.com/tags/nginx%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
    
  </entry>
  
  <entry>
    <title>6-grafana告警配置</title>
    <link href="http://example.com/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/"/>
    <id>http://example.com/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/</id>
    <published>2022-11-24T18:00:48.000Z</published>
    <updated>2022-11-27T03:38:05.656Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg">  </p><span id="more"></span><h1 id="grafana-告警"><a href="#grafana-告警" class="headerlink" title="grafana 告警"></a>grafana 告警</h1><h2 id="创建告警规则"><a href="#创建告警规则" class="headerlink" title="创建告警规则"></a>创建告警规则</h2><p>告警规则可以通过<code>+New alert rule</code>创建，还可以在dashboard panel的Alter选项卡中进行创建。<br>使用Prometheus数据源创建一个<code>up</code>的告警规则<br><img src="/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/%E8%AE%BE%E7%BD%AE%E5%91%8A%E8%AD%A61.png"><br><img src="/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/%E8%AE%BE%E7%BD%AE%E5%91%8A%E8%AD%A62.png"><br><img src="/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/%E8%AE%BE%E7%BD%AE%E5%91%8A%E8%AD%A63.png">  </p><h2 id="设置告警发送方式"><a href="#设置告警发送方式" class="headerlink" title="设置告警发送方式"></a>设置告警发送方式</h2><p>grafana发送告警的方式是比较多的，如邮件、钉钉、企业微信等</p><h3 id="添加邮件发送方式"><a href="#添加邮件发送方式" class="headerlink" title="添加邮件发送方式"></a>添加邮件发送方式</h3><p>邮件发送方式需要先修改grafana的配置文件<code>vim /etc/grafana/grafana.ini</code>  </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################### SMTP / Emailing ##########################</span></span><br><span class="line"><span class="section">[smtp]</span></span><br><span class="line"><span class="attr">enabled</span> = <span class="literal">True</span>  <span class="comment">#开启smtp</span></span><br><span class="line"><span class="attr">host</span> = smtp.<span class="number">163</span>.com:<span class="number">25</span>  <span class="comment">#smtp服务器</span></span><br><span class="line"><span class="attr">user</span> = <span class="number">17</span>XXXXXXX8@<span class="number">163</span>.com <span class="comment">#用户名</span></span><br><span class="line"><span class="comment"># If the password contains # or ; you have to wrap it with triple quotes. Ex &quot;&quot;&quot;#password;&quot;&quot;&quot;</span></span><br><span class="line"><span class="attr">password</span> = XXXXXXX    <span class="comment">#密码</span></span><br><span class="line"><span class="comment">;cert_file =</span></span><br><span class="line"><span class="comment">;key_file =</span></span><br><span class="line"><span class="comment">;skip_verify = false</span></span><br><span class="line"><span class="attr">from_address</span> = <span class="number">17</span>XXXXXXX8@<span class="number">163</span>.com  <span class="comment">#发件人邮箱</span></span><br><span class="line"><span class="attr">from_name</span> = test_name   <span class="comment">#发件人名</span></span><br><span class="line"><span class="comment"># EHLO identity in SMTP dialog (defaults to instance_name)</span></span><br><span class="line"><span class="comment">;ehlo_identity = dashboard.example.com</span></span><br><span class="line"><span class="comment"># SMTP startTLS policy (defaults to &#x27;OpportunisticStartTLS&#x27;)</span></span><br><span class="line"><span class="comment">;startTLS_policy = NoStartTLS</span></span><br><span class="line"></span><br><span class="line"><span class="section">[emails]</span></span><br><span class="line"><span class="comment">;welcome_email_on_sign_up = false</span></span><br><span class="line"><span class="comment">;templates_pattern = emails/*.html, emails/*.txt</span></span><br><span class="line"><span class="comment">;content_types = text/html</span></span><br></pre></td></tr></table></figure><p>重启grafana服务，然后再grafana–Contact points–New contact point进行配置<br><img src="/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/%E5%91%8A%E8%AD%A6%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE.png">  </p><h3 id="添加企业微信发送方式"><a href="#添加企业微信发送方式" class="headerlink" title="添加企业微信发送方式"></a>添加企业微信发送方式</h3><p>首先需要<a href="https://work.weixin.qq.com/wework_admin/register_wx?from=myhome">注册一个企业微信</a>，创建完成后登录创建一个群聊，群聊中添加一个机器人，记录一下这个机器人的Webhook。登录企业微信，查找企业ID，在应用管理-打卡-API中查看Secret。<br><img src="/2022/11/25/grafana/6-grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/%E5%91%8A%E8%AD%A6%E5%BE%AE%E4%BF%A1%E9%85%8D%E7%BD%AE.png">  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="grafana告警配置" scheme="http://example.com/tags/grafana%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>5-panel可视化</title>
    <link href="http://example.com/2022/11/25/grafana/5-panel%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    <id>http://example.com/2022/11/25/grafana/5-panel%E5%8F%AF%E8%A7%86%E5%8C%96/</id>
    <published>2022-11-24T18:00:18.000Z</published>
    <updated>2022-11-25T06:25:58.348Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg">  </p><span id="more"></span><h1 id="panel"><a href="#panel" class="headerlink" title="panel"></a>panel</h1><h2 id="panel预览"><a href="#panel预览" class="headerlink" title="panel预览"></a>panel预览</h2><p><img src="/2022/11/25/grafana/5-panel%E5%8F%AF%E8%A7%86%E5%8C%96/panel%E9%A2%84%E8%A7%88.png"><br>Table view:试图转换为表格<br>Fill：在编辑界面中图表自动填充，并不是dashboard中的实际大小<br>Actual：编辑界面中预览的与实际dashboard中的大小一致，或者按照实际比例缩小  </p><h2 id="数据部分"><a href="#数据部分" class="headerlink" title="数据部分"></a>数据部分</h2><p><strong>Query（查询选项卡）</strong><br><img src="/2022/11/25/grafana/5-panel%E5%8F%AF%E8%A7%86%E5%8C%96/Query.png">  </p><p><strong>Transform（转换选项卡）</strong><br>使用转换方法对返回的数据进行操作，转换是有顺序的，转换方法当有多个时，每个转换都会创建一个结果集，然后传递给处理管道中的下一个转换。<br>相关转换方法的解释以及使用查看<a href="https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/transform-data/#transform-data">官网Transform data文档</a>  </p><p><strong>Alert（告警选项卡）</strong><br>创建告警</p><h2 id="panel显示配置"><a href="#panel显示配置" class="headerlink" title="panel显示配置"></a>panel显示配置</h2><p>图例相关配置，不同的可视化panel有不同的配置，具体查看<a href="https://grafana.com/docs/grafana/latest/panels-visualizations/visualizations/">官网Visualizations文档</a><br><img src="/2022/11/25/grafana/5-panel%E5%8F%AF%E8%A7%86%E5%8C%96/%E6%98%BE%E7%A4%BA%E9%85%8D%E7%BD%AE.png">  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="panel可视化" scheme="http://example.com/tags/panel%E5%8F%AF%E8%A7%86%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>4-dashboard</title>
    <link href="http://example.com/2022/11/22/grafana/4-dashboard/"/>
    <id>http://example.com/2022/11/22/grafana/4-dashboard/</id>
    <published>2022-11-22T07:35:05.000Z</published>
    <updated>2022-11-24T17:54:23.186Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg"> </p><span id="more"></span><h1 id="添加数据源"><a href="#添加数据源" class="headerlink" title="添加数据源"></a>添加数据源</h1><p>在创建dashboard之前需要先添加数据源。<br>Configuration–Data sources–Add data source，添加数据源，如没有要添加的数据源可以在plugins中查看对应的插件进行安装，安装后在添加数据源。<br>这里添加一个prometheus数据源，添加prometheus数据源只需要填写URL（prometheus web页面地址）即可，其他根据需求进行填写，添加后可以点击<code>save&amp;test</code>进行保存并测试。  </p><h1 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h1><h2 id="创建dashboard"><a href="#创建dashboard" class="headerlink" title="创建dashboard"></a>创建dashboard</h2><p><code>+ New dashboard</code>–<code>Add a new panel</code>，可以为新的dashboard创建一个新的panel<br><img src="/2022/11/22/grafana/4-dashboard/%E5%88%9B%E5%BB%BAdashboard.png">  </p><h2 id="dashboard设置"><a href="#dashboard设置" class="headerlink" title="dashboard设置"></a>dashboard设置</h2><h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><p>变量在dashboard内定义后在仪表盘左上角行程可选项，对应的在panel中定义图表中可进行使用变量<br><img src="/2022/11/22/grafana/4-dashboard/Variables.png"><br><strong>General</strong><br>Name：变量名称<br>Label:在仪表盘中显示的标签名<br>Hide：隐藏Label（标签名）、变量<br>Type：变量的类型，有多种变量  </p><ul><li>Interval：间隔，查询的时间跨度  </li><li>Query：查询，编写数据源查询，通常返回度量名称、标签值等，如主机、主机组等  </li><li>Datasource：指定数据源，如有多个同类型数据源，可以使用该变量在多个同类数据源中选择  </li><li>Custom：用户自定义的变量  </li><li>Constant：常量  </li><li>Ad hoc filters：只适用于部分数据源，InfluxDB、Prometheus、Elasticsearch，  </li><li>Text Box：文本，提供一个可以自由输入的文本框  </li></ul><p><strong>Query Options （查询选项）</strong><br>Data source:数据源<br>Refresh：刷新方式，On Dashboard load（仪表盘加载时）、On time range changed（时间范围发生变化）<br>Regex：正则，使用正则表达式类匹配对应的值<br>Sort：排序方式  </p><p><strong>Selection Options</strong><br>Multi-value:允许多选，即在Dashboard变量可以选择多个值可以同时勾选多个<br><img src="/2022/11/22/grafana/4-dashboard/Multi-value.png"><br>Include All option：所有，即在Dashboard变量中可以有一个All的选项，允许勾选<br><img src="/2022/11/22/grafana/4-dashboard/ALL.png">  </p><h3 id="link"><a href="#link" class="headerlink" title="link"></a>link</h3><p>dashboard link显示在dashboard右上角，在dashboard中进行设置，可以设置外部网站的链接或者其他dashboard的下拉菜单。<br><img src="/2022/11/22/grafana/4-dashboard/dashboard-link.png"><br>dashboard link有两种类型，dashboards是grafana中其他dashboard，link是代表添加的其他URL。<br><img src="/2022/11/22/grafana/4-dashboard/dashboard.png"><br><img src="/2022/11/22/grafana/4-dashboard/link.png"><br><img src="/2022/11/22/grafana/4-dashboard/%E6%95%88%E6%9E%9C.png">  因为在dashboard类型link中选择了<code>show as dropdown</code>，所以点击new link会显示下拉列表  </p><h2 id="导入dashboard"><a href="#导入dashboard" class="headerlink" title="导入dashboard"></a>导入dashboard</h2><p>可以从<a href="https://grafana.com/grafana/dashboards/?plcmt=footer">官网</a>找到适合的dashboard通过<code>+Import</code>使用对应的JSON或者外网状态下使用dashboard ID进行导入。<br><strong>dashboard推荐</strong><br>Node Exporter Full（1860）：prometheus node-exporter  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt; &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="dashboard" scheme="http://example.com/tags/dashboard/"/>
    
  </entry>
  
  <entry>
    <title>3-grafana界面介绍</title>
    <link href="http://example.com/2022/11/13/grafana/3-grafana%E7%95%8C%E9%9D%A2%E4%BB%8B%E7%BB%8D/"/>
    <id>http://example.com/2022/11/13/grafana/3-grafana%E7%95%8C%E9%9D%A2%E4%BB%8B%E7%BB%8D/</id>
    <published>2022-11-13T06:59:54.000Z</published>
    <updated>2022-11-25T05:21:17.849Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg"> </p><span id="more"></span><h1 id="grafana界面"><a href="#grafana界面" class="headerlink" title="grafana界面"></a>grafana界面</h1><p>根据grafana web界面左侧菜单介绍一下相关功能  </p><h2 id="home"><a href="#home" class="headerlink" title="home"></a>home</h2><p>grafana logo，此处为界面的home page，从任何界面点击都会跳转到home page页，这个页面的各个模块也可以进行设置修改  </p><h2 id="Search-dashboards"><a href="#Search-dashboards" class="headerlink" title="Search dashboards"></a>Search dashboards</h2><p>搜索当前用户可以查看的dashboard  </p><h2 id="starred"><a href="#starred" class="headerlink" title="starred"></a>starred</h2><p>给dashboard添加星标后，会展示在该页面   </p><h2 id="dashboards"><a href="#dashboards" class="headerlink" title="dashboards"></a>dashboards</h2><p>仪表盘菜单</p><ul><li>browse：可以再次界面创建folder、dashboard  </li><li>playlists：可以将多个dashboard组成播放列表循环轮播，可以作为监控大屏轮播  </li><li>snapshots  </li><li>library panels：面板库，可以将设置好的面板添加到面板库中，创建时可直接选取  </li><li>+New dashboard ：创建dashboard  </li><li>+New folder：创建文件夹  </li><li>+Import：导入，可以将panel、dashboard的JSON文件导入，也可以在现网状态下直接将<a href="https://grafana.com/grafana/dashboards/?plcmt=footer">官网</a>中dashboard导入  </li></ul><h2 id="Explore"><a href="#Explore" class="headerlink" title="Explore"></a>Explore</h2><p>可以选择数据源进行临时查询，查询后的表可以添加到dashboard中  </p><h2 id="Alerting"><a href="#Alerting" class="headerlink" title="Alerting"></a>Alerting</h2><p>告警配置  </p><ul><li>Alert rules ：告警规则配置  </li><li>Contact points：告警消息模板、告警发送方式  </li><li>Notification policies：告警默认发送方式以及发送告警的时间设置，根据告警的标签设置不通的发送方式  </li><li>Silences：根据告警规则标签屏蔽告警  </li><li>Alert groups:告警组  </li><li>Admin:</li><li>+New alert rule:创建告警规则</li></ul><h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><ul><li>Data sources:grafana数据源，可以添加多种、多个数据源  </li><li>users：grafana用户，,admin、可编辑、只读用户三种角色，创建用户时会给给出一个链接，需要访问链接进行创建用户  </li><li>Teams：团队，可以创建对应的团队，并设置团队的主dashboard  </li><li>plugins：插件，对应在前面章节中界面安装插件方式  </li><li>Organization profile：当前用户所在的组织，不同的组织的dashboard是不共享的，可以在用户-Switch Organization切换用户   </li></ul><h2 id="server-admin"><a href="#server-admin" class="headerlink" title="server admin"></a>server admin</h2><p>管理所有用户和组织</p><ul><li>users：grafana中所有的用户信息，点击用户可以查看详细信息  </li><li>Organizations：grafana中所有的组织，可以创建组织，一个用户可以属于多个组织  </li><li>setting：grafana服务相关配置信息  </li><li>Statistics and licensing：统计信息，包含仪表盘、标签、数据源、报警、用户、组织数量信息  </li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt; &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="grafana界面介绍" scheme="http://example.com/tags/grafana%E7%95%8C%E9%9D%A2%E4%BB%8B%E7%BB%8D/"/>
    
  </entry>
  
  <entry>
    <title>2-grafana插件安装</title>
    <link href="http://example.com/2022/11/12/grafana/2-grafana%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/"/>
    <id>http://example.com/2022/11/12/grafana/2-grafana%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/</id>
    <published>2022-11-12T07:22:28.000Z</published>
    <updated>2022-11-12T10:27:10.165Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg"> </p><span id="more"></span><h1 id="grafana插件安装"><a href="#grafana插件安装" class="headerlink" title="grafana插件安装"></a>grafana插件安装</h1><p>插件安装分为两种方式：在线安装与离线安装  </p><h2 id="在线安装插件"><a href="#在线安装插件" class="headerlink" title="在线安装插件"></a>在线安装插件</h2><p>在线安装插件可以在grafana的web界面进行安装，找到需要的插件进行安装即可<br><img src="/2022/11/12/grafana/2-grafana%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85.png"><br>还可以使用grafana-cli进行安装，使用<strong>grafana-cli安装插件后需要将grafana服务重启</strong>  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins COMMANDS</span><br><span class="line">COMMANDS:</span><br><span class="line">   install                  install &lt;plugin id&gt; &lt;plugin version (optional)&gt;，安装指定插件，可以指定插件的版本</span><br><span class="line">   list-remote              list remote available plugins，查看可以安装的插件</span><br><span class="line">   list-versions            list-versions &lt;plugin id&gt;，查看指定插件的版本</span><br><span class="line">   update, upgrade          update &lt;plugin id&gt;，更新插件</span><br><span class="line">   update-all, upgrade-all  update all your installed plugins</span><br><span class="line">   ls                       list all installed plugins，查看已经安装的插件</span><br><span class="line">   uninstall, remove        uninstall &lt;plugin id&gt;，卸载插件</span><br><span class="line">   help, h                  Shows a list of commands or help for one command</span><br></pre></td></tr></table></figure><p>插件默认安装在<code>/var/lib/grafana/plugins</code>下，可以指定安装目录进行安装，需要添加参数 <code>--pluginsDir=PATH</code>，也可以修改<code>/usr/sbin/grafana-cli</code>中的配置  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">]#</span><span class="bash"> more /usr/sbin/grafana-cli</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">! /usr/bin/env bash</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Wrapper <span class="keyword">for</span> the grafana-cli binary</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file serves as a wrapper <span class="keyword">for</span> the grafana-cli binary. It ensures we <span class="built_in">set</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the system-wide Grafana configuration that was bundled with the package as we</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use the binary.</span></span><br><span class="line"></span><br><span class="line">DEFAULT=/etc/default/grafana</span><br><span class="line"></span><br><span class="line">GRAFANA_HOME=/usr/share/grafana</span><br><span class="line">CONF_DIR=/etc/grafana</span><br><span class="line">DATA_DIR=/var/lib/grafana</span><br><span class="line">PLUGINS_DIR=/var/lib/grafana/plugins</span><br><span class="line">LOG_DIR=/var/log/grafana</span><br><span class="line"></span><br><span class="line">CONF_FILE=$CONF_DIR/grafana.ini</span><br><span class="line">PROVISIONING_CFG_DIR=$CONF_DIR/provisioning</span><br><span class="line"></span><br><span class="line">EXECUTABLE=$GRAFANA_HOME/bin/grafana-cli</span><br><span class="line"></span><br><span class="line">if [ ! -x $EXECUTABLE ]; then</span><br><span class="line"> echo &quot;Program not installed or not executable&quot;</span><br><span class="line"> exit 5</span><br><span class="line">fi</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> overwrite settings from default file</span></span><br><span class="line">if [ -f &quot;$DEFAULT&quot; ]; then</span><br><span class="line">  . &quot;$DEFAULT&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">OPTS=&quot;--homepath=$&#123;GRAFANA_HOME&#125; \</span><br><span class="line">      --config=$&#123;CONF_FILE&#125; \</span><br><span class="line">      --pluginsDir=$&#123;PLUGINS_DIR&#125; \</span><br><span class="line">      --configOverrides=&#x27;cfg:default.paths.provisioning=$PROVISIONING_CFG_DIR \</span><br><span class="line">                        cfg:default.paths.data=$&#123;DATA_DIR&#125; \</span><br><span class="line">                        cfg:default.paths.logs=$&#123;LOG_DIR&#125; \</span><br><span class="line">                        cfg:default.paths.plugins=$&#123;PLUGINS_DIR&#125;&#x27;&quot;</span><br><span class="line"></span><br><span class="line">eval $EXECUTABLE &quot;$OPTS&quot; &#x27;$@&#x27;</span><br></pre></td></tr></table></figure><p>grafana的环境变量在多个配合文件中有相同定义需要全都修改，有些不方便  </p><h2 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h2><p>离线安装可以在<a href="https://grafana.com/grafana/plugins/?plcmt=footer">官网插件</a>中找到对应的插件安装包,下载后为一个压缩包，将压缩包解压后放在<code>/var/lib/grafana/plugins</code>下即可，<strong>注意不要忘记重启</strong>  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt; &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="grafana插件安装" scheme="http://example.com/tags/grafana%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>1-grafana安装</title>
    <link href="http://example.com/2022/11/10/grafana/1-grafana%E5%AE%89%E8%A3%85/"/>
    <id>http://example.com/2022/11/10/grafana/1-grafana%E5%AE%89%E8%A3%85/</id>
    <published>2022-11-10T05:18:15.000Z</published>
    <updated>2022-11-12T07:44:06.222Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg" alt="grafana.jpg"> </p><span id="more"></span><h1 id="grafana介绍"><a href="#grafana介绍" class="headerlink" title="grafana介绍"></a>grafana介绍</h1><p>grafana是一款开源数据绘图工具平台，他支持多种数据源以及有大量的插件可以使用。  </p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>grafana的安装分为两种，一种是使用安装包，另一种是容器化部署。<br>这里在centos中使用安装包进行安装。相关安装方式可以从官网进行查看  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.grafana.com/enterprise/release/grafana-enterprise-9.2.4-1.x86_64.rpm</span><br><span class="line">sudo yum install grafana-enterprise-9.2.4-1.x86_64.rpm</span><br><span class="line">systemctl restart grafana-server.service</span><br><span class="line">systemctl enable grafana-server.service</span><br></pre></td></tr></table></figure><p>默认监听在3000端口，默认密码为admin/admin<br>忘记密码重置密码方式：<code>grafana-cli admin reset-admin-password admin@PASSWORD</code>  </p><h2 id="grafana配置文件"><a href="#grafana配置文件" class="headerlink" title="grafana配置文件"></a>grafana配置文件</h2><p>/etc/grafana/grafana.ini:主配置文件，当修改data、plugins路径时，还应修改/etc/sysconfig/grafana-server中对应的路径<br>/etc/sysconfig/grafana-server:配置文件  </p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># more /etc/sysconfig/grafana-server</span></span><br><span class="line"><span class="attr">GRAFANA_USER</span>=grafana  <span class="comment"># 系统用户，安装时自动创建</span></span><br><span class="line"><span class="attr">GRAFANA_GROUP</span>=grafana  </span><br><span class="line"><span class="attr">GRAFANA_HOME</span>=/usr/share/grafana  <span class="comment"># grafana家目录</span></span><br><span class="line"><span class="attr">LOG_DIR</span>=/var/log/grafana    <span class="comment">#日志文件</span></span><br><span class="line"><span class="attr">DATA_DIR</span>=/var/lib/grafana   <span class="comment">#插件和数据存放目录</span></span><br><span class="line"><span class="attr">MAX_OPEN_FILES</span>=<span class="number">10000</span>    <span class="comment">#最大支持打开文件数</span></span><br><span class="line"><span class="attr">CONF_DIR</span>=/etc/grafana   <span class="comment">#配置文件目录，升级时建议备份</span></span><br><span class="line"><span class="attr">CONF_FILE</span>=/etc/grafana/grafana.ini  <span class="comment">#主配置文件</span></span><br><span class="line"><span class="attr">RESTART_ON_UPGRADE</span>=<span class="literal">true</span>     <span class="comment">#更新重启</span></span><br><span class="line"><span class="attr">PLUGINS_DIR</span>=/var/lib/grafana/plugins    <span class="comment">#插件存放目录</span></span><br><span class="line"><span class="attr">PROVISIONING_CFG_DIR</span>=/etc/grafana/provisioning  <span class="comment">#通过读取配置文件方式来配置datasource和dashboard，而不是正在grafana图形窗口中操作</span></span><br><span class="line"><span class="comment"># Only used on systemd systems</span></span><br><span class="line"><span class="attr">PID_FILE_DIR</span>=/var/run/grafana <span class="comment">#进程存放目录</span></span><br></pre></td></tr></table></figure><p>/etc/init.d/grafana-server：启动脚本<br>/usr/sbin/grafana-cli：安装插件命令行  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/11/10/OfHeuAsG8yhmkY5.jpg&quot; alt=&quot;grafana.jpg&quot;&gt; &lt;/p&gt;</summary>
    
    
    
    <category term="grafana" scheme="http://example.com/categories/grafana/"/>
    
    
    <category term="grafana安装" scheme="http://example.com/tags/grafana%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>6-pushgateway安装以及使用</title>
    <link href="http://example.com/2022/11/10/prometheus/6-pushgateway%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/"/>
    <id>http://example.com/2022/11/10/prometheus/6-pushgateway%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/</id>
    <published>2022-11-09T17:34:18.000Z</published>
    <updated>2022-11-09T18:49:24.745Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="pushgateway"><a href="#pushgateway" class="headerlink" title="pushgateway"></a>pushgateway</h1><p>各个目标主机可上报数据到pushgateway。Push gateway通过push的方式推送给prometheus sercer。本身也是一个http服务器，一般通过写脚本抓自己想要的数据，自定义一个监控数据，然后推送到pushgateway，然后pushgateway再推送到prometheus。  </p><h2 id="pushgateway安装"><a href="#pushgateway安装" class="headerlink" title="pushgateway安装"></a>pushgateway安装</h2><p>从官网下载pushgateway安装包  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> tar zxvf pushgateway-1.4.3.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/pushgateway-1.4.3.linux-amd64/ /usr/<span class="built_in">local</span>/pushgateway</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/pushgateway/pushgateway /usr/<span class="built_in">local</span>/bin/pushgateway</span></span><br><span class="line"><span class="meta">~]#</span><span class="bash"> nohup /usr/<span class="built_in">local</span>/pushgateway/pushgateway &gt; /usr/<span class="built_in">local</span>/pushgateway/pushgateway.log 2&gt;&amp;1 &amp;</span></span><br></pre></td></tr></table></figure><p>启动之后查看9091端口是否被监听，也可以查看<code>http://pushgateway_ip:9091</code>是否正常。  </p><h3 id="prometheus-server配置"><a href="#prometheus-server配置" class="headerlink" title="prometheus server配置"></a>prometheus server配置</h3><p>在prometheus的配置文件中加入以下内容</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;pushgateway&quot;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;192.168.27.7:9091&quot;</span>]</span><br></pre></td></tr></table></figure><p>配置修改完成后需要将Prometheus server重启，重启后在web管理界面-Status-Targets中可以看到pushgateway已经被添加。  </p><h2 id="使用pushgateway推送数据"><a href="#使用pushgateway推送数据" class="headerlink" title="使用pushgateway推送数据"></a>使用pushgateway推送数据</h2><p>手动推送几条数据给pushgateway。  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 简单样本</span></span><br><span class="line">echo &quot;test_metric 987654321&quot; | curl --data-binary @- http://192.168.27.7:9091/metrics/job/pushgateway/instance/192.168.27.111</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 复杂样本</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE 要在样本前指明，并且一定要加<span class="comment">#标记</span></span></span><br><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http://192.168.27.7:9091/metrics/job/pushgateway/instance/192.168.27.111</span><br><span class="line"><span class="meta">#</span><span class="bash">TYPE test_metric counter</span></span><br><span class="line">test_metric&#123;label=&quot;val1&quot;&#125; 42.0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/2022/11/10/prometheus/6-pushgateway%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/pushgateway.png"><br><img src="/2022/11/10/prometheus/6-pushgateway%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E4%BD%BF%E7%94%A8/prometheus.png"><br>可以发现pushgateway与prometheus中都可以查看到该数据<br><code>curl --data-binary</code>是将POST请求中的数据发送到pushgateway。<br><code>http://PUSHGATEWAY_IP:9091/metrics/job/EXPORTED_JOB/instance/EXPORTED_INSTANCE</code>推送地址为该格式，其中<code>instance/EXPORTED_INSTANCE</code>可以省略<br>可以使用脚本进行推送  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">metric_name=</span><br><span class="line">metric_value=</span><br><span class="line">type=</span><br><span class="line">job_name=&quot;memory&quot;</span><br><span class="line">instance_name=&quot;192.168.40.181&quot;</span><br><span class="line">PUSHGATEWAY_IP=&quot;xxx.xxx.xxx.xxx&quot;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF | curl --data-binary @- http://$PUSHGATEWAY_IP:9091/metrics/job/$job_name/instance/$instance_name</span><br><span class="line"><span class="meta">#</span><span class="bash"> TYPE <span class="variable">$metric_name</span> <span class="variable">$type</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">metric_name <span class="variable">$metric_value</span></span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>定时推送可以使用crontab进行定时推送<br>例如设置成每15秒推送一次  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /bin/bash xxx.sh</span><br><span class="line">* * * * * (sleep 15;/bin/bash xxx.sh)</span><br><span class="line">* * * * * (sleep 30;/bin/bash xxx.sh)</span><br><span class="line">* * * * * (sleep 45;/bin/bash xxx.sh)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Pushgateway" scheme="http://example.com/tags/Pushgateway/"/>
    
  </entry>
  
  <entry>
    <title>Linux脚本开机自启动</title>
    <link href="http://example.com/2022/11/06/Linux/Linux%E8%84%9A%E6%9C%AC%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/"/>
    <id>http://example.com/2022/11/06/Linux/Linux%E8%84%9A%E6%9C%AC%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/</id>
    <published>2022-11-06T14:51:50.000Z</published>
    <updated>2022-11-27T03:34:16.971Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg" alt="linux.jpg">  </p><span id="more"></span><h1 id="Linux脚本开机启动"><a href="#Linux脚本开机启动" class="headerlink" title="Linux脚本开机启动"></a>Linux脚本开机启动</h1><p>Linux系统文件执行顺序</p><h2 id="方式一-etc-profile-d"><a href="#方式一-etc-profile-d" class="headerlink" title="方式一 /etc/profile.d"></a>方式一 /etc/profile.d</h2><p>将需要自启动的脚本放在 <strong>/etc/profile.d/</strong> 目录下，将脚本添加执行权限。<br><strong>需要注意的是，该方式的脚本必须为 .sh结尾，且每次远程连接服务器时都会启动一次该脚本</strong>。  </p><h2 id="方式二-etc-rc-local"><a href="#方式二-etc-rc-local" class="headerlink" title="方式二 /etc/rc.local"></a>方式二 /etc/rc.local</h2><p>在/etc/rc.local文件中加入需要执行的脚本启动命令，且将 <strong>/etc/rc.d/rc.local</strong> 添加执行权限。使用该方式只会在开机时执行脚本  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">~]#</span><span class="bash"> more /etc/rc.local</span> </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run scripts during boot instead of using this file.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this script will NOT be run after all other service</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Please note that you must run &#x27;chmod +x /etc/rc.d/rc.local&#x27; to ensure</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> that this script will be executed during boot.</span></span><br><span class="line"></span><br><span class="line">touch /var/lock/subsys/local</span><br><span class="line">sh /usr/local/prometheus/start.sh  #添加的执行脚本</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg&quot; alt=&quot;linux.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>5-PromQL</title>
    <link href="http://example.com/2022/10/31/prometheus/5-PromQL/"/>
    <id>http://example.com/2022/10/31/prometheus/5-PromQL/</id>
    <published>2022-10-31T13:14:13.000Z</published>
    <updated>2022-11-09T16:57:47.167Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="PromQL"><a href="#PromQL" class="headerlink" title="PromQL"></a>PromQL</h1><p>从之前中<a href="/2022/10/22/prometheus/3-Prometheus%E6%95%B0%E6%8D%AE/" title="3-Prometheus数据">3-Prometheus数据</a>学习了Prometheus的四种数据类型。<br>PromQL中使用 <strong>#</strong> 进行注释  </p><h2 id="基础内容"><a href="#基础内容" class="headerlink" title="基础内容"></a>基础内容</h2><p><strong>瞬时向量（Instant vector）</strong>： 一组时间序列，每个时间序列包含一个样本，都共享相同的时间戳<br><strong>范围向量（Range vector）</strong>： 一组时间序列，其中包含每个时间序列随时间变化的数据点范围，即 node_cpu_seconds_total[5m]此类查询 ，在 Prometheus页面查询无法使用此类查询展现图表，必须是<strong>即时向量</strong>或者<strong>标量</strong>。<br><strong>标量（Scalar ）</strong>： 一个简单的数字浮点值  </p><h3 id="标签选择器"><a href="#标签选择器" class="headerlink" title="标签选择器"></a>标签选择器</h3><p><code>node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;</code>，其中<code>mode</code>为node_cpu_seconds_total指标的一个标签，可以通过标签选择器进行过滤。<br><strong>=</strong> ：与字符串匹配<br><strong>!=</strong> ：与字符串不匹配<br><strong>=~</strong> ：与正则匹配，匹配为全锚定。<code>=~&quot;foo&quot;</code>相当于<code>=~&quot;^foo$&quot;</code>.<br><strong>!~</strong> ：与正则不匹配  </p><h3 id="时间范围选择器"><a href="#时间范围选择器" class="headerlink" title="时间范围选择器"></a>时间范围选择器</h3><p>时间范围有以下单位：<br><strong>ms</strong>- 毫秒<br><strong>s</strong>- 秒<br><strong>m</strong>- 分钟<br><strong>h</strong>- 小时<br><strong>d</strong>- 天<br><strong>w</strong>- 周<br><strong>y</strong>- 年<br>使用方式<code>node_cpu_seconds_total[5m]</code></p><h3 id="偏移修饰符"><a href="#偏移修饰符" class="headerlink" title="偏移修饰符"></a>偏移修饰符</h3><p>更改查询<strong>即时向量</strong>或<strong>范围向量</strong>的时间偏移量<br><code>node_cpu_seconds_total offset 5m</code> ：表示5分钟前的值<br><code>node_cpu_guest_seconds_total[5m] offset 1d</code>表示一天前5分钟的值  </p><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="@修饰符"></a>@修饰符</h3><p>通过@ 直接跳转到某个uinx时间戳，<br><code>node_cpu_guest_seconds_total @ 1667137698</code>:查询指标时间戳为1667137698，即时间为2022-10-30 21:48:18的值<br><code>node_cpu_guest_seconds_total[5m] @ 1667137698</code>:查询2022-10-30 21:48:18前5分钟的值  </p><h2 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h2><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p><strong>+</strong> （加法）<br><strong>-</strong> （减法）<br><strong>*</strong> （乘法）<br><strong>/</strong> （除法）<br><strong>%</strong> （取模）<br><strong>^</strong> （幂）<br>使用运算符的结果与原指标的意义不再一样，输出的结果没有指标名称，只包含标签、值。<br>实际运算中不同的指标的标签名以及标签数量不一致，运算时有以下运算原则。  </p><ol><li>运算时按照标签相同的值进行运算，例如： node_cpu_seconds_total + node_cpu_seconds_total ，标签全部相同的值相加  </li><li>两个瞬时向量的数量不同，结果数量与数量少的一致，node_cpu_guest_seconds_total + node_cpu_seconds_total，结果为 mode=”nice”、mode=”user”的两个向量相加  </li></ol><h3 id="逻辑比较"><a href="#逻辑比较" class="headerlink" title="逻辑比较"></a>逻辑比较</h3><p>== ：相等判断，相等为1(true)，不相等为0(false)<br>!= ：判断是否不相等，输出结果类似==<br>&gt;= ：输出结果类似==<br>&lt;= ：输出结果类似==<br>&gt; ：输出结果类似==<br>&lt; ：输出结果类似==  </p><h3 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h3><p><strong>and</strong> ：对多个指标的数据集进行标签判断，获取两个指标集具有共同的标签的值 <strong>（优先展示or左边的指标）</strong><br><strong>or</strong> ：对多个指标集数据进行展示，如果有标签重复，则仅显示其中一个标签的值 <strong>（优先展示or左边的指标）</strong><br><strong>unless</strong> :对多个指标的数据集进行标签判断，获取两个指标集不具有共同的标签的值 <strong>（优先展示or左边的指标）</strong>  </p><h3 id="向量匹配"><a href="#向量匹配" class="headerlink" title="向量匹配"></a>向量匹配</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">test1&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  24</span><br><span class="line">test1&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  30</span><br><span class="line">test1&#123;method=&quot;put&quot;, code=&quot;501&quot;&#125;  3</span><br><span class="line">test1&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 6</span><br><span class="line">test1&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 21</span><br><span class="line"></span><br><span class="line">test2&#123;method=&quot;get&quot;&#125;  600</span><br><span class="line">test2&#123;method=&quot;del&quot;&#125;  34</span><br><span class="line">test2&#123;method=&quot;post&quot;&#125; 120</span><br></pre></td></tr></table></figure><p>两个指标test1与test2的标签以及数量不一致们可以使用ignoring忽略不共有的标签。   </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test1&#123; code=&quot;500&quot;&#125; / ignoring(code) test2   # </span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123; code=<span class="string">&quot;500&quot;</span>&#125; 可以过滤出以下两条</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123;method=<span class="string">&quot;get&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125;  24</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> test1&#123;method=<span class="string">&quot;post&quot;</span>, code=<span class="string">&quot;500&quot;</span>&#125; 6</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后 ignoring(code) 将过滤出的两条的code标签忽略，进行运算</span></span><br><span class="line">&#123;method=&quot;get&quot;&#125;  0.04            #  24 / 600</span><br><span class="line">&#123;method=&quot;post&quot;&#125; 0.05            #   6 / 120</span><br></pre></td></tr></table></figure><p>在以上的例子中<code>test1&#123; code=&quot;500&quot;&#125; / ignoring(code) test2</code>等同于<code>test1&#123; code=&quot;500&quot;&#125; / on(method) test2</code>,on 与 ignoring相反，意思为只考虑提供的列表中的标签。ignoring与on 结果的数目都与左边的指标数量相同，可以使用group_right以右边数量为准  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">test1/ ignoring(code) group_left test2</span><br><span class="line"></span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><p>聚合函数可以与 <strong>without</strong>、<strong>by</strong> 一起使用<br>without：表示计算结果中移除列举的标签<br>by：表示计算结果中只保留列出的标签<br>通过without和by可以按照样本的问题对数据进⾏聚合  </p><h3 id="sum"><a href="#sum" class="headerlink" title="sum()"></a>sum()</h3><p>求和函数，可以使用without、by根据标签进行聚合  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sum by(handler) (prometheus_http_requests_total)</span><br><span class="line"></span><br><span class="line">&#123;handler=&quot;/-/ready&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/label/:name/values&quot;&#125;4</span><br><span class="line">&#123;handler=&quot;/api/v1/labels&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/metadata&quot;&#125;27</span><br><span class="line">&#123;handler=&quot;/api/v1/query&quot;&#125;123</span><br><span class="line">&#123;handler=&quot;/api/v1/query_range&quot;&#125;8</span><br><span class="line">&#123;handler=&quot;/api/v1/rules&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/api/v1/series&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/api/v1/status/config&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/api/v1/targets&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;/favicon.ico&quot;&#125;2</span><br><span class="line">&#123;handler=&quot;/graph&quot;&#125;3</span><br><span class="line">&#123;handler=&quot;/metrics&quot;&#125;403</span><br><span class="line">&#123;handler=&quot;/static/*filepath&quot;&#125;11</span><br><span class="line">&#123;handler=&quot;/&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="avg"><a href="#avg" class="headerlink" title="avg()"></a>avg()</h3><p>所有值的平均值  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">avg(prometheus_http_requests_total)</span><br><span class="line">&#123;&#125;  43.06249999999999</span><br></pre></td></tr></table></figure><h3 id="count"><a href="#count" class="headerlink" title="count()"></a>count()</h3><p>返回分组中的时间序列数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">count(prometheus_http_requests_total)</span><br><span class="line">&#123;&#125;  16</span><br><span class="line"></span><br><span class="line">count by (code) (prometheus_http_requests_total)</span><br><span class="line">&#123;code=&quot;200&quot;&#125;14</span><br><span class="line">&#123;code=&quot;302&quot;&#125;1</span><br><span class="line">&#123;code=&quot;400&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="count-values"><a href="#count-values" class="headerlink" title="count_values()"></a>count_values()</h3><p>计算具有相同值的元素个数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">count_values (&quot;handler&quot;,prometheus_http_requests_total)</span><br><span class="line">&#123;handler=&quot;3&quot;&#125;2   #这表示值为3的有2条</span><br><span class="line">&#123;handler=&quot;4&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;8&quot;&#125;2</span><br><span class="line">&#123;handler=&quot;47&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;153&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;1&quot;&#125;4</span><br><span class="line">&#123;handler=&quot;5&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;2&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;553&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;11&quot;&#125;1</span><br><span class="line">&#123;handler=&quot;14&quot;&#125;1</span><br></pre></td></tr></table></figure><h3 id="min-、max"><a href="#min-、max" class="headerlink" title="min()、max()"></a>min()、max()</h3><p>组内最小值、最大值  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">max by (instance,job)(prometheus_http_requests_total)</span><br><span class="line">&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;&#125;   575</span><br><span class="line"></span><br><span class="line">min by (instance,job)(prometheus_http_requests_total)</span><br><span class="line">&#123;instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;&#125;   1</span><br></pre></td></tr></table></figure><h3 id="stddev-、stdvar"><a href="#stddev-、stdvar" class="headerlink" title="stddev()、stdvar()"></a>stddev()、stdvar()</h3><p>stddev():标准差<br>stdvar():方差<br>方差与标准差可以反应数据集离散程度，例如：{2,4,6}与{3,4,5}的平均值都是4，但是两组数据的方差与标准差确不一样。<br>以以上两组数据计算方差：<br>{2,4,6}: ((2-4)^2+(4-4)^2+(6-4)^2)/3=(4+0+4)/3=2.666<br>{3,4,5}: ((3-4)^2+(4-4)^2+(5-4)^2)/3=(1+0+1)/3= 0.666<br>标准差计算方式就是将方差开根号<br>{2,4,6}标准差:1.632<br>{3,4,5}标准差:0.816  </p><h3 id="topk-、bottomk"><a href="#topk-、bottomk" class="headerlink" title="topk()、bottomk()"></a>topk()、bottomk()</h3><p>topk():最大的K个元素<br>bottomk():最小的K个元素  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">topk (2,node_cpu_seconds_total)</span><br><span class="line">node_cpu_seconds_total&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;idle&quot;&#125;  331997.49</span><br><span class="line">node_cpu_seconds_total&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;user&quot;&#125;  3076.4</span><br><span class="line"></span><br><span class="line">bottomk (2,node_cpu_seconds_total)</span><br><span class="line">node_cpu_seconds_total&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;irq&quot;&#125;   0</span><br><span class="line">node_cpu_seconds_total&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;steal&quot;&#125; 0</span><br></pre></td></tr></table></figure><h3 id="quantile"><a href="#quantile" class="headerlink" title="quantile()"></a>quantile()</h3><p>计算指定分位数  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quantile (0.5,node_cpu_seconds_total)  #计算中位数，即二分位数</span><br><span class="line">&#123;&#125;  34.685</span><br></pre></td></tr></table></figure><h2 id="类型函数"><a href="#类型函数" class="headerlink" title="类型函数"></a>类型函数</h2><h3 id="vector"><a href="#vector" class="headerlink" title="vector()"></a>vector()</h3><p>vector( scalar )函数,参数为一个scalar数值，作为一个没有标签的向量返回  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vector(100)</span><br><span class="line">&#123;&#125; 100</span><br></pre></td></tr></table></figure><h3 id="scalar"><a href="#scalar" class="headerlink" title="scalar()"></a>scalar()</h3><p>scalar(instant-vector)，参数为一个<strong>单元素</strong>瞬时向量，返回其唯一的时间序列值作为一个标量<br>如果元素不为1（大于1或者为0），则返回NaN  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scalar(vector(100))</span><br><span class="line">scalar100</span><br></pre></td></tr></table></figure><h2 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h2><h3 id="abs"><a href="#abs" class="headerlink" title="abs()"></a>abs()</h3><p>abs(instant-vector),返回输入向量的所有值的绝对值  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">abs(vector(-100))</span><br><span class="line">&#123;&#125; 100</span><br></pre></td></tr></table></figure><h3 id="In"><a href="#In" class="headerlink" title="In()"></a>In()</h3><p>In(instant-vector),返回输入向量的所有值的自然对数（即以自然常数e为底数的对数）  </p><h3 id="log2"><a href="#log2" class="headerlink" title="log2()"></a>log2()</h3><p>log2(instant-vector),返回输入向量的所有值的以2为底数的对数  </p><h3 id="log10"><a href="#log10" class="headerlink" title="log10()"></a>log10()</h3><p>log10(instant-vector),返回输入向量的所有值的以10为底数的对数  </p><h3 id="exp"><a href="#exp" class="headerlink" title="exp()"></a>exp()</h3><p>exp(instant-vector),返回输入向量的所有值的e的指数值  </p><h3 id="sqrt"><a href="#sqrt" class="headerlink" title="sqrt()"></a>sqrt()</h3><p>sqrt(instant-vector),返回输入向量的所有的值的平方根  </p><h3 id="ceil"><a href="#ceil" class="headerlink" title="ceil()"></a>ceil()</h3><p>ceil(instant-vector)，将输入向量所有值向上取整</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceil(vector(2.232323))</span><br><span class="line">&#123;&#125;  2</span><br></pre></td></tr></table></figure><h3 id="floor"><a href="#floor" class="headerlink" title="floor()"></a>floor()</h3><p>与ceil()函数相反，floor()函数为向下取整  </p><h3 id="round"><a href="#round" class="headerlink" title="round()"></a>round()</h3><p>round(instant-vector),将输入向量所有值四舍五入至整数  </p><h3 id="clamp"><a href="#clamp" class="headerlink" title="clamp()"></a>clamp()</h3><p>clamp(instant-vector,min,max),将输入向量所有值限制在min-max之间，小于min的修改为min，大于max的修改为max  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">clamp(node_cpu_seconds_total,1,100)</span><br><span class="line"></span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;idle&quot;&#125;    100</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;iowait&quot;&#125;  24.13</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;irq&quot;&#125;     1</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;nice&quot;&#125;    4</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;softirq&quot;&#125; 45.67</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;steal&quot;&#125;   1</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;system&quot;&#125;  100</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;user&quot;&#125;    100</span><br></pre></td></tr></table></figure><h3 id="clamp-mix-、clamp-max"><a href="#clamp-mix-、clamp-max" class="headerlink" title="clamp_mix()、clamp_max()"></a>clamp_mix()、clamp_max()</h3><p>clamp_min(instant-vector,min)、clamp_max(instant-vector,max),限制输入向量的最小值、最大值  </p><h2 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a>时间函数</h2><h3 id="time"><a href="#time" class="headerlink" title="time()"></a>time()</h3><p>time()函数，返回当前时间的时间戳  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time()</span><br><span class="line">scalar1668010014.605</span><br></pre></td></tr></table></figure><h3 id="minute"><a href="#minute" class="headerlink" title="minute()"></a>minute()</h3><p>mintue(instant-vector),参数为一个瞬时向量的时间戳，返回给定时间戳的分钟(0-59)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">minute(vector(time()))</span><br><span class="line">&#123;&#125;  10</span><br></pre></td></tr></table></figure><h3 id="hour"><a href="#hour" class="headerlink" title="hour()"></a>hour()</h3><p>hour(instant-vector),参数为一个瞬时向量的时间戳，返回给定时间戳的小时(0-23)  </p><h3 id="month"><a href="#month" class="headerlink" title="month()"></a>month()</h3><p>month(instant-vector),参数为一个瞬时向量的时间戳，返回给定时间戳的月份(1-12)  </p><h3 id="year"><a href="#year" class="headerlink" title="year()"></a>year()</h3><p>year(instant-vector),参数为一个瞬时向量的时间戳，返回给定时间戳的年份  </p><h3 id="day-of-month"><a href="#day-of-month" class="headerlink" title="day_of_month()"></a>day_of_month()</h3><p>day_of_month(instant-vector)，参数为一个瞬时向量的时间戳，返回给定时间戳所在月份的第几天  </p><h3 id="day-of-week"><a href="#day-of-week" class="headerlink" title="day_of_week()"></a>day_of_week()</h3><p>day_of_week(instant-vector)，参数为一个瞬时向量的时间戳，返回给定时间戳所在星期的第几天  </p><h3 id="day-of-year"><a href="#day-of-year" class="headerlink" title="day_of_year()"></a>day_of_year()</h3><p>day_of_year(instant-vector)，参数为一个瞬时向量的时间戳，返回给定时间戳所在年份的第几天  </p><h3 id="days-in-month"><a href="#days-in-month" class="headerlink" title="days_in_month()"></a>days_in_month()</h3><p>days_in_month(instant-vector)，参数为一个瞬时向量的时间戳，返回给定时间戳所在月份一共有几天  </p><h3 id="timestamp"><a href="#timestamp" class="headerlink" title="timestamp()"></a>timestamp()</h3><p>查看样本的时间戳  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">timestamp(node_cpu_seconds_total)</span><br><span class="line"></span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;idle&quot;&#125;    1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;iowait&quot;&#125;  1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;irq&quot;&#125;     1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;nice&quot;&#125;    1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;softirq&quot;&#125; 1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;steal&quot;&#125;   1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;system&quot;&#125;  1668010938.442</span><br><span class="line">&#123;cpu=&quot;0&quot;, instance=&quot;192.168.27.7:9100&quot;, job=&quot;node&quot;, mode=&quot;user&quot;&#125;    1668010938.442</span><br></pre></td></tr></table></figure><h2 id="缺失与排序函数"><a href="#缺失与排序函数" class="headerlink" title="缺失与排序函数"></a>缺失与排序函数</h2><h3 id="absent"><a href="#absent" class="headerlink" title="absent()"></a>absent()</h3><p>absent(instant-vector),当给定向量为空时返回1，有样本数据则返回空</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">absent(up)</span><br><span class="line">Empty query result</span><br><span class="line"></span><br><span class="line">absent(up_not_existent)</span><br><span class="line">&#123;&#125;  1</span><br></pre></td></tr></table></figure><h3 id="sort"><a href="#sort" class="headerlink" title="sort()"></a>sort()</h3><p>sort(instant-vector),按照值进行排序，从上到下依次变大。  </p><h3 id="sort-desc"><a href="#sort-desc" class="headerlink" title="sort_desc()"></a>sort_desc()</h3><p>sort_desc(instant-vector),按照值进行排序，从上到下依次变小。  </p><h2 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h2><h3 id="rate"><a href="#rate" class="headerlink" title="rate()"></a>rate()</h3><p>rate(range-vector),计算<strong>计数器</strong>区间向量平均增长速率。rate会取指定时间范围内所有数据点，算出一组速率，然后取平均值作为结果。rate适合缓慢变化的计数器（counter）。  </p><h3 id="irate"><a href="#irate" class="headerlink" title="irate()"></a>irate()</h3><p>rate(range-vector),计算<strong>计数器</strong>区间向量平均增长速率。irate取的是在指定时间范围内的最近两个数据点来算速率。irate适合快速变化的计数器（counter）。  </p><h2 id="gauge类型处理函数"><a href="#gauge类型处理函数" class="headerlink" title="gauge类型处理函数"></a>gauge类型处理函数</h2><h3 id="changes"><a href="#changes" class="headerlink" title="changes()"></a>changes()</h3><p>changes(range-vector),返回区间内每个样本数据值的变化次数  </p><h3 id="delta"><a href="#delta" class="headerlink" title="delta()"></a>delta()</h3><p>delta(range-vector),返回区间中每个元素第一个值与最后一个值的差  </p><h3 id="idelta"><a href="#idelta" class="headerlink" title="idelta()"></a>idelta()</h3><p>idelta(range-vector),返回区间中最新的两个值的差  </p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="PromQL" scheme="http://example.com/tags/PromQL/"/>
    
  </entry>
  
  <entry>
    <title>4-Prometheus配置文件</title>
    <link href="http://example.com/2022/10/29/prometheus/4-Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <id>http://example.com/2022/10/29/prometheus/4-Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</id>
    <published>2022-10-29T03:38:40.000Z</published>
    <updated>2022-10-29T08:01:09.804Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg" alt="prometheus">  </p><span id="more"></span><h1 id="Prometheus配置文件"><a href="#Prometheus配置文件" class="headerlink" title="Prometheus配置文件"></a>Prometheus配置文件</h1><p>在前面章节Prometheus安装在/usr/local/prometheus中，Prometheus的配置文件为prometheus.yml。<br>Prometheus启动是可以使用参数 -config.file 指定配置文件。  </p><h2 id="配置文件主体"><a href="#配置文件主体" class="headerlink" title="配置文件主体"></a>配置文件主体</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此片段指定的是prometheus的全局配置， 比如采集间隔，抓取超时时间等.</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># 抓取时间间隔，</span></span><br><span class="line">  [ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 抓取超时时间</span></span><br><span class="line">  [ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">10s</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 执行判断 rules 的时间间隔</span></span><br><span class="line">  [ <span class="attr">evaluation_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">1m</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 外部一些标签设置</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    [ <span class="string">&lt;labelname&gt;:</span> <span class="string">&lt;labelvalue&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 记录 PromQL 查询的文件。</span></span><br><span class="line">  <span class="comment"># 重新加载配置将重新打开文件。</span></span><br><span class="line">  [ <span class="attr">query_log_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定报警规则文件， prometheus根据这些规则信息，会推送报警信息到alertmanager中。</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;filepath_glob&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定抓取配置，prometheus的数据采集通过此片段配置。</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;scrape_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 此片段指定报警配置， 这里主要是指定prometheus将报警规则推送到指定的alertmanager实例地址。</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;relabel_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    [ <span class="bullet">-</span> <span class="string">&lt;alertmanager_config&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定后端的存储的写入api地址。</span></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_write&gt;</span> <span class="string">...</span> ]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 指定后端的存储的读取api地址。</span></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;remote_read&gt;</span> <span class="string">...</span> ]</span><br></pre></td></tr></table></figure><h2 id="scrape-configs-配置"><a href="#scrape-configs-配置" class="headerlink" title="scrape_configs 配置"></a>scrape_configs 配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># 抓取指标的作业名称</span></span><br><span class="line">  <span class="attr">job_name:</span> <span class="string">&lt;job_name&gt;</span></span><br><span class="line">  <span class="comment"># 抓取间隔,默认继承global值。</span></span><br><span class="line">[ <span class="attr">scrape_interval:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_interval&gt;</span> ]</span><br><span class="line">  <span class="comment"># 抓取超时时间,默认继承global值。</span></span><br><span class="line">[ <span class="attr">scrape_timeout:</span> <span class="string">&lt;duration&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">&lt;global_config.scrape_timeout&gt;</span> ]</span><br><span class="line">  <span class="comment"># 抓取路径， 默认是/metrics</span></span><br><span class="line">[ <span class="attr">metrics_path:</span> <span class="string">&lt;path&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">/metrics</span> ]</span><br><span class="line">  <span class="comment"># 指定采集使用的协议，http或者https。</span></span><br><span class="line">[ <span class="attr">scheme:</span> <span class="string">&lt;scheme&gt;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">=</span> <span class="string">http</span> ]</span><br><span class="line">  <span class="comment"># 指定url参数。</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    [ <span class="string">&lt;string&gt;:</span> [<span class="string">&lt;string&gt;</span>, <span class="string">...</span>] ]</span><br><span class="line">  <span class="comment"># 指定认证信息。</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">  [ <span class="attr">username:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line">  [ <span class="attr">password:</span> <span class="string">&lt;secret&gt;</span> ]</span><br><span class="line">  [ <span class="attr">password_file:</span> <span class="string">&lt;string&gt;</span> ]</span><br><span class="line">  <span class="comment"># 指定token的数值， 用户get metrics认证使用</span></span><br><span class="line">[ <span class="attr">bearer_token:</span> <span class="string">&lt;secret&gt;</span> ]</span><br><span class="line">  <span class="comment"># 指定获取token的文件， 用户get metrics认证使用</span></span><br><span class="line">[ <span class="attr">bearer_token_file:</span> <span class="string">/path/to/bearer/token/file</span> ]</span><br><span class="line">  <span class="comment"># 指定获取metrics时需要的tls证书</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">  [ <span class="string">&lt;tls_config&gt;</span> ]</span><br><span class="line"><span class="comment"># 指定静态配置</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">  [   <span class="bullet">-</span> <span class="string">&#x27;&lt;host&gt;&#x27;</span> ]<span class="string">...</span> ]</span><br><span class="line"><span class="comment"># Consul服务发现配置列表，_sd_即为service discovery 服务发现</span></span><br><span class="line">  <span class="attr">consul_sd_configs:</span></span><br><span class="line">  [ <span class="bullet">-</span> <span class="string">&lt;consul_sd_config&gt;</span> <span class="string">...</span> ]</span><br></pre></td></tr></table></figure><p><a href="https://github.com/prometheus/prometheus/blob/release-2.39/config/testdata/conf.good.yml">Prometheus官网示例配置文件</a>  </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">codelab</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;first.rules&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;my/*.rules&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">remote_write:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote1/push</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">drop_expensive</span></span><br><span class="line">    <span class="attr">write_relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__name__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">expensive.*</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client_id:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">      <span class="attr">client_secret:</span> <span class="string">&quot;456&quot;</span></span><br><span class="line">      <span class="attr">token_url:</span> <span class="string">&quot;http://remote1/auth&quot;</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">        <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote2/push</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rw_tls</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">    <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">remote_read:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote1/read</span></span><br><span class="line">    <span class="attr">read_recent:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">enable_http2:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">http://remote3/read</span></span><br><span class="line">    <span class="attr">read_recent:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">read_special</span></span><br><span class="line">    <span class="attr">required_matchers:</span></span><br><span class="line">      <span class="attr">job:</span> <span class="string">special</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># scrape_interval is defined by the configured global (15s).</span></span><br><span class="line">    <span class="comment"># scrape_timeout is defined by the global default (10s).</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo/*.slow.json</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo/*.slow.yml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">single/file.yml</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">10m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">bar/*.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>, <span class="string">&quot;localhost:9191&quot;</span>]</span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">my:</span> <span class="string">label</span></span><br><span class="line">          <span class="attr">your:</span> <span class="string">label</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">job</span>, <span class="string">__meta_dns_name</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.*)some-[regex]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">job</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">foo-$&#123;1&#125;</span></span><br><span class="line">        <span class="comment"># action defaults to &#x27;replace&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">abc</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">cde</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">replacement:</span> <span class="string">static</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">abc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">static</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">abc</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials_file:</span> <span class="string">valid_token_file</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">min_version:</span> <span class="string">TLS10</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-x</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">basic_auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">admin_name</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&quot;multiline\nmysecret\ntest&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">50s</span></span><br><span class="line">    <span class="attr">scrape_timeout:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">body_size_limit:</span> <span class="string">10MB</span></span><br><span class="line">    <span class="attr">sample_limit:</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/my_path</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">dns_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">refresh_interval:</span> <span class="string">15s</span></span><br><span class="line">        <span class="attr">names:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first.dns.address.domain.com</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">second.dns.address.domain.com</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">names:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">first.dns.address.domain.com</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">job</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.*)some-[regex]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">modulus:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__tmp_hash</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">hashmod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__tmp_hash</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labeldrop</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelkeep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">k</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">metric_relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__name__</span>]</span><br><span class="line">        <span class="attr">regex:</span> <span class="string">expensive_metric.*</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-y</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&quot;localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">token:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">services:</span> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;cache&quot;</span>, <span class="string">&quot;mysql&quot;</span>]</span><br><span class="line">        <span class="attr">tags:</span> [<span class="string">&quot;canary&quot;</span>, <span class="string">&quot;v1&quot;</span>]</span><br><span class="line">        <span class="attr">node_meta:</span></span><br><span class="line">          <span class="attr">rack:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">        <span class="attr">allow_stale:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_sd_consul_tags</span>]</span><br><span class="line">        <span class="attr">separator:</span> <span class="string">&quot;,&quot;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">label:([^=]+)=([^,]+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;2&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-z</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">      <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">authorization:</span></span><br><span class="line">      <span class="attr">credentials:</span> <span class="string">mysecret</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kubernetes</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">api_server:</span> <span class="string">&quot;https://localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">basic_auth:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">&quot;myusername&quot;</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">&quot;mysecret&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kubernetes-namespaces</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">api_server:</span> <span class="string">&quot;https://localhost:1234&quot;</span></span><br><span class="line">        <span class="attr">namespaces:</span></span><br><span class="line">          <span class="attr">names:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">basic_auth:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">&quot;myusername&quot;</span></span><br><span class="line">      <span class="attr">password_file:</span> <span class="string">valid_password_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-kuma</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">kuma_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">http://kuma-control-plane.kuma-system.svc:5676</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-marathon</span></span><br><span class="line">    <span class="attr">marathon_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;https://marathon.example.com:443&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">auth_token:</span> <span class="string">&quot;mysecret&quot;</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-nomad</span></span><br><span class="line">    <span class="attr">nomad_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&#x27;http://localhost:4646&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-ec2</span></span><br><span class="line">    <span class="attr">ec2_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">access</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">profile</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tag:environment</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tag:service</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-lightsail</span></span><br><span class="line">    <span class="attr">lightsail_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">access</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">profile:</span> <span class="string">profile</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-azure</span></span><br><span class="line">    <span class="attr">azure_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">environment:</span> <span class="string">AzurePublicCloud</span></span><br><span class="line">        <span class="attr">authentication_method:</span> <span class="string">OAuth</span></span><br><span class="line">        <span class="attr">subscription_id:</span> <span class="string">11AAAA11-A11A-111A-A111-1111A1111A11</span></span><br><span class="line">        <span class="attr">resource_group:</span> <span class="string">my-resource-group</span></span><br><span class="line">        <span class="attr">tenant_id:</span> <span class="string">BBBB222B-B2B2-2B22-B222-2BB2222BB2B2</span></span><br><span class="line">        <span class="attr">client_id:</span> <span class="string">333333CC-3C33-3333-CCC3-33C3CCCCC33C</span></span><br><span class="line">        <span class="attr">client_secret:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9100</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-nerve</span></span><br><span class="line">    <span class="attr">nerve_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">servers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/monitoring</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">0123service-xxx</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">badfederation</span></span><br><span class="line">    <span class="attr">honor_timestamps:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/federate</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">測試</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">localhost:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">httpsd</span></span><br><span class="line">    <span class="attr">http_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&quot;http://example.com/prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-triton</span></span><br><span class="line">    <span class="attr">triton_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">account:</span> <span class="string">&quot;testAccount&quot;</span></span><br><span class="line">        <span class="attr">dns_suffix:</span> <span class="string">&quot;triton.example.com&quot;</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">&quot;triton.example.com&quot;</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">9163</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">digitalocean-droplets</span></span><br><span class="line">    <span class="attr">digitalocean_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">docker_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">dockerswarm</span></span><br><span class="line">    <span class="attr">dockerswarm_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">http://127.0.0.1:2375</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">nodes</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-openstack</span></span><br><span class="line">    <span class="attr">openstack_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">region:</span> <span class="string">RegionOne</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-puppetdb</span></span><br><span class="line">    <span class="attr">puppetdb_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">https://puppetserver/</span></span><br><span class="line">        <span class="attr">query:</span> <span class="string">&#x27;resources &#123; type = &quot;Package&quot; and title = &quot;httpd&quot; &#125;&#x27;</span></span><br><span class="line">        <span class="attr">include_parameters:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">valid_ca_file</span></span><br><span class="line">          <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">          <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">hetzner</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">uppercase</span></span><br><span class="line">        <span class="attr">source_labels:</span> [<span class="string">instance</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">    <span class="attr">hetzner_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">hcloud</span></span><br><span class="line">        <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">robot</span></span><br><span class="line">        <span class="attr">basic_auth:</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">abcdef</span></span><br><span class="line">          <span class="attr">password:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">service-eureka</span></span><br><span class="line">    <span class="attr">eureka_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">&quot;http://eureka.example.com:8761/eureka&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">scaleway</span></span><br><span class="line">    <span class="attr">scaleway_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">project_id:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111112</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">baremetal</span></span><br><span class="line">        <span class="attr">project_id:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111112</span></span><br><span class="line">        <span class="attr">access_key:</span> <span class="string">SCWXXXXXXXXXXXXXXXXX</span></span><br><span class="line">        <span class="attr">secret_key:</span> <span class="number">11111111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-1111</span><span class="number">-111111111111</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">linode-instances</span></span><br><span class="line">    <span class="attr">linode_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">uyuni</span></span><br><span class="line">    <span class="attr">uyuni_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">https://localhost:1234</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">gopher</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">hole</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">ionos</span></span><br><span class="line">    <span class="attr">ionos_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">datacenter_id:</span> <span class="string">8feda53f-15f0-447f-badf-ebe32dad2fc0</span></span><br><span class="line">        <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">vultr</span></span><br><span class="line">    <span class="attr">vultr_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">authorization:</span></span><br><span class="line">          <span class="attr">credentials:</span> <span class="string">abcdef</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.4:9093&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.5:9093&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;1.2.3.6:9093&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">tsdb:</span></span><br><span class="line">    <span class="attr">out_of_order_time_window:</span> <span class="string">30m</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tracing:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">&quot;localhost:4317&quot;</span></span><br><span class="line">  <span class="attr">client_type:</span> <span class="string">&quot;grpc&quot;</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">foo:</span> <span class="string">&quot;bar&quot;</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">&quot;gzip&quot;</span></span><br><span class="line">  <span class="attr">tls_config:</span></span><br><span class="line">    <span class="attr">cert_file:</span> <span class="string">valid_cert_file</span></span><br><span class="line">    <span class="attr">key_file:</span> <span class="string">valid_key_file</span></span><br><span class="line">    <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://s2.loli.net/2022/10/21/Dv2fVhPgOBrK7bF.jpg&quot; alt=&quot;prometheus&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Prometheus" scheme="http://example.com/categories/Prometheus/"/>
    
    
    <category term="Prometheus配置文件" scheme="http://example.com/tags/Prometheus%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Linux修改句柄数</title>
    <link href="http://example.com/2022/10/23/Linux/Linux%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0/"/>
    <id>http://example.com/2022/10/23/Linux/Linux%E4%BF%AE%E6%94%B9%E5%8F%A5%E6%9F%84%E6%95%B0/</id>
    <published>2022-10-23T09:31:20.000Z</published>
    <updated>2022-10-23T13:56:05.799Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg" alt="linux.jpg">  </p><span id="more"></span><h1 id="Linux句柄"><a href="#Linux句柄" class="headerlink" title="Linux句柄"></a>Linux句柄</h1><p>Linux中的句柄分为用户级、系统级。<br>用户级句柄：规定单个进程能够打开的最大文件句柄数量（默认大小1024）<br>系统级句柄：系统中最大文件句柄数量  </p><h2 id="用户级句柄数量修改"><a href="#用户级句柄数量修改" class="headerlink" title="用户级句柄数量修改"></a>用户级句柄数量修改</h2><h3 id="临时修改"><a href="#临时修改" class="headerlink" title="临时修改"></a>临时修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -a #查看 open files 数值，或者直接使用ulimit -n</span><br><span class="line">ulimit -SHn 10000 </span><br></pre></td></tr></table></figure><p>ulimit分为软限制与硬限制。-H是硬限制，实际限制；-S是软限制，告警限制。 </p><h3 id="永久修改"><a href="#永久修改" class="headerlink" title="永久修改"></a>永久修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> nofile 个进程最多能打开的的文件数</span></span><br><span class="line">echo &quot;* soft nofile 2048&quot;  &gt;&gt; /etc/security/limits.conf   </span><br><span class="line">echo &quot;* hard nofile 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> nproc 一个用户最多能创建的进程数</span></span><br><span class="line">echo &quot;* soft nproc 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nproc 2048&quot;  &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure><p>重新ssh连接查看或者重启查看。  </p><h2 id="系统级句柄数修改"><a href="#系统级句柄数修改" class="headerlink" title="系统级句柄数修改"></a>系统级句柄数修改</h2><h3 id="临时修改-1"><a href="#临时修改-1" class="headerlink" title="临时修改"></a>临时修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo  100000 &gt; /proc/sys/fs/file-max</span><br></pre></td></tr></table></figure><h3 id="永久修改-1"><a href="#永久修改-1" class="headerlink" title="永久修改"></a>永久修改</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo   fs.file-max = 100000  &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p       #从文件中读取数据，默认从/etc/sysctl.conf中读取</span><br><span class="line">sysctl -a|grep fs.file-max      #查看是否修改</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;img src=&quot;https://i.loli.net/2021/08/02/cX51yi4KrLYRfJU.jpg&quot; alt=&quot;linux.jpg&quot;&gt;  &lt;/p&gt;</summary>
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
</feed>
